import{t as e}from"./Stack-DXrV42Z1.js";import{a as t,i as n,n as r,r as i,t as a}from"./TableRow-R_0OUxwO.js";import{Gt as o,J as s,Kt as c,Lt as l,M as u,N as d,Nt as f,R as p,U as m,V as h,Xt as g,_,ct as v,ft as y,it as b,j as x,jt as S,on as C,ot as w,q as T,qt as E,sn as D,tt as O}from"./index-BEhpBRtG.js";import{t as k}from"./useConfirmDialog-BEY6e6mZ.js";import{t as A}from"./useNotification-ZXgG6D19.js";function j(e){return c(`MuiTableContainer`,e)}o(`MuiTableContainer`,[`root`]);var M=D(C()),N=D(g()),P=e=>{let{classes:t}=e;return l({root:[`root`]},j,t)},F=f(`div`,{name:`MuiTableContainer`,slot:`Root`})({width:`100%`,overflowX:`auto`}),I=M.forwardRef(function(e,t){let n=S({props:e,name:`MuiTableContainer`}),{className:r,component:i=`div`,...a}=n,o={...n,component:i};return(0,N.jsx)(F,{ref:t,as:i,className:E(P(o).root,r),ownerState:o,...a})});function L({onGenerate:t,onApply:n,onUpdateFiles:r,actionLoading:i}){return(0,N.jsxs)(s,{children:[(0,N.jsx)(T,{title:`Actions`}),(0,N.jsx)(e,{spacing:2,children:[{label:`Generate New Calibration`,description:`Analyze all files in library to generate optimal calibration values. This will scan the entire library and may take some time.`,onClick:t,color:`primary`,variant:`contained`},{label:`Apply Calibration to Library`,description:`Queue all files for reprocessing with current calibration. This will update all tags based on the current calibration values.`,onClick:n,color:`primary`,variant:`contained`},{label:`Update Calibration Files`,description:`Download and import the latest calibration bundle files from the repository.`,onClick:r,color:`secondary`,variant:`outlined`}].map(e=>(0,N.jsx)(m,{label:e.label,description:e.description,onClick:e.onClick,disabled:i,variant:e.variant,color:e.color},e.label))})]})}function R({status:e}){let o=e.last_run?new Date(e.last_run*1e3).toLocaleString():`Never`;return(0,N.jsxs)(s,{children:[(0,N.jsx)(T,{title:`Calibration Status`}),(0,N.jsxs)(O,{sx:{mb:3},children:[(0,N.jsxs)(b,{variant:`body2`,color:`text.secondary`,children:[(0,N.jsx)(`strong`,{children:`Global Version:`}),` `,e.global_version||`Not calibrated`]}),(0,N.jsxs)(b,{variant:`body2`,color:`text.secondary`,children:[(0,N.jsx)(`strong`,{children:`Last Run:`}),` `,o]})]}),e.libraries.length>0?(0,N.jsx)(I,{component:y,variant:`outlined`,children:(0,N.jsxs)(t,{size:`small`,children:[(0,N.jsx)(r,{children:(0,N.jsxs)(a,{children:[(0,N.jsx)(i,{children:`Library`}),(0,N.jsx)(i,{align:`right`,children:`Total Files`}),(0,N.jsx)(i,{align:`right`,children:`Current`}),(0,N.jsx)(i,{align:`right`,children:`Outdated`}),(0,N.jsx)(i,{align:`right`,children:`Calibration %`})]})}),(0,N.jsx)(n,{children:e.libraries.map(e=>(0,N.jsxs)(a,{children:[(0,N.jsx)(i,{children:e.library_name}),(0,N.jsx)(i,{align:`right`,children:e.total_files.toLocaleString()}),(0,N.jsx)(i,{align:`right`,children:e.current_count.toLocaleString()}),(0,N.jsx)(i,{align:`right`,children:e.outdated_count.toLocaleString()}),(0,N.jsxs)(i,{align:`right`,children:[e.percentage.toFixed(1),`%`]})]},e.library_id))})]})}):(0,N.jsx)(b,{variant:`body2`,color:`text.secondary`,children:`No libraries found.`})]})}function z(){let{showSuccess:e,showError:t,showInfo:n}=A(),{confirm:r,isOpen:i,options:a,handleConfirm:o,handleCancel:s}=k(),[c,l]=(0,M.useState)(null),[f,p]=(0,M.useState)(!0),[m,h]=(0,M.useState)(null),[g,v]=(0,M.useState)(!1),y=async()=>{try{p(!0),h(null),l(await d())}catch(e){h(e instanceof Error?e.message:`Failed to load status`),console.error(`[Calibration] Load error:`,e)}finally{p(!1)}};return(0,M.useEffect)(()=>{y()},[]),{status:c,loading:f,error:m,actionLoading:g,handleGenerate:async()=>{if(await r({title:`Generate Calibration?`,message:`This analyzes all library files and may take some time.`,confirmLabel:`Generate`,severity:`warning`}))try{v(!0);let n=await u(!0),i=Object.keys(n.data.calibrations||{}).length,a=n.saved_files?.saved_files||0,o=`Calibration generated! Library: ${n.data.library_size} files, `;if(o+=`Calibrations: ${i}, Skipped: ${n.data.skipped_tags}`,a>0&&(o+=`, Saved ${a} files`),e(o),await y(),n.requires_reconciliation&&n.affected_libraries?.length){let i=n.affected_libraries,a=i.reduce((e,t)=>e+t.outdated_files,0),o=i.map(e=>e.name).join(`, `);if(await r({title:`Reconcile File Tags?`,message:`Calibration changed for ${i.length} ${i.length===1?`library`:`libraries`} (${o}). ${a} files need to be rewritten to reflect the new calibration. Reconcile now?`,confirmLabel:`Reconcile`,cancelLabel:`Later`,severity:`info`})){v(!0);let n=0,r=0;for(let e of i)try{let t=await _(e.library_id);n+=t.processed,r+=t.failed}catch(t){console.error(`[Calibration] Reconcile error for library ${e.name}:`,t),r+=1}r>0?t(`Reconciled ${n} files, ${r} failed`):e(`Reconciled ${n} files across ${i.length} ${i.length===1?`library`:`libraries`}`)}}}catch(e){t(e instanceof Error?e.message:`Failed to generate calibration`)}finally{v(!1)}},handleApply:async()=>{if(await r({title:`Apply Calibration?`,message:`Apply calibration to entire library? This will queue all files for reprocessing.`,confirmLabel:`Apply`,severity:`warning`}))try{v(!0),e(`Queued ${(await x()).queued} files for recalibration`),await y()}catch(e){t(e instanceof Error?e.message:`Failed to apply calibration`)}finally{v(!1)}},handleUpdateFiles:()=>{n(`Not implemented`)},dialogState:{isOpen:i,options:a,handleConfirm:o,handleCancel:s}}}function B(){let{status:t,loading:n,error:r,actionLoading:i,handleGenerate:a,handleApply:o,handleUpdateFiles:s,dialogState:c}=z();return(0,N.jsxs)(h,{title:`Calibration`,children:[n&&(0,N.jsx)(v,{}),r&&(0,N.jsxs)(w,{severity:`error`,children:[`Error: `,r]}),t&&(0,N.jsxs)(e,{spacing:2.5,children:[(0,N.jsx)(R,{status:t}),(0,N.jsx)(L,{onGenerate:a,onApply:o,onUpdateFiles:s,actionLoading:i})]}),(0,N.jsx)(p,{open:c.isOpen,title:c.options.title,message:c.options.message,confirmLabel:c.options.confirmLabel,cancelLabel:c.options.cancelLabel,severity:c.options.severity,onConfirm:c.handleConfirm,onCancel:c.handleCancel})]})}export{B as CalibrationPage};