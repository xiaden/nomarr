import{t as e}from"./Stack-BpF9mxtT.js";import"./useSlotProps-C0fpQN7y.js";import{a as t,i as n,n as r,r as i,t as a}from"./ToggleButton-CmItDLq2.js";import{t as o}from"./Chip-B2nVSPgp.js";import{Bt as s,C as c,Ct as l,E as u,Et as d,Ht as f,S as p,St as m,at as h,dt as g,et as _,i as v,k as y,m as b,n as x,nt as S,o as C,s as w,st as T,t as E,tt as D,xt as O}from"./index-Fcl-xYYK.js";import{t as k}from"./useConfirmDialog-DAxVsBMQ.js";import{t as A}from"./useNotification-B2fuh4Dn.js";var j=f(s());function M(e){return j.Children.toArray(e).filter(e=>j.isValidElement(e))}function N(e){return m(`MuiToggleButtonGroup`,e)}var P=O(`MuiToggleButtonGroup`,[`root`,`selected`,`horizontal`,`vertical`,`disabled`,`grouped`,`groupedHorizontal`,`groupedVertical`,`fullWidth`,`firstButton`,`lastButton`,`middleButton`]),F=f(d()),I=e=>{let{classes:t,orientation:n,fullWidth:r,disabled:i}=e;return g({root:[`root`,n,r&&`fullWidth`],grouped:[`grouped`,`grouped${S(n)}`,i&&`disabled`],firstButton:[`firstButton`],lastButton:[`lastButton`],middleButton:[`middleButton`]},N,t)},L=T(`div`,{name:`MuiToggleButtonGroup`,slot:`Root`,overridesResolver:(e,t)=>{let{ownerState:n}=e;return[{[`& .${P.grouped}`]:t.grouped},{[`& .${P.grouped}`]:t[`grouped${S(n.orientation)}`]},{[`& .${P.firstButton}`]:t.firstButton},{[`& .${P.lastButton}`]:t.lastButton},{[`& .${P.middleButton}`]:t.middleButton},t.root,n.orientation===`vertical`&&t.vertical,n.fullWidth&&t.fullWidth]}})(D(({theme:e})=>({display:`inline-flex`,borderRadius:(e.vars||e).shape.borderRadius,variants:[{props:{orientation:`vertical`},style:{flexDirection:`column`,[`& .${P.grouped}`]:{[`&.${P.selected} + .${P.grouped}.${P.selected}`]:{borderTop:0,marginTop:0}},[`& .${P.firstButton},& .${P.middleButton}`]:{borderBottomLeftRadius:0,borderBottomRightRadius:0},[`& .${P.lastButton},& .${P.middleButton}`]:{marginTop:-1,borderTop:`1px solid transparent`,borderTopLeftRadius:0,borderTopRightRadius:0},[`& .${P.lastButton}.${n.disabled},& .${P.middleButton}.${n.disabled}`]:{borderTop:`1px solid transparent`}}},{props:{fullWidth:!0},style:{width:`100%`}},{props:{orientation:`horizontal`},style:{[`& .${P.grouped}`]:{[`&.${P.selected} + .${P.grouped}.${P.selected}`]:{borderLeft:0,marginLeft:0}},[`& .${P.firstButton},& .${P.middleButton}`]:{borderTopRightRadius:0,borderBottomRightRadius:0},[`& .${P.lastButton},& .${P.middleButton}`]:{marginLeft:-1,borderLeft:`1px solid transparent`,borderTopLeftRadius:0,borderBottomLeftRadius:0},[`& .${P.lastButton}.${n.disabled},& .${P.middleButton}.${n.disabled}`]:{borderLeft:`1px solid transparent`}}}]}))),R=j.forwardRef(function(e,t){let n=h({props:e,name:`MuiToggleButtonGroup`}),{children:a,className:o,color:s=`standard`,disabled:c=!1,exclusive:u=!1,fullWidth:d=!1,onChange:f,orientation:p=`horizontal`,size:m=`medium`,value:g,..._}=n,v={...n,disabled:c,fullWidth:d,orientation:p,size:m},y=I(v),b=j.useCallback((e,t)=>{if(!f)return;let n=g&&g.indexOf(t),r;g&&n>=0?(r=g.slice(),r.splice(n,1)):r=g?g.concat(t):[t],f(e,r)},[f,g]),x=j.useCallback((e,t)=>{f&&f(e,g===t?null:t)},[f,g]),S=j.useMemo(()=>({className:y.grouped,onChange:u?x:b,value:g,size:m,fullWidth:d,color:s,disabled:c}),[y.grouped,u,x,b,g,m,d,s,c]),C=M(a),w=C.length,T=e=>{let t=e===0,n=e===w-1;return t&&n?``:t?y.firstButton:n?y.lastButton:y.middleButton};return(0,F.jsx)(L,{role:`group`,className:l(y.root,o),ref:t,ownerState:v,..._,children:(0,F.jsx)(i.Provider,{value:S,children:C.map((e,t)=>(0,F.jsx)(r.Provider,{value:T(t),children:e},t))})})}),z=_((0,F.jsx)(`path`,{d:`M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z`}),`Delete`),B=_((0,F.jsx)(`path`,{d:`M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z`}),`Refresh`);function V({statusFilter:t,onFilterChange:n,loading:r,actionLoading:i,summary:o,onRefresh:s,onClearCompleted:c,onClearErrors:l,onClearAll:u}){return(0,F.jsx)(b,{children:(0,F.jsxs)(e,{direction:`row`,spacing:2,alignItems:`center`,justifyContent:`space-between`,flexWrap:`wrap`,gap:2,children:[(0,F.jsx)(R,{value:t,exclusive:!0,onChange:(e,t)=>t&&n(t),size:`small`,disabled:r,children:[`all`,`pending`,`running`,`done`,`error`].map(e=>(0,F.jsx)(a,{value:e,children:e.charAt(0).toUpperCase()+e.slice(1)},e))}),(0,F.jsxs)(e,{direction:`row`,spacing:1,children:[(0,F.jsx)(p,{onClick:s,disabled:r||i,variant:`outlined`,size:`small`,startIcon:(0,F.jsx)(B,{}),children:`Refresh`}),(0,F.jsx)(p,{onClick:c,disabled:r||i||o.completed===0,variant:`outlined`,size:`small`,children:`Clear Completed`}),(0,F.jsx)(p,{onClick:l,disabled:r||i||o.errors===0,variant:`outlined`,size:`small`,children:`Clear Errors`}),(0,F.jsx)(p,{onClick:u,disabled:r||i,variant:`outlined`,color:`error`,size:`small`,children:`Clear All`})]})]})})}function H({jobs:n,total:r,currentPage:i,totalPages:a,onRemoveJob:s,onNextPage:l,onPrevPage:d,statusFilter:f}){let m=e=>e?new Date(e*1e3).toLocaleString():`-`,h=(e,t=80)=>{if(e.length<=t)return e;let n=e.substring(0,40),r=e.substring(e.length-37);return n+`...`+r},g=e=>e===`running`?`warning`:e===`done`?`success`:e===`error`?`error`:`default`;return n.length===0&&r===0?(0,F.jsx)(b,{children:(0,F.jsx)(u,{color:`text.secondary`,textAlign:`center`,py:8,children:f===`all`?`Queue is empty`:`No ${f} jobs found`})}):(0,F.jsxs)(F.Fragment,{children:[(0,F.jsx)(e,{spacing:1,children:n.map(n=>(0,F.jsxs)(c,{sx:{bgcolor:`background.paper`,border:1,borderColor:`divider`,borderRadius:1,p:2,display:`flex`,justifyContent:`space-between`,alignItems:`flex-start`},children:[(0,F.jsxs)(c,{sx:{flex:1,minWidth:0},children:[(0,F.jsxs)(e,{direction:`row`,spacing:1,alignItems:`center`,sx:{mb:1},children:[(0,F.jsxs)(u,{variant:`caption`,color:`text.disabled`,sx:{fontFamily:`monospace`},children:[`#`,n.id]}),(0,F.jsx)(o,{label:n.status,size:`small`,color:g(n.status),sx:{height:20,fontSize:`0.7rem`}})]}),(0,F.jsx)(t,{title:n.path,placement:`top`,children:(0,F.jsx)(u,{variant:`body2`,sx:{fontFamily:`monospace`,fontSize:`0.85rem`,mb:.5,wordBreak:`break-all`},children:h(n.path)})}),(0,F.jsxs)(e,{direction:`row`,spacing:2,sx:{mt:1},children:[(0,F.jsxs)(u,{variant:`caption`,color:`text.secondary`,children:[`Created: `,m(n.created_at)]}),n.started_at&&(0,F.jsxs)(u,{variant:`caption`,color:`text.secondary`,children:[`Started: `,m(n.started_at)]})]}),n.error_message&&(0,F.jsx)(u,{variant:`caption`,color:`error`,sx:{display:`block`,mt:1,p:1,bgcolor:`error.dark`,borderRadius:.5},children:n.error_message})]}),(0,F.jsx)(y,{onClick:()=>s(n.id),disabled:n.status===`running`,color:`error`,size:`small`,sx:{ml:2},children:(0,F.jsx)(z,{fontSize:`small`})})]},n.id))}),a>1&&(0,F.jsx)(c,{sx:{mt:3},children:(0,F.jsxs)(e,{direction:`row`,spacing:2,alignItems:`center`,justifyContent:`center`,children:[(0,F.jsx)(p,{variant:`outlined`,onClick:d,disabled:i===1,children:`Previous`}),(0,F.jsxs)(u,{color:`text.secondary`,children:[`Page `,i,` of `,a,` (`,r.toLocaleString(),` total)`]}),(0,F.jsx)(p,{variant:`outlined`,onClick:l,disabled:i===a,children:`Next`})]})})]})}function U({summary:t,connected:n}){return(0,F.jsxs)(b,{children:[(0,F.jsxs)(e,{direction:`row`,spacing:1,alignItems:`center`,sx:{mb:2},children:[(0,F.jsx)(u,{variant:`body2`,color:`text.secondary`,children:`SSE Status:`}),(0,F.jsx)(o,{label:n?`Connected`:`Disconnected`,size:`small`,color:n?`success`:`error`,sx:{height:20,fontSize:`0.7rem`}})]}),(0,F.jsxs)(e,{direction:`row`,spacing:2,flexWrap:`wrap`,children:[(0,F.jsxs)(c,{sx:{display:`flex`,flexDirection:`column`,alignItems:`center`,p:2,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minWidth:100},children:[(0,F.jsx)(u,{variant:`h4`,fontWeight:`bold`,children:t.pending}),(0,F.jsx)(u,{variant:`caption`,color:`text.secondary`,children:`Pending`})]}),(0,F.jsxs)(c,{sx:{display:`flex`,flexDirection:`column`,alignItems:`center`,p:2,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minWidth:100},children:[(0,F.jsx)(u,{variant:`h4`,fontWeight:`bold`,children:t.running}),(0,F.jsx)(u,{variant:`caption`,color:`text.secondary`,children:`Running`})]}),(0,F.jsxs)(c,{sx:{display:`flex`,flexDirection:`column`,alignItems:`center`,p:2,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minWidth:100},children:[(0,F.jsx)(u,{variant:`h4`,fontWeight:`bold`,children:t.completed}),(0,F.jsx)(u,{variant:`caption`,color:`text.secondary`,children:`Completed`})]}),(0,F.jsxs)(c,{sx:{display:`flex`,flexDirection:`column`,alignItems:`center`,p:2,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minWidth:100},children:[(0,F.jsx)(u,{variant:`h4`,fontWeight:`bold`,children:t.errors}),(0,F.jsx)(u,{variant:`caption`,color:`text.secondary`,children:`Errors`})]})]})]})}function W(){let{showSuccess:e,showError:t}=A(),{confirm:n,isOpen:r,options:i,handleConfirm:a,handleCancel:o}=k(),[s,c]=(0,j.useState)([]),[l,u]=(0,j.useState)({pending:0,running:0,completed:0,errors:0}),[d,f]=(0,j.useState)(0),[p,m]=(0,j.useState)(!0),[h,g]=(0,j.useState)(null),[_,v]=(0,j.useState)(!1),[y,b]=(0,j.useState)(`all`),[S]=(0,j.useState)(50),[C,w]=(0,j.useState)(0),T=Math.floor(C/S)+1,D=Math.ceil(d/S),O=async()=>{try{m(!0),g(null);let e={limit:S,offset:C};y!==`all`&&(e.status=y);let t=await x.queue.listJobs(e);c(t.jobs),f(t.total),u(await x.queue.getStatus())}catch(e){g(e instanceof Error?e.message:`Failed to load queue`),console.error(`[Queue] Load error:`,e)}finally{m(!1)}};(0,j.useEffect)(()=>{O()},[y,C]);let{connected:M}=E({onMessage:e=>{try{let t=JSON.parse(e.data);t.topic===`queue:status`&&t.state&&(u({pending:t.state.pending||0,running:t.state.running||0,completed:t.state.completed||0,errors:t.state.errors||0}),console.log(`[Queue] SSE: Updated summary from event`,t.state)),t.topic===`queue:jobs`&&!p&&(console.log(`[Queue] SSE: Job update, reloading job list`),O())}catch(e){console.warn(`[Queue] Failed to parse SSE message:`,e)}}});return{jobs:s,summary:l,total:d,loading:p,error:h,actionLoading:_,connected:M,statusFilter:y,currentPage:T,totalPages:D,loadQueue:O,removeJob:async e=>{if(await n({title:`Remove Job`,message:`Remove job ${e}?`,severity:`warning`}))try{v(!0),await x.queue.removeJobs({job_id:e}),await O()}catch(e){t(e instanceof Error?e.message:`Failed to remove job`)}finally{v(!1)}},clearCompleted:async()=>{if(await n({title:`Clear Completed Jobs`,message:`Clear all completed jobs?`,severity:`warning`}))try{v(!0),e(`Removed ${(await x.queue.clearCompleted()).removed} completed job(s)`),await O()}catch(e){t(e instanceof Error?e.message:`Failed to clear completed`)}finally{v(!1)}},clearErrors:async()=>{if(await n({title:`Clear Error Jobs`,message:`Clear all error jobs?`,severity:`error`}))try{v(!0),e(`Removed ${(await x.queue.clearErrors()).removed} error job(s)`),await O()}catch(e){t(e instanceof Error?e.message:`Failed to clear errors`)}finally{v(!1)}},clearAll:async()=>{if(await n({title:`Clear All Jobs`,message:`Clear ALL jobs (except running)?`,severity:`error`}))try{v(!0),e(`Removed ${(await x.queue.clearAll()).removed} job(s)`),await O()}catch(e){t(e instanceof Error?e.message:`Failed to clear all`)}finally{v(!1)}},handleFilterChange:e=>{b(e),w(0)},nextPage:()=>{T<D&&w(C+S)},prevPage:()=>{T>1&&w(Math.max(0,C-S))},dialogState:{isOpen:r,options:i,handleConfirm:a,handleCancel:o}}}function G(){let{jobs:e,summary:t,total:n,loading:r,error:i,actionLoading:a,connected:o,statusFilter:s,currentPage:c,totalPages:l,loadQueue:d,removeJob:f,clearCompleted:p,clearErrors:m,clearAll:h,handleFilterChange:g,nextPage:_,prevPage:y,dialogState:b}=W();return(0,F.jsxs)(w,{title:`Tagger Status`,children:[(0,F.jsx)(U,{summary:t,connected:o}),(0,F.jsx)(V,{statusFilter:s,onFilterChange:g,loading:r,actionLoading:a,summary:t,onRefresh:d,onClearCompleted:p,onClearErrors:m,onClearAll:h}),r&&(0,F.jsx)(u,{textAlign:`center`,py:5,color:`text.secondary`,children:`Loading tagger status...`}),i&&(0,F.jsx)(C,{children:i}),!r&&!i&&(0,F.jsx)(H,{jobs:e,total:n,currentPage:c,totalPages:l,onRemoveJob:f,onNextPage:_,onPrevPage:y,statusFilter:s}),(0,F.jsx)(v,{open:b.isOpen,title:b.options.title,message:b.options.message,confirmLabel:b.options.confirmLabel,cancelLabel:b.options.cancelLabel,severity:b.options.severity,onConfirm:b.handleConfirm,onCancel:b.handleCancel})]})}export{G as TaggerStatusPage};