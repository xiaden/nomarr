import{t as e}from"./Stack-BWi1gnmJ.js";import{a as t,n,o as r,s as i,t as a}from"./TextField-CWv60jZi.js";import{n as o}from"./useSlotProps-DznXj3Hk.js";import{t as s}from"./Chip-DlP3DeRX.js";import{t as c}from"./MenuItem-Cg0_7SPw.js";import{t as l}from"./ServerFilePicker-I9FaT6EL.js";import{a as u,c as d,i as f,n as p,o as m,s as h,t as g}from"./library-DF5oLBiM.js";import{C as _,D as v,Dt as y,Et as b,I as x,M as S,N as C,Q as w,X as T,Z as E,_t as D,a as O,c as k,et as A,ft as j,g as M,h as N,j as P,k as F,l as I,mt as L,nt as R,o as ee,ot as z,pt as B,r as V,rt as H,w as U}from"./index-CNGRDrsL.js";import{t as te}from"./useConfirmDialog-rL_H9Xyt.js";import{t as ne}from"./useNotification-BeC27Wtr.js";function re(e){return B(`PrivateSwitchBase`,e)}j(`PrivateSwitchBase`,[`root`,`checked`,`disabled`,`input`,`edgeStart`,`edgeEnd`]);var W=y(b()),G=y(D()),ie=e=>{let{classes:t,checked:n,disabled:r,edge:i}=e;return z({root:[`root`,n&&`checked`,r&&`disabled`,i&&`edge${w(i)}`],input:[`input`]},re,t)},ae=R(C,{name:`MuiSwitchBase`})({padding:9,borderRadius:`50%`,variants:[{props:{edge:`start`,size:`small`},style:{marginLeft:-3}},{props:({edge:e,ownerState:t})=>e===`start`&&t.size!==`small`,style:{marginLeft:-12}},{props:{edge:`end`,size:`small`},style:{marginRight:-3}},{props:({edge:e,ownerState:t})=>e===`end`&&t.size!==`small`,style:{marginRight:-12}}]}),K=R(`input`,{name:`MuiSwitchBase`,shouldForwardProp:H})({cursor:`inherit`,position:`absolute`,opacity:0,width:`100%`,height:`100%`,top:0,left:0,margin:0,padding:0,zIndex:1}),q=W.forwardRef(function(e,n){let{autoFocus:r,checked:i,checkedIcon:a,defaultChecked:s,disabled:c,disableFocusRipple:l=!1,edge:u=!1,icon:d,id:f,inputProps:p,inputRef:m,name:h,onBlur:g,onChange:_,onFocus:v,readOnly:y,required:b=!1,tabIndex:S,type:C,value:w,slots:T={},slotProps:E={},...D}=e,[O,k]=o({controlled:i,default:!!s,name:`SwitchBase`,state:`checked`}),A=t(),j=e=>{v&&v(e),A&&A.onFocus&&A.onFocus(e)},M=e=>{g&&g(e),A&&A.onBlur&&A.onBlur(e)},N=e=>{if(e.nativeEvent.defaultPrevented)return;let t=e.target.checked;k(t),_&&_(e,t)},P=c;A&&P===void 0&&(P=A.disabled);let F=C===`checkbox`||C===`radio`,I={...e,checked:O,disabled:P,disableFocusRipple:l,edge:u},L=ie(I),R={slots:T,slotProps:{input:p,...E}},[ee,z]=x(`root`,{ref:n,elementType:ae,className:L.root,shouldForwardComponentProp:!0,externalForwardedProps:{...R,component:`span`,...D},getSlotProps:e=>({...e,onFocus:t=>{e.onFocus?.(t),j(t)},onBlur:t=>{e.onBlur?.(t),M(t)}}),ownerState:I,additionalProps:{centerRipple:!0,focusRipple:!l,disabled:P,role:void 0,tabIndex:null}}),[B,V]=x(`input`,{ref:m,elementType:K,className:L.input,externalForwardedProps:R,getSlotProps:e=>({...e,onChange:t=>{e.onChange?.(t),N(t)}}),ownerState:I,additionalProps:{autoFocus:r,checked:i,defaultChecked:s,disabled:P,id:F?f:void 0,name:h,readOnly:y,required:b,tabIndex:S,type:C,...C===`checkbox`&&w===void 0?{}:{value:w}}});return(0,G.jsxs)(ee,{...z,children:[(0,G.jsx)(B,{...V}),O?a:d]})}),oe=T((0,G.jsx)(`path`,{d:`M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z`}),`CheckBoxOutlineBlank`),se=T((0,G.jsx)(`path`,{d:`M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z`}),`CheckBox`),ce=T((0,G.jsx)(`path`,{d:`M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2z`}),`IndeterminateCheckBox`);function J(e){return B(`MuiCheckbox`,e)}var Y=j(`MuiCheckbox`,[`root`,`checked`,`disabled`,`indeterminate`,`colorPrimary`,`colorSecondary`,`sizeSmall`,`sizeMedium`]),le=e=>{let{classes:t,indeterminate:n,color:r,size:i}=e,a=z({root:[`root`,n&&`indeterminate`,`color${w(r)}`,`size${w(i)}`]},J,t);return{...t,...a}},X=R(q,{shouldForwardProp:e=>H(e)||e===`classes`,name:`MuiCheckbox`,slot:`Root`,overridesResolver:(e,t)=>{let{ownerState:n}=e;return[t.root,n.indeterminate&&t.indeterminate,t[`size${w(n.size)}`],n.color!==`default`&&t[`color${w(n.color)}`]]}})(E(({theme:e})=>({color:(e.vars||e).palette.text.secondary,variants:[{props:{color:`default`,disableRipple:!1},style:{"&:hover":{backgroundColor:e.alpha((e.vars||e).palette.action.active,(e.vars||e).palette.action.hoverOpacity)}}},...Object.entries(e.palette).filter(S()).map(([t])=>({props:{color:t,disableRipple:!1},style:{"&:hover":{backgroundColor:e.alpha((e.vars||e).palette[t].main,(e.vars||e).palette.action.hoverOpacity)}}})),...Object.entries(e.palette).filter(S()).map(([t])=>({props:{color:t},style:{[`&.${Y.checked}, &.${Y.indeterminate}`]:{color:(e.vars||e).palette[t].main},[`&.${Y.disabled}`]:{color:(e.vars||e).palette.action.disabled}}})),{props:{disableRipple:!1},style:{"&:hover":{"@media (hover: none)":{backgroundColor:`transparent`}}}}]}))),Z=(0,G.jsx)(se,{}),ue=(0,G.jsx)(oe,{}),de=(0,G.jsx)(ce,{}),fe=W.forwardRef(function(e,t){let n=A({props:e,name:`MuiCheckbox`}),{checkedIcon:r=Z,color:a=`primary`,icon:o=ue,indeterminate:s=!1,indeterminateIcon:c=de,inputProps:l,size:u=`medium`,disableRipple:d=!1,className:f,slots:p={},slotProps:m={},...h}=n,g=s?c:o,_=s?c:r,v={...n,disableRipple:d,color:a,indeterminate:s,size:u},y=le(v),b=m.input??l,[S,C]=x(`root`,{ref:t,elementType:X,className:L(y.root,f),shouldForwardComponentProp:!0,externalForwardedProps:{slots:p,slotProps:m,...h},ownerState:v,additionalProps:{type:`checkbox`,icon:W.cloneElement(g,{fontSize:g.props.fontSize??u}),checkedIcon:W.cloneElement(_,{fontSize:_.props.fontSize??u}),disableRipple:d,slots:p,slotProps:{input:i(typeof b==`function`?b(v):b,{"data-indeterminate":s})}}});return(0,G.jsx)(S,{...C,classes:y})});function pe(e){return B(`MuiFormControlLabel`,e)}var Q=j(`MuiFormControlLabel`,[`root`,`labelPlacementStart`,`labelPlacementTop`,`labelPlacementBottom`,`disabled`,`label`,`error`,`required`,`asterisk`]),me=e=>{let{classes:t,disabled:n,labelPlacement:r,error:i,required:a}=e;return z({root:[`root`,n&&`disabled`,`labelPlacement${w(r)}`,i&&`error`,a&&`required`],label:[`label`,n&&`disabled`],asterisk:[`asterisk`,i&&`error`]},pe,t)};const he=R(`label`,{name:`MuiFormControlLabel`,slot:`Root`,overridesResolver:(e,t)=>{let{ownerState:n}=e;return[{[`& .${Q.label}`]:t.label},t.root,t[`labelPlacement${w(n.labelPlacement)}`]]}})(E(({theme:e})=>({display:`inline-flex`,alignItems:`center`,cursor:`pointer`,verticalAlign:`middle`,WebkitTapHighlightColor:`transparent`,marginLeft:-11,marginRight:16,[`&.${Q.disabled}`]:{cursor:`default`},[`& .${Q.label}`]:{[`&.${Q.disabled}`]:{color:(e.vars||e).palette.text.disabled}},variants:[{props:{labelPlacement:`start`},style:{flexDirection:`row-reverse`,marginRight:-11}},{props:{labelPlacement:`top`},style:{flexDirection:`column-reverse`}},{props:{labelPlacement:`bottom`},style:{flexDirection:`column`}},{props:({labelPlacement:e})=>e===`start`||e===`top`||e===`bottom`,style:{marginLeft:16}}]})));var ge=R(`span`,{name:`MuiFormControlLabel`,slot:`Asterisk`})(E(({theme:e})=>({[`&.${Q.error}`]:{color:(e.vars||e).palette.error.main}}))),_e=W.forwardRef(function(e,n){let i=A({props:e,name:`MuiFormControlLabel`}),{checked:a,className:o,componentsProps:s={},control:c,disabled:l,disableTypography:u,inputRef:d,label:f,labelPlacement:p=`end`,name:m,onChange:h,required:g,slots:_={},slotProps:y={},value:b,...S}=i,C=t(),w=l??c.props.disabled??C?.disabled,T=g??c.props.required,E={disabled:w,required:T};[`checked`,`name`,`onChange`,`value`,`inputRef`].forEach(e=>{c.props[e]===void 0&&i[e]!==void 0&&(E[e]=i[e])});let D=r({props:i,muiFormControl:C,states:[`error`]}),O={...i,disabled:w,labelPlacement:p,required:T,error:D.error},k=me(O),[j,M]=x(`typography`,{elementType:v,externalForwardedProps:{slots:_,slotProps:{...s,...y}},ownerState:O}),N=f;return N!=null&&N.type!==v&&!u&&(N=(0,G.jsx)(j,{component:`span`,...M,className:L(k.label,M?.className),children:N})),(0,G.jsxs)(he,{className:L(k.root,o),ownerState:O,ref:n,...S,children:[W.cloneElement(c,E),T?(0,G.jsxs)(`div`,{children:[N,(0,G.jsxs)(ge,{ownerState:O,"aria-hidden":!0,className:k.asterisk,children:[` `,`*`]})]}):N]})});async function ve(){return V(`/api/web/config`)}async function ye(e,t){return O(`/api/web/config`,{key:e,value:t})}function $(){let{showSuccess:t}=ne(),{confirm:n,isOpen:r,options:i,handleConfirm:o,handleCancel:c}=te(),[y,b]=(0,W.useState)([]),[x,S]=(0,W.useState)(!0),[C,w]=(0,W.useState)(null),[T,E]=(0,W.useState)(!1),[D,O]=(0,W.useState)(null),[A,j]=(0,W.useState)(null),[P,F]=(0,W.useState)(null),[I,L]=(0,W.useState)(null),[R,z]=(0,W.useState)(``),[B,V]=(0,W.useState)(``),[H,re]=(0,W.useState)(!0),[ie,ae]=(0,W.useState)(!1),[K,q]=(0,W.useState)(!1),[oe,se]=(0,W.useState)(null),[ce,J]=(0,W.useState)(!1),Y=async()=>{try{S(!0),w(null),b(await f())}catch(e){w(e instanceof Error?e.message:`Failed to load libraries`),console.error(`[LibraryManagement] Load error:`,e)}finally{S(!1)}},le=async()=>{try{L((await ve()).library_root||null)}catch(e){console.error(`[LibraryManagement] Failed to load config:`,e)}};(0,W.useEffect)(()=>{Y(),le()},[]);let X=e=>{if(!I)return!1;let t=I.replace(/\/+$/,``);return!e.replace(/\/+$/,``).startsWith(t)},Z=()=>{z(``),V(``),re(!0),ae(!1),q(!1),se(null),J(!1),E(!1),O(null)},ue=()=>{Z(),E(!0)},de=e=>{z(e.name),V(e.rootPath),re(e.isEnabled),ae(e.isDefault),O(e.id),E(!1),se(null),J(!1)},pe=async()=>{if(!B.trim()){w(`Path is required for preview`);return}if(D===null){w(`Create the library first to preview file count`);return}try{w(null),J(!0),se((await u(D,{recursive:!0})).file_count)}catch(e){w(e instanceof Error?e.message:`Failed to preview library`)}finally{J(!1)}},Q=async()=>{if(!B.trim()){w(`Path is required`);return}try{w(null),await g({name:R.trim()||null,rootPath:B,isEnabled:H,isDefault:ie}),await Y(),Z()}catch(e){w(e instanceof Error?e.message:`Failed to create library`)}},me=async()=>{if(D!==null){if(!B.trim()){w(`Path is required`);return}try{w(null),await d(D,{name:R.trim()||void 0,rootPath:B,isEnabled:H,isDefault:ie}),await Y(),Z()}catch(e){w(e instanceof Error?e.message:`Failed to update library`)}}},he=async e=>{try{w(null),await h(e),await Y()}catch(e){w(e instanceof Error?e.message:`Failed to set default library`)}},ge=async e=>{try{if(w(null),j(e),F(`preparing`),!await n({title:`Start Library Scan?`,message:`Found ${(await u(e,{recursive:!0})).file_count.toLocaleString()} audio files. Start scan?`}))return;F(`queueing`);let r=await m(e,{recursive:!0,force:!1,cleanMissing:!0});t(`Scan ${r.status}: ${r.message||`Library scan queued`}`),await Y()}catch(e){w(e instanceof Error?e.message:`Failed to scan library`)}finally{j(null),F(null)}},ye=async(e,t,r)=>{if(r){w(`Cannot delete the default library. Set another library as default first.`);return}if(await n({title:`Delete Library?`,message:`Delete library "${t}"?\n\nThis will remove the library entry but will NOT delete files on disk.`,severity:`warning`}))try{w(null),await p(e),await Y()}catch(e){w(e instanceof Error?e.message:`Failed to delete library`)}},$=T||D!==null;return(0,G.jsxs)(e,{spacing:2.5,children:[(0,G.jsxs)(e,{direction:`row`,justifyContent:`space-between`,alignItems:`center`,children:[(0,G.jsx)(v,{variant:`h5`,children:`Libraries`}),!$&&(0,G.jsx)(_,{variant:`contained`,onClick:ue,children:`+ Add Library`})]}),C&&(0,G.jsx)(k,{children:C}),$&&(0,G.jsxs)(M,{children:[(0,G.jsx)(N,{title:T?`Create Library`:`Edit Library`}),(0,G.jsxs)(e,{spacing:2,children:[(0,G.jsxs)(U,{children:[(0,G.jsx)(v,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Name (optional)`}),(0,G.jsx)(a,{value:R,onChange:e=>z(e.target.value),placeholder:`Auto-generated from path if left empty`,fullWidth:!0})]}),(0,G.jsxs)(U,{children:[(0,G.jsx)(v,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Root Path`}),(0,G.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,G.jsx)(a,{value:B,onChange:e=>V(e.target.value),placeholder:`/music`,fullWidth:!0}),(0,G.jsx)(_,{variant:`outlined`,onClick:()=>q(!K),sx:{minWidth:120},children:K?`Hide Picker`:`Browse...`})]}),K&&(0,G.jsx)(U,{sx:{mt:1.25,p:2,bgcolor:`background.default`,borderRadius:1,border:1,borderColor:`divider`},children:(0,G.jsx)(l,{value:B,onChange:e=>{V(e),q(!1)},mode:`directory`,label:`Select Library Root Directory`})})]}),(0,G.jsx)(_e,{control:(0,G.jsx)(fe,{checked:H,onChange:e=>re(e.target.checked)}),label:`Enabled`}),(0,G.jsx)(_e,{control:(0,G.jsx)(fe,{checked:ie,onChange:e=>ae(e.target.checked)}),label:`Default Library`}),D!==null&&(0,G.jsxs)(U,{children:[(0,G.jsx)(_,{variant:`outlined`,onClick:pe,disabled:!B.trim()||ce,children:ce?`Checking...`:`Preview File Count`}),oe!==null&&(0,G.jsx)(U,{sx:{mt:1,p:1.5,bgcolor:`background.paper`,borderRadius:1,border:1,borderColor:`divider`},children:(0,G.jsxs)(v,{children:[(0,G.jsx)(`strong`,{children:oe.toLocaleString()}),` audio files found`]})})]}),(0,G.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,G.jsx)(_,{variant:`contained`,onClick:T?Q:me,children:T?`Create`:`Update`}),(0,G.jsx)(_,{variant:`outlined`,onClick:Z,children:`Cancel`})]})]})]}),x&&(0,G.jsx)(v,{children:`Loading libraries...`}),!x&&!$&&y.length===0&&(0,G.jsx)(M,{children:(0,G.jsx)(v,{color:`text.secondary`,textAlign:`center`,fontStyle:`italic`,children:`No libraries configured. Click "Add Library" to get started.`})}),!x&&!$&&y.length>0&&(0,G.jsx)(e,{spacing:2,children:y.map(t=>(0,G.jsxs)(M,{children:[(0,G.jsxs)(e,{direction:`row`,justifyContent:`space-between`,alignItems:`flex-start`,sx:{mb:2},children:[(0,G.jsxs)(U,{children:[(0,G.jsxs)(e,{direction:`row`,alignItems:`center`,spacing:1.25,sx:{mb:.5},children:[(0,G.jsx)(v,{variant:`h6`,children:t.name}),t.isDefault&&(0,G.jsx)(s,{label:`Default`,color:`primary`,size:`small`}),X(t.rootPath)&&(0,G.jsx)(s,{label:`Outside library_root`,color:`warning`,size:`small`})]}),(0,G.jsx)(v,{variant:`body2`,color:`text.secondary`,sx:{fontFamily:`monospace`},children:t.rootPath}),X(t.rootPath)&&(0,G.jsxs)(v,{variant:`caption`,color:`warning.main`,sx:{mt:.5},children:[`⚠ This library is outside the configured library_root (`,I,`)`]})]}),(0,G.jsxs)(e,{direction:`row`,alignItems:`center`,spacing:1,children:[(0,G.jsx)(U,{sx:{width:8,height:8,borderRadius:`50%`,bgcolor:t.isEnabled?`success.main`:`text.disabled`}}),(0,G.jsx)(v,{variant:`body2`,color:`text.secondary`,children:t.isEnabled?`Enabled`:`Disabled`})]})]}),(0,G.jsxs)(e,{direction:`row`,spacing:1.25,flexWrap:`wrap`,children:[(0,G.jsx)(_,{variant:`outlined`,size:`small`,onClick:()=>de(t),disabled:A===t.id,children:`Edit`}),!t.isDefault&&(0,G.jsx)(_,{variant:`outlined`,size:`small`,onClick:()=>he(t.id),disabled:A===t.id,children:`Set Default`}),(0,G.jsx)(_,{variant:`contained`,color:`success`,size:`small`,onClick:()=>ge(t.id),disabled:!t.isEnabled||A===t.id||X(t.rootPath),title:X(t.rootPath)?`Cannot scan: library is outside library_root`:void 0,children:A===t.id?P===`preparing`?`Preparing...`:`Queueing...`:`Scan`}),(0,G.jsx)(_,{variant:`contained`,color:`error`,size:`small`,onClick:()=>ye(t.id,t.name,t.isDefault),disabled:A===t.id,children:`Delete`})]})]},t.id))}),(0,G.jsx)(ee,{open:r,title:i.title,message:i.message,confirmLabel:i.confirmLabel,cancelLabel:i.cancelLabel,severity:i.severity,onConfirm:o,onCancel:c})]})}function be({configKey:e,value:t,onChange:r,disabled:i}){let o=t==null?``:String(t);return(0,G.jsxs)(U,{sx:{display:`grid`,gap:1},children:[(0,G.jsx)(v,{variant:`body2`,color:`text.secondary`,sx:{fontWeight:`bold`},children:e}),(0,G.jsx)(U,{sx:{display:`flex`,gap:1.25,alignItems:`center`},children:typeof t==`boolean`?(0,G.jsxs)(n,{value:o,onChange:t=>r(e,t.target.value),disabled:i,size:`small`,fullWidth:!0,children:[(0,G.jsx)(c,{value:`true`,children:`true`}),(0,G.jsx)(c,{value:`false`,children:`false`})]}):(0,G.jsx)(a,{type:`text`,value:o,onChange:t=>r(e,t.target.value),disabled:i,size:`small`,fullWidth:!0})})]})}function xe({config:t,hasChanges:n,saveLoading:r,onChange:i,onSaveAll:a}){return(0,G.jsxs)(M,{children:[(0,G.jsx)(N,{title:`Settings`}),(0,G.jsx)(v,{variant:`body2`,color:`text.secondary`,sx:{mb:2.5},children:`Changes are saved to the database and will take effect on server restart. Use "Restart Server" in Admin page to apply changes.`}),(0,G.jsx)(e,{spacing:1.875,children:Object.entries(t).map(([e,t])=>(0,G.jsx)(be,{configKey:e,value:t,onChange:i,disabled:r},e))}),(0,G.jsxs)(U,{sx:{mt:3.75,display:`flex`,gap:1.25,alignItems:`center`},children:[(0,G.jsx)(_,{onClick:a,variant:`contained`,disabled:!n||r,sx:{whiteSpace:`nowrap`},children:r?`Saving...`:`Save All Changes`}),n&&(0,G.jsx)(v,{variant:`body2`,color:`warning.main`,children:`Unsaved changes`})]})]})}function Se(){let{showSuccess:e,showError:t,showInfo:n}=ne(),[r,i]=(0,W.useState)({}),[a,o]=(0,W.useState)({}),[s,c]=(0,W.useState)(!0),[l,u]=(0,W.useState)(null),[d,f]=(0,W.useState)(!1),[p,m]=(0,W.useState)(!1),h=async()=>{try{c(!0),u(null);let e=await ve();i(e),o(e),m(!1)}catch(e){u(e instanceof Error?e.message:`Failed to load config`),console.error(`[Config] Load error:`,e)}finally{c(!1)}};return(0,W.useEffect)(()=>{h()},[]),(0,W.useEffect)(()=>{m(Object.keys(r).some(e=>r[e]!==a[e]))},[r,a]),{config:r,loading:s,error:l,saveLoading:d,hasChanges:p,handleSaveAll:async()=>{try{f(!0);let t=[];for(let e of Object.keys(r))if(r[e]!==a[e]){let n=r[e];if(n==null||n===``)continue;await ye(e,String(n)),t.push(e)}if(t.length===0){n(`No changes to save`);return}e(`Saved ${t.length} config change(s). Use "Restart Server" in Admin page to apply.`),await h()}catch(e){t(e instanceof Error?e.message:`Failed to save config`)}finally{f(!1)}},handleChange:(e,t)=>{i(n=>({...n,[e]:t}))}}}function Ce(){let{config:t,loading:n,error:r,saveLoading:i,hasChanges:a,handleSaveAll:o,handleChange:s}=Se();return(0,G.jsxs)(I,{title:`Configuration`,children:[n&&(0,G.jsx)(P,{}),r&&(0,G.jsxs)(F,{severity:`error`,children:[`Error: `,r]}),!n&&!r&&(0,G.jsxs)(e,{spacing:2.5,children:[(0,G.jsx)(xe,{config:t,hasChanges:a,saveLoading:i,onChange:s,onSaveAll:o}),(0,G.jsx)($,{})]})]})}export{Ce as ConfigPage};