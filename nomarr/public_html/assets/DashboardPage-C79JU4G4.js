import{t as e}from"./Stack-BxZspPnU.js";import"./ChartsWrapper-cygnRCoT.js";import{a as t}from"./listItemTextClasses-ENR1_cxX.js";import"./Popper-CZ65LEmg.js";import{n,r,t as i}from"./ListItemText-aZarx6Ma.js";import{Fn as a,Ln as o,Q as s,Z as c,et as l,g as u,gt as d,it as f,k as p,nt as m,rt as h,tt as g,v as _,wn as v,yt as y}from"./index-xv6GugTr.js";import{t as b}from"./MusicNote-CTeZclyf.js";import{t as x}from"./PieChart-D3Bj3s1W.js";var S=o(a(),1),C=o(v(),1);function w(){let[a,o]=(0,S.useState)(null),[v,w]=(0,S.useState)(null),[T,E]=(0,S.useState)([]),[D,O]=(0,S.useState)(!0),[k,A]=(0,S.useState)(null),[j,M]=(0,S.useState)(null),N=(0,S.useRef)([]),P=async()=>{try{O(!0),A(null);let[e,t,n]=await Promise.all([p(),_(),u(10)]);o(e),w(t),E(n.files),F(e)}catch(e){A(e instanceof Error?e.message:`Failed to load dashboard data`),console.error(`[Dashboard] Load error:`,e)}finally{O(!1)}},F=e=>{let t=Date.now(),n=e.processed_files,r=N.current;r.push({count:n,time:t});let i=t-300*1e3;N.current=r.filter(e=>e.time>i);let a=0,o=null;if(N.current.length>=2){let t=N.current[0],n=N.current[N.current.length-1],r=(n.time-t.time)/(1e3*60),i=n.count-t.count;if(r>0&&i>0){a=i/r;let t=e.pending_files;t>0&&a>0&&(o=t/a)}}M({totalFiles:e.total_files,processedCount:n,filesPerMinute:Math.round(a*10)/10,estimatedMinutesRemaining:o,lastUpdateTime:t})};(0,S.useEffect)(()=>{P()},[]),(0,S.useEffect)(()=>{let e=a?.is_busy??!1?1e3:3e4,t=setInterval(async()=>{try{let[e,t]=await Promise.all([p(),u(10)]);o(e),E(t.files),F(e)}catch(e){console.error(`[Dashboard] Failed to update work status:`,e)}},e);return()=>clearInterval(t)},[a]);let I=e=>`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m`,L=e=>e===null||e<=0?`—`:e<1?`< 1 min`:e<60?`${Math.round(e)} min`:`${Math.floor(e/60)}h ${Math.round(e%60)}m`,R=e=>{let t=Date.now()-e,n=Math.floor(t/6e4),r=Math.floor(n/60),i=Math.floor(r/24);return n<1?`just now`:n<60?`${n}m ago`:r<24?`${r}h ago`:`${i}d ago`},z=(0,S.useMemo)(()=>v?[{id:`tracks`,value:v.total_files,label:`Tracks`,color:`#2196f3`},{id:`artists`,value:v.unique_artists,label:`Artists`,color:`#4caf50`},{id:`albums`,value:v.unique_albums,label:`Albums`,color:`#ff9800`}]:[],[v]),B=(0,S.useMemo)(()=>a?[{id:`processed`,value:a.processed_files,label:`Processed`,color:`#4caf50`},{id:`pending`,value:a.pending_files,label:`Pending`,color:`#ff9800`}].filter(e=>e.value>0):[],[a]),V=a&&a.pending_files>0,H=a?.is_scanning??!1,U=j&&j.totalFiles>0?Math.round(j.processedCount/j.totalFiles*100):0;return(0,C.jsxs)(s,{title:`Dashboard`,children:[D&&(0,C.jsx)(y,{sx:{mt:2},children:`Loading dashboard...`}),k&&(0,C.jsxs)(c,{children:[`Error: `,k]}),!D&&!k&&(0,C.jsxs)(e,{spacing:2.5,children:[H&&a?.scanning_libraries&&(0,C.jsxs)(f,{children:[(0,C.jsx)(h,{title:`Scanning Libraries`}),(0,C.jsx)(e,{spacing:1,children:a.scanning_libraries.map(e=>(0,C.jsx)(g,{label:e.name,value:e.progress,total:e.total,percentage:e.total>0?Math.round(e.progress/e.total*100):0},e.library_id))})]}),V&&j&&(0,C.jsxs)(f,{children:[(0,C.jsx)(h,{title:`Processing Status`}),(0,C.jsx)(d,{sx:{mb:2},children:(0,C.jsx)(g,{label:`Files processed`,value:j.processedCount,total:j.totalFiles,percentage:U})}),(0,C.jsxs)(l,{minWidth:150,children:[(0,C.jsx)(m,{label:`Velocity`,value:j.filesPerMinute>0?`${j.filesPerMinute}/min`:`—`}),(0,C.jsx)(m,{label:`ETA`,value:L(j.estimatedMinutesRemaining)}),(0,C.jsx)(m,{label:`Pending`,value:a?.pending_files||0}),(0,C.jsx)(m,{label:`Processed`,value:a?.processed_files||0})]})]}),(0,C.jsxs)(f,{children:[(0,C.jsx)(h,{title:`Processing Summary`}),a&&(0,C.jsxs)(d,{sx:{display:`flex`,flexDirection:{xs:`column`,md:`row`},gap:3},children:[B.length>0&&(0,C.jsx)(d,{sx:{width:{xs:`100%`,md:200},height:150},children:(0,C.jsx)(x,{series:[{data:B,innerRadius:30,outerRadius:60,paddingAngle:2,cornerRadius:4}],height:150,hideLegend:!0})}),(0,C.jsx)(d,{sx:{flex:1},children:(0,C.jsxs)(l,{minWidth:150,children:[(0,C.jsx)(m,{label:`Pending`,value:a.pending_files}),(0,C.jsx)(m,{label:`Processed`,value:a.processed_files}),(0,C.jsx)(m,{label:`Total Files`,value:a.total_files})]})})]})]}),(0,C.jsxs)(f,{children:[(0,C.jsx)(h,{title:`Library Stats`}),v&&(0,C.jsxs)(d,{sx:{display:`flex`,flexDirection:{xs:`column`,md:`row`},gap:3},children:[(0,C.jsx)(d,{sx:{width:{xs:`100%`,md:200},height:150},children:(0,C.jsx)(x,{series:[{data:z,innerRadius:30,outerRadius:60,paddingAngle:2,cornerRadius:4}],height:150,hideLegend:!0})}),(0,C.jsx)(d,{sx:{flex:1},children:(0,C.jsxs)(l,{minWidth:200,children:[(0,C.jsx)(m,{label:`Total Files`,value:v.total_files}),(0,C.jsx)(m,{label:`Artists`,value:v.unique_artists}),(0,C.jsx)(m,{label:`Albums`,value:v.unique_albums}),(0,C.jsx)(m,{label:`Total Duration`,value:I(v.total_duration_seconds)})]})})]})]}),(0,C.jsxs)(f,{children:[(0,C.jsx)(h,{title:`Recent Activity`}),T.length===0?(0,C.jsx)(y,{color:`text.secondary`,fontStyle:`italic`,children:`No recently processed tracks.`}):(0,C.jsx)(t,{dense:!0,disablePadding:!0,children:T.map(e=>(0,C.jsxs)(r,{disableGutters:!0,children:[(0,C.jsx)(n,{sx:{minWidth:36},children:(0,C.jsx)(b,{color:`action`,fontSize:`small`})}),(0,C.jsx)(i,{primary:e.title||e.path.split(`/`).pop(),secondary:`${e.artist||`Unknown`} • ${e.album||`Unknown`}`,primaryTypographyProps:{variant:`body2`},secondaryTypographyProps:{variant:`caption`}}),(0,C.jsx)(y,{variant:`caption`,color:`text.secondary`,children:R(e.last_tagged_at)})]},e.file_id))})]})]})]})}export{w as DashboardPage};