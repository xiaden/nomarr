import{t as e}from"./Stack-3GazAHpv.js";import{t}from"./TextField-69jg-W4Q.js";import"./useSlotProps-Bj3y4dRD.js";import{t as n}from"./Chip-C2H-t_S8.js";import{a as r,i,n as a,r as o,t as s}from"./TableRow-MgM88O5_.js";import{G as c,St as l,b as u,d,ft as f,m as p,n as m,p as h,w as g,x as _,xt as v}from"./index-Cc_P-jdR.js";var y=l(f(),1);function b({data:t}){return(0,y.jsxs)(p,{children:[(0,y.jsx)(h,{title:`Mood Distribution`}),(0,y.jsx)(e,{spacing:1.25,children:t.map(e=>(0,y.jsx)(d,{label:e.mood,value:e.count,percentage:e.percentage},e.mood))})]})}var x=c((0,y.jsx)(`path`,{d:`M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z`}),`Close`),S=l(v(),1);function C({value:e,onChange:n,options:r,placeholder:i=`Type or select...`,disabled:a=!1,...o}){let[s,c]=(0,S.useState)(!1),[l,u]=(0,S.useState)(r),d=(0,S.useRef)(null);(0,S.useEffect)(()=>{u(e?r.filter(t=>t.toLowerCase().includes(e.toLowerCase())):r)},[e,r]),(0,S.useEffect)(()=>{let e=e=>{d.current&&!d.current.contains(e.target)&&c(!1)};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)},[]);let f=e=>{n(e.target.value),c(!0)},p=e=>{n(e),c(!1)};return(0,y.jsxs)(_,{...o,ref:d,sx:{position:`relative`,...o.sx},children:[(0,y.jsx)(t,{type:`text`,value:e,onChange:f,onFocus:()=>c(!0),placeholder:i,disabled:a,fullWidth:!0,size:`small`,sx:{"& .MuiOutlinedInput-root":{bgcolor:a?`background.paper`:`background.default`}}}),s&&!a&&l.length>0&&(0,y.jsx)(_,{sx:{position:`absolute`,top:`100%`,left:0,right:0,maxHeight:`200px`,overflowY:`auto`,bgcolor:`background.default`,border:1,borderColor:`divider`,borderTop:`none`,borderRadius:`0 0 4px 4px`,boxShadow:2,zIndex:1e3},children:l.map((e,t)=>(0,y.jsx)(_,{onClick:()=>p(e),sx:{p:1.5,cursor:`pointer`,fontSize:`0.875rem`,borderBottom:t<l.length-1?1:`none`,borderColor:`divider`,"&:hover":{bgcolor:`action.hover`}},children:e},t))})]})}function w(){let[t,c]=(0,S.useState)([]),[l,d]=(0,S.useState)([]),[f,v]=(0,S.useState)(``),[b,w]=(0,S.useState)(``),[T,E]=(0,S.useState)([]),[D,O]=(0,S.useState)([]),[k,A]=(0,S.useState)(null),[j,M]=(0,S.useState)(!1),[N,P]=(0,S.useState)(null);(0,S.useEffect)(()=>{F()},[]),(0,S.useEffect)(()=>{f?I(f):(d([]),w(``))},[f]);let F=async()=>{try{c((await m.files.getUniqueTagKeys(!0)).tag_keys)}catch(e){console.error(`[TagCoOccurrence] Failed to load tag keys:`,e)}},I=async e=>{try{let t=await m.files.getUniqueTagValues(e,!0),n=new Set;for(let e of t.tag_keys)if(e.startsWith(`[`)&&e.endsWith(`]`))try{let t=JSON.parse(e);Array.isArray(t)?t.forEach(e=>n.add(String(e))):n.add(e)}catch{n.add(e)}else n.add(e);d(Array.from(n).sort())}catch(e){console.error(`[TagCoOccurrence] Failed to load tag values:`,e),d([])}},L=(e,t)=>T.some(n=>n.key===e&&n.value===t)||D.some(n=>n.key===e&&n.value===t),R=()=>{f&&b&&!T.some(e=>e.key===f&&e.value===b)&&T.length<16&&E([...T,{key:f,value:b}])},z=()=>{f&&b&&!D.some(e=>e.key===f&&e.value===b)&&D.length<16&&O([...D,{key:f,value:b}])},B=e=>{E(T.filter((t,n)=>n!==e))},V=e=>{O(D.filter((t,n)=>n!==e))},H=async()=>{if(T.length===0||D.length===0){P(`Both X and Y axes must have at least one tag`);return}try{M(!0),P(null),A(await m.analytics.getTagCoOccurrence({x:T,y:D}))}catch(e){P(e instanceof Error?e.message:`Failed to build matrix`),console.error(`[TagCoOccurrence] Matrix build error:`,e)}finally{M(!1)}},U=(e,t)=>{if(e===0)return`#1a1a1a`;let n=Math.min(e/t,1);return`rgb(${Math.floor(30+n*44)}, ${Math.floor(30+n*128)}, ${Math.floor(30+n*225)})`},W=k?.matrix?Math.max(...k.matrix.flat(),1):1;return(0,y.jsxs)(p,{children:[(0,y.jsx)(h,{title:`Tag Co-Occurrence Matrix`}),(0,y.jsxs)(e,{spacing:2,sx:{mb:2.5},children:[(0,y.jsxs)(_,{sx:{display:`flex`,gap:1.5,alignItems:`flex-end`},children:[(0,y.jsxs)(_,{sx:{flex:1},children:[(0,y.jsx)(g,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Key`}),(0,y.jsx)(C,{value:f,onChange:v,options:t,placeholder:`Select tag key...`})]}),(0,y.jsxs)(_,{sx:{flex:1},children:[(0,y.jsx)(g,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Value`}),(0,y.jsx)(C,{value:b,onChange:w,options:l,placeholder:`Select tag value...`,disabled:!f})]}),(0,y.jsx)(u,{onClick:R,disabled:!f||!b||T.length>=16||L(f,b),variant:`contained`,size:`small`,children:`Add to X`}),(0,y.jsx)(u,{onClick:z,disabled:!f||!b||D.length>=16||L(f,b),variant:`contained`,color:`secondary`,size:`small`,children:`Add to Y`})]}),(0,y.jsxs)(_,{children:[(0,y.jsxs)(g,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`X Axis (`,T.length,`/16)`]}),(0,y.jsxs)(_,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[T.length===0&&(0,y.jsx)(g,{variant:`body2`,color:`text.secondary`,children:`No tags added to X axis yet`}),T.map((e,t)=>(0,y.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>B(t),deleteIcon:(0,y.jsx)(x,{}),size:`small`},t))]})]}),(0,y.jsxs)(_,{children:[(0,y.jsxs)(g,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`Y Axis (`,D.length,`/16)`]}),(0,y.jsxs)(_,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[D.length===0&&(0,y.jsx)(g,{variant:`body2`,color:`text.secondary`,children:`No tags added to Y axis yet`}),D.map((e,t)=>(0,y.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>V(t),deleteIcon:(0,y.jsx)(x,{}),size:`small`},t))]})]}),(0,y.jsx)(u,{onClick:H,disabled:j||T.length===0||D.length===0,variant:`contained`,fullWidth:!0,children:j?`Building Matrix...`:`Build Matrix`})]}),N&&(0,y.jsx)(g,{color:`error`,sx:{mb:2},children:N}),k&&(0,y.jsx)(_,{sx:{overflowX:`auto`,mt:2.5},children:(0,y.jsxs)(r,{size:`small`,sx:{minWidth:300},children:[(0,y.jsx)(a,{children:(0,y.jsxs)(s,{children:[(0,y.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Y \\ X`}),k.x.map((e,t)=>(0,y.jsxs)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:[e.key,`:`,(0,y.jsx)(`br`,{}),e.value]},t))]})}),(0,y.jsx)(i,{children:k.y.map((e,t)=>(0,y.jsxs)(s,{children:[(0,y.jsxs)(o,{sx:{borderColor:`divider`,fontWeight:600},children:[e.key,`: `,e.value]}),k.x.map((e,n)=>(0,y.jsx)(o,{align:`center`,sx:{borderColor:`divider`,bgcolor:U(k.matrix[t][n],W),fontWeight:k.matrix[t][n]>0?600:`normal`},children:k.matrix[t][n]},n))]},t))})]})})]})}function T({data:e,limit:t=50}){return(0,y.jsxs)(p,{children:[(0,y.jsx)(h,{title:`Tag Frequencies (Top ${t})`}),(0,y.jsx)(_,{sx:{maxHeight:600,overflowY:`auto`,overflowX:`auto`},children:(0,y.jsxs)(r,{sx:{minWidth:300},children:[(0,y.jsx)(a,{children:(0,y.jsxs)(s,{children:[(0,y.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Tag`}),(0,y.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Count`})]})}),(0,y.jsx)(i,{children:e.map(e=>(0,y.jsxs)(s,{children:[(0,y.jsx)(o,{sx:{borderColor:`divider`},children:e.tag_key}),(0,y.jsx)(o,{sx:{borderColor:`divider`},children:e.total_count})]},e.tag_key))})]})})]})}function E(){let[e,t]=(0,S.useState)({tagFrequencies:[],moodDistribution:[]}),[n,r]=(0,S.useState)(!0),[i,a]=(0,S.useState)(null);return(0,S.useEffect)(()=>{(async()=>{try{r(!0),a(null);let[e,n]=await Promise.all([m.analytics.getTagFrequencies(50),m.analytics.getMoodDistribution()]);t({tagFrequencies:e.tag_frequencies,moodDistribution:n.mood_distribution})}catch(e){a(e instanceof Error?e.message:`Failed to load analytics`),console.error(`[Analytics] Load error:`,e)}finally{r(!1)}})()},[]),{data:e,loading:n,error:i}}function D(){let{data:e,loading:t,error:n}=E();return(0,y.jsxs)(`div`,{style:{padding:`20px`},children:[(0,y.jsx)(`h1`,{style:{marginBottom:`20px`},children:`Analytics`}),t&&(0,y.jsx)(`p`,{children:`Loading analytics data...`}),n&&(0,y.jsxs)(`p`,{style:{color:`var(--accent-red)`},children:[`Error: `,n]}),!t&&!n&&(0,y.jsxs)(`div`,{style:{display:`grid`,gap:`20px`},children:[(0,y.jsx)(b,{data:e.moodDistribution}),(0,y.jsx)(T,{data:e.tagFrequencies}),(0,y.jsx)(w,{})]})]})}export{D as AnalyticsPage};