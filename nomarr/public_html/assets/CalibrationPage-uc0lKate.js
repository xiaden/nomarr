import{t as e}from"./Stack-DoLtnbcQ.js";import"./ChartsWrapper-DVamlxfw.js";import{i as t,o as n,r,t as i}from"./Select-B5bVQCV0.js";import{t as a}from"./ExpandMore-65li7hLD.js";import{n as o,r as s,t as c}from"./AccordionSummary-BAVN3JM4.js";import"./Popper-D7ogtwWz.js";import{a as l,i as u,n as d,r as f,t as p}from"./TableRow-tyIFvJAE.js";import{t as m}from"./TableContainer-C6dGqsUq.js";import{B as h,Et as g,G as _,Gn as v,H as y,K as b,Mn as x,Nt as S,R as C,U as w,Un as T,V as E,W as D,ct as O,et as k,it as A,kt as j,lt as M,ot as N,rt as P,wt as F,xt as I,z as L}from"./index-D3CBCd4e.js";import{t as R}from"./useConfirmDialog-Bbgm_gYn.js";import{t as z}from"./useNotification-BfaSfgIA.js";import{t as B}from"./BarChart-C-nmDaws.js";var V=v(x(),1);function H({onGenerate:t,onApply:n,onUpdateFiles:r,onClear:i,actionLoading:a}){return(0,V.jsxs)(M,{children:[(0,V.jsx)(O,{title:`Actions`}),(0,V.jsx)(e,{spacing:2,children:[{label:`Generate New Calibration`,description:`Analyze all files in library to generate optimal calibration values. This will scan the entire library and may take some time.`,onClick:t,color:`primary`,variant:`contained`},{label:`Apply Calibration to Library`,description:`Queue all files for reprocessing with current calibration. This will update all tags based on the current calibration values.`,onClick:n,color:`primary`,variant:`contained`},{label:`Update Calibration Files`,description:`Download and import the latest calibration bundle files from the repository.`,onClick:r,color:`secondary`,variant:`outlined`},{label:`Clear Calibration Data`,description:`Remove all calibration states, history, and reset file calibration hashes. You will need to regenerate calibration afterward.`,onClick:i,color:`error`,variant:`outlined`}].map(e=>(0,V.jsx)(A,{label:e.label,description:e.description,onClick:e.onClick,disabled:a,variant:e.variant,color:e.color},e.label))})]})}function U({status:e}){let t=e.last_run?new Date(e.last_run*1e3).toLocaleString():`Never`;return(0,V.jsxs)(M,{children:[(0,V.jsx)(O,{title:`Calibration Status`}),(0,V.jsxs)(I,{sx:{mb:3},children:[(0,V.jsxs)(F,{variant:`body2`,color:`text.secondary`,children:[(0,V.jsx)(`strong`,{children:`Global Version:`}),` `,e.global_version||`Not calibrated`]}),(0,V.jsxs)(F,{variant:`body2`,color:`text.secondary`,children:[(0,V.jsx)(`strong`,{children:`Last Run:`}),` `,t]})]}),e.libraries.length>0?(0,V.jsx)(m,{component:S,variant:`outlined`,children:(0,V.jsxs)(l,{size:`small`,children:[(0,V.jsx)(d,{children:(0,V.jsxs)(p,{children:[(0,V.jsx)(f,{children:`Library`}),(0,V.jsx)(f,{align:`right`,children:`Total Files`}),(0,V.jsx)(f,{align:`right`,children:`Current`}),(0,V.jsx)(f,{align:`right`,children:`Outdated`}),(0,V.jsx)(f,{align:`right`,children:`Calibration %`})]})}),(0,V.jsx)(u,{children:e.libraries.map(e=>(0,V.jsxs)(p,{children:[(0,V.jsx)(f,{children:e.library_name}),(0,V.jsx)(f,{align:`right`,children:e.total_files.toLocaleString()}),(0,V.jsx)(f,{align:`right`,children:e.current_count.toLocaleString()}),(0,V.jsx)(f,{align:`right`,children:e.outdated_count.toLocaleString()}),(0,V.jsxs)(f,{align:`right`,children:[e.percentage.toFixed(1),`%`]})]},e.library_id))})]})}):(0,V.jsx)(F,{variant:`body2`,color:`text.secondary`,children:`No libraries found.`})]})}var W=v(T(),1);function G(){try{return localStorage.getItem(`nomarr_debug`)===`true`}catch{return!1}}function K(e,t,n){G()&&(n===void 0?console.debug(`[nomarr:${e}]`,t):console.debug(`[nomarr:${e}]`,t,n))}function q(e){let t=e.indexOf(`:`);return t>=0?e.slice(t+1):e}function J(e){return Math.abs(e)>=100?e.toFixed(0):Math.abs(e)>=10?e.toFixed(1):e.toFixed(2)}function Y(e,t=25){let n=[];switch(e){case`healthy`:for(let e=0;e<t;e++){let r=e/t*100,i=Math.abs(r-50),a=Math.max(0,Math.floor(100*Math.exp(-((i/20)**2))));a>0&&n.push({val:r,count:a})}break;case`focused`:for(let e=0;e<t;e++){let r=e/t*100,i=Math.abs(r-50),a=0;i<15?a=Math.floor(80*Math.exp(-((i/8)**2))):i<35&&(a=Math.floor(20*Math.exp(-(((i-15)/10)**2)))),a>0&&n.push({val:r,count:a})}break;case`extreme`:for(let e=0;e<t;e++){let r=e/t*100,i=Math.abs(r-50),a=i<5?Math.floor(100-i*5):0;a>0&&n.push({val:r,count:a})}break;case`skewed`:for(let e=0;e<t;e++){let r=e/t*100,i=Math.floor(80*Math.exp(-r/30));i>0&&n.push({val:r,count:i})}break;case`sparse`:for(let e=0;e<t;e++){let r=e/t*100,i=0;(r<15||r>40&&r<50||r>85)&&(i=Math.floor(Math.random()*40+10)),i>0&&n.push({val:r,count:i})}break}return n}var X=[{label:`✅ Healthy Spread`,severity:`success`,description:`Your library has good variety across this quality. Values are spread across the range with reasonable peaks. The P5/P95 boundaries capture the full spectrum of your music, and calibration should work well for filtering and recommendations.`,bins:Y(`healthy`),p5:25,p95:75},{label:`ℹ️ Genre-Focused (Normal)`,severity:`info`,description:`Your music clusters in one region - this is completely normal for focused libraries! Classical collections cluster high on 'acoustic', electronic/EDM clusters low. Metal libraries cluster high on 'aggressive' and 'energy'. As long as you have 5,000+ songs in the cluster, calibration will still work fine for your collection.`,bins:Y(`focused`),p5:38,p95:62},{label:`⚠️ Extreme Clustering (Concerning)`,severity:`warning`,description:`Almost all your values (90%+) are in a tiny range with very little variation. If this is unexpected for the head you're viewing, it might indicate a tagging issue or data problem. For heads like 'mood' or 'genre', you'd normally expect more spread even in focused libraries.`,bins:Y(`extreme`),p5:48,p95:52},{label:`ℹ️ Natural Skew (Normal)`,severity:`info`,description:`Your library leans heavily toward one end but has a smooth distribution. This is expected for some qualities - ambient/classical libraries naturally skew low on 'danceability', acoustic libraries skew high on 'acoustic', etc. Nothing to worry about as long as you have 1,000+ songs.`,bins:Y(`skewed`),p5:5,p95:40},{label:`⚠️ Insufficient Data`,severity:`warning`,description:`Your library has large gaps or very few samples (under 1,000 songs) combined with extreme clustering. Calibration might not be representative. Consider: (1) scanning more music, (2) adding more variety, or (3) understanding that tags may be less accurate for music very different from your library.`,bins:Y(`sparse`),p5:8,p95:88}];function Z(e){let t=Array.isArray(e?.histogram_bins)?e.histogram_bins:[];if(t.length===0)return{xLabels:[],counts:[],binValues:[],p5Index:null,p95Index:null};let n=[...t].sort((e,t)=>e.val-t.val),r=n.map(e=>J(e.val)),i=n.map(e=>e.count),a=n.map(e=>e.val),o=null,s=null,c=1/0,l=1/0;return a.forEach((t,n)=>{let r=Math.abs(t-e.p5),i=Math.abs(t-e.p95);r<c&&(c=r,o=n),i<l&&(l=i,s=n)}),{xLabels:r,counts:i,binValues:a,p5Index:o,p95Index:s}}function Q({label:e,value:t,color:n}){return(0,V.jsxs)(I,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[(0,V.jsx)(I,{sx:{width:16,height:3,bgcolor:n,borderRadius:1}}),(0,V.jsxs)(F,{variant:`body2`,color:`text.secondary`,children:[e,`: `,(0,V.jsx)(`strong`,{children:J(t)})]})]})}function $({example:e}){let t=e.bins.map(e=>J(e.val)),n=e.bins.map(e=>e.count);return(0,V.jsxs)(I,{sx:{border:2,borderColor:e.severity===`success`?`success.main`:e.severity===`warning`?`warning.main`:`info.main`,borderRadius:1,p:2,backgroundColor:`background.paper`},children:[(0,V.jsx)(F,{variant:`subtitle2`,fontWeight:600,sx:{mb:1},children:e.label}),(0,V.jsx)(I,{sx:{height:180,mb:2,overflow:`hidden`},children:(0,V.jsx)(B,{height:180,xAxis:[{scaleType:`band`,data:t,tickLabelStyle:{fontSize:8},tickLabelInterval:(e,n)=>n%Math.ceil(t.length/10)===0}],series:[{data:n,color:e.severity===`success`?`#90ee90`:e.severity===`warning`?`#ffcc80`:`#90caf9`}],hideLegend:!0,margin:{left:40,right:10,top:10,bottom:30}})}),(0,V.jsxs)(I,{sx:{display:`flex`,gap:2,mb:1.5},children:[(0,V.jsxs)(F,{variant:`caption`,color:`text.secondary`,children:[`P5: `,(0,V.jsx)(`strong`,{children:J(e.p5)})]}),(0,V.jsxs)(F,{variant:`caption`,color:`text.secondary`,children:[`P95: `,(0,V.jsx)(`strong`,{children:J(e.p95)})]})]}),(0,V.jsx)(F,{variant:`body2`,color:`text.secondary`,children:e.description})]})}function ee({data:e,loading:l,error:u}){let d=`HistogramCharts`,f=(0,W.useMemo)(()=>e?e.map(e=>({key:`${e.model_key}:${e.head_name}:${e.label}`,label:`${q(e.head_name)} - ${e.label}`,fullLabel:`${e.model_key}:${e.head_name}:${e.label}`})):[],[e]),[p,m]=(0,W.useState)(``),h=p||f[0]?.key||``,g=(0,W.useMemo)(()=>!e||!h?null:e.find(e=>`${e.model_key}:${e.head_name}:${e.label}`===h)??null,[e,h]),_=(0,W.useMemo)(()=>g?Z(g):null,[g]);return(0,W.useEffect)(()=>{K(d,`mount/update`,{loading:l,error:u,headCount:e?.length??0,selectedHead:h})},[l,u,e,h]),(0,W.useEffect)(()=>{_&&K(d,`processed histogram`,{head:h,binCount:_.counts.length,totalSamples:_.counts.reduce((e,t)=>e+t,0),p5Index:_.p5Index,p95Index:_.p95Index,xLabelRange:_.xLabels.length>0?`${_.xLabels[0]} .. ${_.xLabels[_.xLabels.length-1]}`:`(empty)`})},[_,h]),l?(0,V.jsxs)(I,{sx:{display:`flex`,alignItems:`center`,gap:2,py:2},children:[(0,V.jsx)(j,{size:20}),(0,V.jsx)(F,{variant:`body2`,children:`Loading histogram data...`})]}):u?(0,V.jsx)(F,{color:`error`,variant:`body2`,children:u}):!e||e.length===0?(0,V.jsx)(F,{variant:`body2`,color:`text.secondary`,children:`No histogram data available. Run calibration to see distribution.`}):(0,V.jsxs)(I,{children:[(0,V.jsxs)(s,{defaultExpanded:!0,children:[(0,V.jsx)(c,{expandIcon:(0,V.jsx)(a,{}),children:(0,V.jsx)(F,{variant:`subtitle1`,fontWeight:500,children:`Embedding Distribution`})}),(0,V.jsxs)(o,{children:[(0,V.jsx)(I,{sx:{mb:2},children:(0,V.jsxs)(n,{size:`small`,sx:{minWidth:200},children:[(0,V.jsx)(t,{id:`head-select-label`,children:`Label`}),(0,V.jsx)(i,{labelId:`head-select-label`,value:h,label:`Label`,onChange:e=>m(e.target.value),children:f.map(e=>(0,V.jsx)(r,{value:e.key,children:e.label},e.key))})]})}),(0,V.jsx)(F,{variant:`caption`,color:`text.secondary`,sx:{mb:1,display:`block`},children:`Distribution of embedding values across your library. P5/P95 markers show calibration percentiles.`}),g&&(0,V.jsxs)(I,{sx:{mb:2},children:[(0,V.jsxs)(F,{variant:`body2`,fontWeight:500,color:`text.primary`,sx:{mb:1},children:[q(g.head_name),` - `,g.label]}),(0,V.jsxs)(I,{sx:{display:`flex`,gap:3},children:[(0,V.jsx)(Q,{label:`P5`,value:g.p5,color:`#2196f3`}),(0,V.jsx)(Q,{label:`P95`,value:g.p95,color:`#f44336`}),(0,V.jsxs)(F,{variant:`body2`,color:`text.secondary`,children:[`Samples: `,(0,V.jsx)(`strong`,{children:g.n.toLocaleString()})]})]})]}),_&&_.counts.length>0?(0,V.jsx)(I,{sx:{overflow:`hidden`},children:(0,V.jsx)(B,{height:350,xAxis:[{scaleType:`band`,data:_.xLabels,label:`Embedding Value`,tickLabelStyle:{fontSize:9},tickLabelInterval:(e,t)=>t%Math.ceil(_.xLabels.length/20)===0}],series:[{data:_.counts,label:`Count`,color:`#90caf9`}],hideLegend:!0,margin:{left:60,right:20,top:20,bottom:60}})}):(0,V.jsx)(I,{sx:{height:350,display:`flex`,alignItems:`center`,justifyContent:`center`},children:(0,V.jsx)(F,{color:`text.secondary`,children:`No histogram data for selected head`})})]})]}),(0,V.jsxs)(s,{children:[(0,V.jsx)(c,{expandIcon:(0,V.jsx)(a,{}),children:(0,V.jsx)(F,{variant:`subtitle1`,fontWeight:500,children:`Understanding Your Results`})}),(0,V.jsxs)(o,{children:[(0,V.jsx)(F,{variant:`body2`,color:`text.secondary`,sx:{mb:3},children:`Common patterns and what they mean for your library. Compare your histogram above to these examples:`}),(0,V.jsx)(I,{sx:{display:`grid`,gridTemplateColumns:{xs:`1fr`,sm:`repeat(2, 1fr)`,md:`repeat(3, 1fr)`},gap:2},children:X.map(e=>(0,V.jsx)($,{example:e},e.label))})]})]})]})}function te(){let[e,t]=(0,W.useState)(null),[n,r]=(0,W.useState)(!0),[i,a]=(0,W.useState)(null),o=async()=>{try{r(!0),a(null),t((await L()).calibrations??null)}catch(e){a(e instanceof Error?e.message:`Failed to load histogram data`),console.error(`[Calibration] Histogram load error:`,e)}finally{r(!1)}};return(0,W.useEffect)(()=>{o()},[]),{data:e,loading:n,error:i,reload:o}}var ne=1e3;function re(){let[e,t]=(0,W.useState)({isApplying:!1,progress:null,result:null,error:null,completed:!1}),n=(0,W.useRef)(null),r=(0,W.useRef)(!0);(0,W.useEffect)(()=>(r.current=!0,()=>{r.current=!1,n.current&&=(clearInterval(n.current),null)}),[]);let i=(0,W.useCallback)(()=>{n.current&&=(clearInterval(n.current),null)},[]),a=(0,W.useCallback)(async()=>{if(r.current)try{let[e,n]=await Promise.all([E(),h()]);if(!r.current)return;t(t=>({...t,progress:n,isApplying:e.status===`running`})),e.status!==`running`&&(i(),e.status===`failed`?t(t=>({...t,isApplying:!1,error:e.error,completed:!0})):e.status===`completed`&&e.result&&t(t=>({...t,isApplying:!1,result:e.result,completed:!0})))}catch(e){console.error(`[CalibrationApply] Poll error:`,e)}},[i]),o=(0,W.useCallback)(()=>{n.current||=(a(),setInterval(a,ne))},[a]),s=(0,W.useCallback)(async()=>{if(!e.isApplying){t({isApplying:!0,progress:null,result:null,error:null,completed:!1});try{if((await _()).status===`already_running`){o();return}o()}catch(e){i(),t(t=>({...t,isApplying:!1,error:e instanceof Error?e.message:`Failed to start calibration apply`,completed:!0}))}}},[e.isApplying,o,i]),c=(0,W.useCallback)(()=>{i(),t({isApplying:!1,progress:null,result:null,error:null,completed:!1})},[i]);return(0,W.useEffect)(()=>{(async()=>{try{(await E()).status===`running`&&(t(e=>({...e,isApplying:!0})),o())}catch(e){console.error(`[CalibrationApply] Initial status check failed:`,e)}})()},[]),{state:e,startApply:s,reset:c}}var ie=1e3;function ae(){let[e,t]=(0,W.useState)({isGenerating:!1,progress:null,result:null,error:null,completed:!1}),n=(0,W.useRef)(null),r=(0,W.useRef)(!0);(0,W.useEffect)(()=>(r.current=!0,()=>{r.current=!1,n.current&&=(clearInterval(n.current),null)}),[]);let i=(0,W.useCallback)(()=>{n.current&&=(clearInterval(n.current),null)},[]),a=(0,W.useCallback)(async()=>{if(r.current)try{let[e,n]=await Promise.all([w(),y()]);if(!r.current)return;t(t=>({...t,progress:n,isGenerating:e.running})),e.running||(i(),e.error?t(t=>({...t,isGenerating:!1,error:e.error,completed:!0})):e.completed&&e.result&&t(t=>({...t,isGenerating:!1,result:e.result,completed:!0})))}catch(e){console.error(`[CalibrationGeneration] Poll error:`,e)}},[i]),o=(0,W.useCallback)(()=>{n.current||=(a(),setInterval(a,ie))},[a]),s=(0,W.useCallback)(async()=>{if(!e.isGenerating){t({isGenerating:!0,progress:null,result:null,error:null,completed:!1});try{if((await b()).status===`already_running`){o();return}o()}catch(e){i(),t(t=>({...t,isGenerating:!1,error:e instanceof Error?e.message:`Failed to start calibration`,completed:!0}))}}},[e.isGenerating,o,i]),c=(0,W.useCallback)(()=>{i(),t({isGenerating:!1,progress:null,result:null,error:null,completed:!1})},[i]);return(0,W.useEffect)(()=>{(async()=>{try{(await w()).running&&(t(e=>({...e,isGenerating:!0})),o())}catch(e){console.error(`[CalibrationGeneration] Initial status check failed:`,e)}})()},[]),{state:e,startGeneration:s,reset:c}}function oe(){let{showSuccess:e,showError:t,showInfo:n}=z(),{confirm:r,isOpen:i,options:a,handleConfirm:o,handleCancel:s}=R(),[c,l]=(0,W.useState)(null),[u,d]=(0,W.useState)(!0),[f,p]=(0,W.useState)(null),{state:m,startGeneration:h,reset:g}=ae(),{state:_,startApply:v,reset:y}=re(),b=async()=>{try{d(!0),p(null),l(await D())}catch(e){p(e instanceof Error?e.message:`Failed to load status`),console.error(`[Calibration] Load error:`,e)}finally{d(!1)}};return(0,W.useEffect)(()=>{b()},[]),(0,W.useEffect)(()=>{if(m.completed){if(m.error){t(`Calibration failed: ${m.error}`),g();return}if(m.result){let{heads_processed:t,heads_success:n,heads_failed:r}=m.result,i=`Calibration generated! Processed ${t} heads`;r>0&&(i+=` (${n} success, ${r} failed)`),e(i),g(),b()}}},[m.completed]),(0,W.useEffect)(()=>{if(_.completed){if(_.error){t(`Calibration apply failed: ${_.error}`),y();return}if(_.result){let{processed:t,failed:n,total:r}=_.result,i=`Applied calibration to ${t}/${r} files`;n>0&&(i+=` (${n} failed)`),e(i),y(),b()}}},[_.completed]),{status:c,loading:u,error:f,generationState:m,applyState:_,handleGenerate:async()=>{await r({title:`Generate Calibration?`,message:`This analyzes all library files and may take some time. Progress will be shown while running.`,confirmLabel:`Generate`,severity:`warning`})&&await h()},handleApply:async()=>{await r({title:`Apply Calibration?`,message:`Apply calibration to entire library? This will reprocess all files with current calibration values.`,confirmLabel:`Apply`,severity:`warning`})&&await v()},handleUpdateFiles:()=>{n(`Not implemented`)},handleClear:async()=>{if(await r({title:`Clear All Calibration Data?`,message:`This will permanently remove all calibration states, history, and reset file calibration hashes. You will need to regenerate calibration afterward.`,confirmLabel:`Clear`,severity:`error`}))try{e(`Calibration data cleared. ${(await C()).files_updated} file hashes reset.`),b()}catch(e){t(e instanceof Error?e.message:`Failed to clear calibration`)}},dialogState:{isOpen:i,options:a,handleConfirm:o,handleCancel:s}}}function se(){let{status:t,loading:n,error:r,generationState:i,applyState:a,handleGenerate:o,handleApply:s,handleUpdateFiles:c,handleClear:l,dialogState:u}=oe(),{data:d,loading:f,error:p}=te(),{isGenerating:m,progress:h}=i,{isApplying:_,progress:v}=a;return(0,V.jsxs)(P,{title:`Calibration`,children:[n&&(0,V.jsx)(j,{}),r&&(0,V.jsxs)(g,{severity:`error`,children:[`Error: `,r]}),m&&(0,V.jsxs)(M,{sx:{mb:2.5},children:[(0,V.jsxs)(I,{sx:{display:`flex`,alignItems:`center`,gap:2,mb:2},children:[(0,V.jsx)(j,{size:20}),(0,V.jsx)(F,{variant:`subtitle1`,fontWeight:500,children:`Generating Calibration...`})]}),h&&h.total_heads>0&&(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(N,{label:`Head ${h.current_head_index??0}/${h.total_heads}`,value:h.current_head_index??h.completed_heads,total:h.total_heads}),h.current_head&&(0,V.jsxs)(F,{variant:`body2`,color:`text.secondary`,sx:{mt:1},children:[`Processing: `,h.current_head]})]})]}),_&&(0,V.jsxs)(M,{sx:{mb:2.5},children:[(0,V.jsxs)(I,{sx:{display:`flex`,alignItems:`center`,gap:2,mb:2},children:[(0,V.jsx)(j,{size:20}),(0,V.jsx)(F,{variant:`subtitle1`,fontWeight:500,children:`Applying Calibration...`})]}),v&&v.total_files>0&&(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(N,{label:`${v.completed_files} / ${v.total_files} files`,value:v.completed_files,total:v.total_files}),v.current_file&&(0,V.jsx)(F,{variant:`body2`,color:`text.secondary`,sx:{mt:1,overflow:`hidden`,textOverflow:`ellipsis`,whiteSpace:`nowrap`},children:v.current_file})]})]}),t&&(0,V.jsxs)(e,{spacing:2.5,children:[(0,V.jsx)(U,{status:t}),(0,V.jsx)(ee,{data:d,loading:f,error:p}),(0,V.jsx)(H,{onGenerate:o,onApply:s,onUpdateFiles:c,onClear:l,actionLoading:m||_})]}),(0,V.jsx)(k,{open:u.isOpen,title:u.options.title,message:u.options.message,confirmLabel:u.options.confirmLabel,cancelLabel:u.options.cancelLabel,severity:u.options.severity,onConfirm:u.handleConfirm,onCancel:u.handleCancel})]})}export{se as CalibrationPage};