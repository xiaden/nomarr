import{t as e}from"./Stack-BpF9mxtT.js";import{t}from"./TextField-BJMZTB1N.js";import"./useSlotProps-C0fpQN7y.js";import{t as n}from"./Chip-B2nVSPgp.js";import{r,t as i}from"./FormControlLabel-DQICV8vY.js";import{Bt as a,C as o,E as s,Et as c,Ht as l,S as u,f as d,i as ee,m as f,n as p,o as m,p as h,s as g,u as _}from"./index-Fcl-xYYK.js";import{t as v}from"./useConfirmDialog-DAxVsBMQ.js";import{t as te}from"./useNotification-B2fuh4Dn.js";import{t as ne}from"./ServerFilePicker-51wDZ41W.js";var y=l(a(),1),b=l(c(),1);function x(){let{showSuccess:a}=te(),{confirm:c,isOpen:l,options:d,handleConfirm:g,handleCancel:_}=v(),[x,S]=(0,y.useState)([]),[C,w]=(0,y.useState)(!0),[T,E]=(0,y.useState)(null),[D,O]=(0,y.useState)(!1),[k,A]=(0,y.useState)(null),[j,M]=(0,y.useState)(null),[re,N]=(0,y.useState)(null),[P,ie]=(0,y.useState)(null),[F,I]=(0,y.useState)(``),[L,R]=(0,y.useState)(``),[z,B]=(0,y.useState)(!0),[V,H]=(0,y.useState)(!1),[U,W]=(0,y.useState)(!1),[G,K]=(0,y.useState)(null),[q,J]=(0,y.useState)(!1),Y=async()=>{try{w(!0),E(null),S(await p.library.list())}catch(e){E(e instanceof Error?e.message:`Failed to load libraries`),console.error(`[LibraryManagement] Load error:`,e)}finally{w(!1)}},ae=async()=>{try{ie((await p.config.get()).library_root||null)}catch(e){console.error(`[LibraryManagement] Failed to load config:`,e)}};(0,y.useEffect)(()=>{Y(),ae()},[]);let X=e=>{if(!P)return!1;let t=P.replace(/\/+$/,``);return!e.replace(/\/+$/,``).startsWith(t)},Z=()=>{I(``),R(``),B(!0),H(!1),W(!1),K(null),J(!1),O(!1),A(null)},oe=()=>{Z(),O(!0)},se=e=>{I(e.name),R(e.rootPath),B(e.isEnabled),H(e.isDefault),A(e.id),O(!1),K(null),J(!1)},ce=async()=>{if(!L.trim()){E(`Path is required for preview`);return}if(k===null){E(`Create the library first to preview file count`);return}try{E(null),J(!0),K((await p.library.preview(k,{recursive:!0})).file_count)}catch(e){E(e instanceof Error?e.message:`Failed to preview library`)}finally{J(!1)}},le=async()=>{if(!F.trim()||!L.trim()){E(`Name and path are required`);return}try{E(null),await p.library.create({name:F,rootPath:L,isEnabled:z,isDefault:V}),await Y(),Z()}catch(e){E(e instanceof Error?e.message:`Failed to create library`)}},ue=async()=>{if(k!==null){if(!F.trim()||!L.trim()){E(`Name and path are required`);return}try{E(null),await p.library.update(k,{name:F,rootPath:L,isEnabled:z,isDefault:V}),await Y(),Z()}catch(e){E(e instanceof Error?e.message:`Failed to update library`)}}},Q=async e=>{try{E(null),await p.library.setDefault(e),await Y()}catch(e){E(e instanceof Error?e.message:`Failed to set default library`)}},de=async e=>{try{if(E(null),M(e),N(`preparing`),!await c({title:`Start Library Scan?`,message:`Found ${(await p.library.preview(e,{recursive:!0})).file_count.toLocaleString()} audio files. Start scan?`}))return;N(`queueing`);let t=await p.library.scan(e,{recursive:!0,force:!1,cleanMissing:!0});a(`Scan ${t.status}: ${t.message||`Library scan queued`}`),await Y()}catch(e){E(e instanceof Error?e.message:`Failed to scan library`)}finally{M(null),N(null)}},fe=async(e,t,n)=>{if(n){E(`Cannot delete the default library. Set another library as default first.`);return}if(await c({title:`Delete Library?`,message:`Delete library "${t}"?\n\nThis will remove the library entry but will NOT delete files on disk.`,severity:`warning`}))try{E(null),await p.library.delete(e),await Y()}catch(e){E(e instanceof Error?e.message:`Failed to delete library`)}},$=D||k!==null;return(0,b.jsxs)(e,{spacing:2.5,children:[(0,b.jsxs)(e,{direction:`row`,justifyContent:`space-between`,alignItems:`center`,children:[(0,b.jsx)(s,{variant:`h5`,children:`Libraries`}),!$&&(0,b.jsx)(u,{variant:`contained`,onClick:oe,children:`+ Add Library`})]}),T&&(0,b.jsx)(m,{children:T}),$&&(0,b.jsxs)(f,{children:[(0,b.jsx)(h,{title:D?`Create Library`:`Edit Library`}),(0,b.jsxs)(e,{spacing:2,children:[(0,b.jsxs)(o,{children:[(0,b.jsx)(s,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Name`}),(0,b.jsx)(t,{value:F,onChange:e=>I(e.target.value),placeholder:`My Music Library`,fullWidth:!0})]}),(0,b.jsxs)(o,{children:[(0,b.jsx)(s,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Root Path`}),(0,b.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,b.jsx)(t,{value:L,onChange:e=>R(e.target.value),placeholder:`/music`,fullWidth:!0}),(0,b.jsx)(u,{variant:`outlined`,onClick:()=>W(!U),sx:{minWidth:120},children:U?`Hide Picker`:`Browse...`})]}),U&&(0,b.jsx)(o,{sx:{mt:1.25,p:2,bgcolor:`background.default`,borderRadius:1,border:1,borderColor:`divider`},children:(0,b.jsx)(ne,{value:L,onChange:e=>{R(e),W(!1)},mode:`directory`,label:`Select Library Root Directory`})})]}),(0,b.jsx)(i,{control:(0,b.jsx)(r,{checked:z,onChange:e=>B(e.target.checked)}),label:`Enabled`}),(0,b.jsx)(i,{control:(0,b.jsx)(r,{checked:V,onChange:e=>H(e.target.checked)}),label:`Default Library`}),k!==null&&(0,b.jsxs)(o,{children:[(0,b.jsx)(u,{variant:`outlined`,onClick:ce,disabled:!L.trim()||q,children:q?`Checking...`:`Preview File Count`}),G!==null&&(0,b.jsx)(o,{sx:{mt:1,p:1.5,bgcolor:`background.paper`,borderRadius:1,border:1,borderColor:`divider`},children:(0,b.jsxs)(s,{children:[(0,b.jsx)(`strong`,{children:G.toLocaleString()}),` audio files found`]})})]}),(0,b.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,b.jsx)(u,{variant:`contained`,onClick:D?le:ue,children:D?`Create`:`Update`}),(0,b.jsx)(u,{variant:`outlined`,onClick:Z,children:`Cancel`})]})]})]}),C&&(0,b.jsx)(s,{children:`Loading libraries...`}),!C&&!$&&x.length===0&&(0,b.jsx)(f,{children:(0,b.jsx)(s,{color:`text.secondary`,textAlign:`center`,fontStyle:`italic`,children:`No libraries configured. Click "Add Library" to get started.`})}),!C&&!$&&x.length>0&&(0,b.jsx)(e,{spacing:2,children:x.map(t=>(0,b.jsxs)(f,{children:[(0,b.jsxs)(e,{direction:`row`,justifyContent:`space-between`,alignItems:`flex-start`,sx:{mb:2},children:[(0,b.jsxs)(o,{children:[(0,b.jsxs)(e,{direction:`row`,alignItems:`center`,spacing:1.25,sx:{mb:.5},children:[(0,b.jsx)(s,{variant:`h6`,children:t.name}),t.isDefault&&(0,b.jsx)(n,{label:`Default`,color:`primary`,size:`small`}),X(t.rootPath)&&(0,b.jsx)(n,{label:`Outside library_root`,color:`warning`,size:`small`})]}),(0,b.jsx)(s,{variant:`body2`,color:`text.secondary`,sx:{fontFamily:`monospace`},children:t.rootPath}),X(t.rootPath)&&(0,b.jsxs)(s,{variant:`caption`,color:`warning.main`,sx:{mt:.5},children:[`âš  This library is outside the configured library_root (`,P,`)`]})]}),(0,b.jsxs)(e,{direction:`row`,alignItems:`center`,spacing:1,children:[(0,b.jsx)(o,{sx:{width:8,height:8,borderRadius:`50%`,bgcolor:t.isEnabled?`success.main`:`text.disabled`}}),(0,b.jsx)(s,{variant:`body2`,color:`text.secondary`,children:t.isEnabled?`Enabled`:`Disabled`})]})]}),(0,b.jsxs)(e,{direction:`row`,spacing:1.25,flexWrap:`wrap`,children:[(0,b.jsx)(u,{variant:`outlined`,size:`small`,onClick:()=>se(t),disabled:j===t.id,children:`Edit`}),!t.isDefault&&(0,b.jsx)(u,{variant:`outlined`,size:`small`,onClick:()=>Q(t.id),disabled:j===t.id,children:`Set Default`}),(0,b.jsx)(u,{variant:`contained`,color:`success`,size:`small`,onClick:()=>de(t.id),disabled:!t.isEnabled||j===t.id||X(t.rootPath),title:X(t.rootPath)?`Cannot scan: library is outside library_root`:void 0,children:j===t.id?re===`preparing`?`Preparing...`:`Queueing...`:`Scan`}),(0,b.jsx)(u,{variant:`contained`,color:`error`,size:`small`,onClick:()=>fe(t.id,t.name,t.isDefault),disabled:j===t.id,children:`Delete`})]})]},t.id))}),(0,b.jsx)(ee,{open:l,title:d.title,message:d.message,confirmLabel:d.confirmLabel,cancelLabel:d.cancelLabel,severity:d.severity,onConfirm:g,onCancel:_})]})}function S({stats:e}){let t=[{label:`Total Files`,value:e.total_files},{label:`Artists`,value:e.unique_artists},{label:`Albums`,value:e.unique_albums},{label:`Total Duration`,value:(e=>`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m`)(e.total_duration_seconds)}];return(0,b.jsxs)(f,{children:[(0,b.jsx)(h,{title:`Library Statistics`}),(0,b.jsx)(_,{minColumnWidth:200,children:t.map(e=>(0,b.jsx)(d,{label:e.label,value:e.value},e.label))})]})}function C(){let[e,t]=(0,y.useState)(null),[n,r]=(0,y.useState)(!0),[i,a]=(0,y.useState)(null),o=async()=>{try{r(!0),a(null),t(await p.library.getStats())}catch(e){a(e instanceof Error?e.message:`Failed to load stats`),console.error(`[Library] Load error:`,e)}finally{r(!1)}};return(0,y.useEffect)(()=>{o()},[]),{stats:e,loading:n,error:i}}function w(){let{stats:t,loading:n,error:r}=C();return(0,b.jsxs)(g,{title:`Library Management`,children:[n&&(0,b.jsx)(s,{children:`Loading library statistics...`}),r&&(0,b.jsxs)(m,{children:[`Error: `,r]}),t&&(0,b.jsxs)(e,{spacing:2.5,children:[(0,b.jsx)(S,{stats:t}),(0,b.jsx)(f,{children:(0,b.jsx)(x,{})})]})]})}export{w as LibraryPage};