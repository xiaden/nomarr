import{t as e}from"./Stack-BbgDuISQ.js";import{t}from"./TextField-BdnHjbz6.js";import{t as n}from"./Chip-BzIgRRXN.js";import{a as r,i,n as a,r as o,t as s}from"./TableRow-BGc9-bg_.js";import{G as c,Gt as l,H as u,L as d,M as f,N as p,P as m,Q as h,R as g,W as _,Z as v,at as y,c as b,en as x,i as S,n as C,r as w,rt as T,s as E,t as D,tn as O,tt as k,wt as A,z as j}from"./index-BjSBR8oR.js";import{t as M}from"./useNotification-BL6VcleN.js";var N=O(x(),1),P=O(l()),F=A((0,P.jsx)(`path`,{d:`M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z`}),`Close`);function I({data:t}){return(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Mood Distribution`}),(0,P.jsx)(e,{spacing:1.25,children:t.map(e=>(0,P.jsx)(u,{label:e.mood,value:e.count,percentage:e.percentage},e.mood))})]})}function L({value:e,onChange:n,options:r,placeholder:i=`Type or select...`,disabled:a=!1,...o}){let[s,c]=(0,N.useState)(!1),[l,u]=(0,N.useState)(r),d=(0,N.useRef)(null);(0,N.useEffect)(()=>{u(e?r.filter(t=>t.toLowerCase().includes(e.toLowerCase())):r)},[e,r]),(0,N.useEffect)(()=>{let e=e=>{d.current&&!d.current.contains(e.target)&&c(!1)};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)},[]);let f=e=>{n(e.target.value),c(!0)},p=e=>{n(e),c(!1)};return(0,P.jsxs)(h,{...o,ref:d,sx:{position:`relative`,...o.sx},children:[(0,P.jsx)(t,{type:`text`,value:e,onChange:f,onFocus:()=>c(!0),placeholder:i,disabled:a,fullWidth:!0,size:`small`,sx:{"& .MuiOutlinedInput-root":{bgcolor:a?`background.paper`:`background.default`}}}),s&&!a&&l.length>0&&(0,P.jsx)(h,{sx:{position:`absolute`,top:`100%`,left:0,right:0,maxHeight:`200px`,overflowY:`auto`,bgcolor:`background.default`,border:1,borderColor:`divider`,borderTop:`none`,borderRadius:`0 0 4px 4px`,boxShadow:2,zIndex:1e3},children:l.map((e,t)=>(0,P.jsx)(h,{onClick:()=>p(e),sx:{p:1.5,cursor:`pointer`,fontSize:`0.875rem`,borderBottom:t<l.length-1?1:`none`,borderColor:`divider`,"&:hover":{bgcolor:`action.hover`}},children:e},t))})]})}function R(){let[t,l]=(0,N.useState)([]),[u,d]=(0,N.useState)([]),[f,m]=(0,N.useState)(``),[g,y]=(0,N.useState)(``),[x,S]=(0,N.useState)([]),[C,w]=(0,N.useState)([]),[T,D]=(0,N.useState)(null),[O,A]=(0,N.useState)(!1),[j,M]=(0,N.useState)(null);(0,N.useEffect)(()=>{I()},[]),(0,N.useEffect)(()=>{f?R(f):(d([]),y(``))},[f]);let I=async()=>{try{l((await E(!0)).tag_keys)}catch(e){console.error(`[TagCoOccurrence] Failed to load tag keys:`,e)}},R=async e=>{try{let t=await b(e,!0),n=new Set;for(let e of t.tag_keys)if(e.startsWith(`[`)&&e.endsWith(`]`))try{let t=JSON.parse(e);Array.isArray(t)?t.forEach(e=>n.add(String(e))):n.add(e)}catch{n.add(e)}else n.add(e);d(Array.from(n).sort())}catch(e){console.error(`[TagCoOccurrence] Failed to load tag values:`,e),d([])}},z=(e,t)=>x.some(n=>n.key===e&&n.value===t)||C.some(n=>n.key===e&&n.value===t),B=()=>{f&&g&&!x.some(e=>e.key===f&&e.value===g)&&x.length<16&&S([...x,{key:f,value:g}])},V=()=>{f&&g&&!C.some(e=>e.key===f&&e.value===g)&&C.length<16&&w([...C,{key:f,value:g}])},H=e=>{S(x.filter((t,n)=>n!==e))},U=e=>{w(C.filter((t,n)=>n!==e))},W=async()=>{if(x.length===0||C.length===0){M(`Both X and Y axes must have at least one tag`);return}try{A(!0),M(null),D(await p({x,y:C}))}catch(e){M(e instanceof Error?e.message:`Failed to build matrix`),console.error(`[TagCoOccurrence] Matrix build error:`,e)}finally{A(!1)}},G=(e,t)=>{if(e===0)return`#1a1a1a`;let n=Math.min(e/t,1);return`rgb(${Math.floor(30+n*44)}, ${Math.floor(30+n*128)}, ${Math.floor(30+n*225)})`},K=T?.matrix?Math.max(...T.matrix.flat(),1):1;return(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Tag Co-Occurrence Matrix`}),(0,P.jsxs)(e,{spacing:2,sx:{mb:2.5},children:[(0,P.jsxs)(h,{sx:{display:`flex`,gap:1.5,alignItems:`flex-end`},children:[(0,P.jsxs)(h,{sx:{flex:1},children:[(0,P.jsx)(k,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Key`}),(0,P.jsx)(L,{value:f,onChange:m,options:t,placeholder:`Select tag key...`})]}),(0,P.jsxs)(h,{sx:{flex:1},children:[(0,P.jsx)(k,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Value`}),(0,P.jsx)(L,{value:g,onChange:y,options:u,placeholder:`Select tag value...`,disabled:!f})]}),(0,P.jsx)(v,{onClick:B,disabled:!f||!g||x.length>=16||z(f,g),variant:`contained`,size:`small`,children:`Add to X`}),(0,P.jsx)(v,{onClick:V,disabled:!f||!g||C.length>=16||z(f,g),variant:`contained`,color:`secondary`,size:`small`,children:`Add to Y`})]}),(0,P.jsxs)(h,{children:[(0,P.jsxs)(k,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`X Axis (`,x.length,`/16)`]}),(0,P.jsxs)(h,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[x.length===0&&(0,P.jsx)(k,{variant:`body2`,color:`text.secondary`,children:`No tags added to X axis yet`}),x.map((e,t)=>(0,P.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>H(t),deleteIcon:(0,P.jsx)(F,{}),size:`small`},t))]})]}),(0,P.jsxs)(h,{children:[(0,P.jsxs)(k,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`Y Axis (`,C.length,`/16)`]}),(0,P.jsxs)(h,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[C.length===0&&(0,P.jsx)(k,{variant:`body2`,color:`text.secondary`,children:`No tags added to Y axis yet`}),C.map((e,t)=>(0,P.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>U(t),deleteIcon:(0,P.jsx)(F,{}),size:`small`},t))]})]}),(0,P.jsx)(v,{onClick:W,disabled:O||x.length===0||C.length===0,variant:`contained`,fullWidth:!0,children:O?`Building Matrix...`:`Build Matrix`})]}),j&&(0,P.jsx)(k,{color:`error`,sx:{mb:2},children:j}),T&&(0,P.jsx)(h,{sx:{overflowX:`auto`,mt:2.5},children:(0,P.jsxs)(r,{size:`small`,sx:{minWidth:300},children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Y \\ X`}),T.x.map((e,t)=>(0,P.jsxs)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:[e.key,`:`,(0,P.jsx)(`br`,{}),e.value]},t))]})}),(0,P.jsx)(i,{children:T.y.map((e,t)=>(0,P.jsxs)(s,{children:[(0,P.jsxs)(o,{sx:{borderColor:`divider`,fontWeight:600},children:[e.key,`: `,e.value]}),T.x.map((e,n)=>(0,P.jsx)(o,{align:`center`,sx:{borderColor:`divider`,bgcolor:G(T.matrix[t][n],K),fontWeight:T.matrix[t][n]>0?600:`normal`},children:T.matrix[t][n]},n))]},t))})]})})]})}function z({data:e,limit:t=50}){return(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Tag Frequencies (Top ${t})`}),(0,P.jsx)(h,{sx:{maxHeight:600,overflowY:`auto`,overflowX:`auto`},children:(0,P.jsxs)(r,{sx:{minWidth:300},children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Tag`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Count`})]})}),(0,P.jsx)(i,{children:e.map(e=>(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.tag_key}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.total_count})]},e.tag_key))})]})})]})}function B(){let[e,t]=(0,N.useState)({tagFrequencies:[],moodDistribution:[]}),[n,r]=(0,N.useState)(!0),[i,a]=(0,N.useState)(null);return(0,N.useEffect)(()=>{(async()=>{try{r(!0),a(null);let[e,n]=await Promise.all([m(50),f()]);t({tagFrequencies:e.tag_frequencies,moodDistribution:n.mood_distribution})}catch(e){a(e instanceof Error?e.message:`Failed to load analytics`),console.error(`[Analytics] Load error:`,e)}finally{r(!1)}})()},[]),{data:e,loading:n,error:i}}function V(){let{data:t,loading:n,error:r}=B();return(0,P.jsxs)(P.Fragment,{children:[n&&(0,P.jsx)(y,{}),r&&(0,P.jsxs)(T,{severity:`error`,children:[`Error: `,r]}),!n&&!r&&(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsx)(I,{data:t.moodDistribution}),(0,P.jsx)(z,{data:t.tagFrequencies}),(0,P.jsx)(R,{})]})]})}function H({preview:n,configText:l,loading:u,error:f,onLoadPreview:p,onGenerateConfig:m}){let{showSuccess:g}=M();return(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Navidrome TOML Configuration`}),(0,P.jsxs)(e,{spacing:1.25,children:[(0,P.jsx)(v,{onClick:p,disabled:u,variant:`contained`,fullWidth:!0,children:u?`Loading...`:`Load Tag Preview`}),(0,P.jsx)(v,{onClick:m,disabled:u,variant:`contained`,fullWidth:!0,children:u?`Generating...`:`Generate Config`})]}),f&&(0,P.jsxs)(d,{children:[`Error: `,f]})]}),n&&(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Tag Preview`}),(0,P.jsx)(h,{sx:{overflowX:`auto`},children:(0,P.jsxs)(r,{children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Tag`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Type`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Multivalue`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Count`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Summary`})]})}),(0,P.jsx)(i,{children:n.map(e=>(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.tag_key}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.type}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.is_multivalue?`Yes`:`No`}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.total_count}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.summary})]},e.tag_key))})]})})]}),l&&(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Generated Config`}),(0,P.jsx)(t,{multiline:!0,rows:20,value:l,fullWidth:!0,InputProps:{readOnly:!0,sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}}),(0,P.jsx)(v,{onClick:()=>{l&&(navigator.clipboard.writeText(l),g(`Copied to clipboard!`))},variant:`contained`,sx:{mt:1.25},children:`Copy to Clipboard`})]})]})}function U({query:n,name:r,comment:i,limit:a,sort:o,preview:s,content:l,loading:u,error:f,onQueryChange:p,onNameChange:m,onCommentChange:g,onLimitChange:y,onSortChange:b,onPreview:x,onGenerate:S}){return(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Smart Playlist Generator`}),(0,P.jsx)(h,{component:`form`,onSubmit:x,children:(0,P.jsxs)(e,{spacing:2,children:[(0,P.jsxs)(h,{children:[(0,P.jsx)(k,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Query *`}),(0,P.jsx)(t,{value:n,onChange:e=>p(e.target.value),placeholder:`e.g., tag:nom_happy > 0.8`,multiline:!0,rows:3,disabled:u,required:!0,fullWidth:!0,InputProps:{sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}})]}),(0,P.jsxs)(h,{children:[(0,P.jsx)(k,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Playlist Name *`}),(0,P.jsx)(t,{value:r,onChange:e=>m(e.target.value),disabled:u,required:!0,fullWidth:!0})]}),(0,P.jsxs)(h,{children:[(0,P.jsx)(k,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Comment`}),(0,P.jsx)(t,{value:i,onChange:e=>g(e.target.value),disabled:u,fullWidth:!0})]}),(0,P.jsxs)(h,{sx:{display:`grid`,gridTemplateColumns:`1fr 1fr`,gap:1.25},children:[(0,P.jsxs)(h,{children:[(0,P.jsx)(k,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Limit`}),(0,P.jsx)(t,{type:`number`,value:a??``,onChange:e=>y(e.target.value?parseInt(e.target.value):void 0),disabled:u,placeholder:`Optional`,fullWidth:!0})]}),(0,P.jsxs)(h,{children:[(0,P.jsx)(k,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Sort`}),(0,P.jsx)(t,{value:o,onChange:e=>b(e.target.value),disabled:u,placeholder:`Optional`,fullWidth:!0})]})]}),(0,P.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,P.jsx)(v,{type:`submit`,variant:`contained`,disabled:u,fullWidth:!0,children:u?`Loading...`:`Preview Query`}),(0,P.jsx)(v,{type:`button`,onClick:S,variant:`contained`,disabled:u,fullWidth:!0,children:u?`Generating...`:`Generate .nsp`})]})]})}),f&&(0,P.jsxs)(d,{children:[`Error: `,f]})]}),s&&(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Query Preview`}),(0,P.jsx)(h,{component:`pre`,sx:{p:2,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,overflow:`auto`,fontSize:`0.875rem`,fontFamily:`monospace`},children:JSON.stringify(s,null,2)})]}),l&&(0,P.jsxs)(c,{children:[(0,P.jsx)(_,{title:`Generated Playlist (.nsp)`}),(0,P.jsx)(t,{multiline:!0,rows:15,value:l,fullWidth:!0,InputProps:{readOnly:!0,sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}}),(0,P.jsx)(v,{onClick:()=>{if(l){let e=new Blob([l],{type:`text/plain`}),t=URL.createObjectURL(e),n=document.createElement(`a`);n.href=t,n.download=`${r}.nsp`,n.click(),URL.revokeObjectURL(t)}},variant:`contained`,sx:{mt:1.25},children:`Download .nsp File`})]})]})}function W(){let{showError:e}=M(),[t,n]=(0,N.useState)(null),[r,i]=(0,N.useState)(null),[a,o]=(0,N.useState)(!1),[s,c]=(0,N.useState)(null),[l,u]=(0,N.useState)(``),[d,f]=(0,N.useState)(`My Playlist`),[p,m]=(0,N.useState)(``),[h,g]=(0,N.useState)(void 0),[_,v]=(0,N.useState)(``),[y,b]=(0,N.useState)(null),[x,T]=(0,N.useState)(null),[E,O]=(0,N.useState)(!1),[k,A]=(0,N.useState)(null);return{configPreview:t,configText:r,configLoading:a,configError:s,playlistQuery:l,playlistName:d,playlistComment:p,playlistLimit:h,playlistSort:_,playlistPreview:y,playlistContent:x,playlistLoading:E,playlistError:k,loadConfigPreview:async()=>{try{o(!0),c(null),n((await w()).tags)}catch(e){c(e instanceof Error?e.message:`Failed to load preview`)}finally{o(!1)}},generateConfig:async()=>{try{o(!0),c(null),i((await C()).config)}catch(e){c(e instanceof Error?e.message:`Failed to generate config`)}finally{o(!1)}},previewPlaylist:async e=>{if(e.preventDefault(),l.trim())try{O(!0),A(null),b(await S(l,10))}catch(e){A(e instanceof Error?e.message:`Failed to preview playlist`)}finally{O(!1)}},generatePlaylist:async()=>{if(!l.trim()){e(`Query is required`);return}if(!d.trim()){e(`Playlist name is required`);return}try{O(!0),A(null),T((await D({query:l,playlist_name:d,comment:p,limit:h,sort:_||void 0})).content)}catch(e){A(e instanceof Error?e.message:`Failed to generate playlist`)}finally{O(!1)}},setPlaylistQuery:u,setPlaylistName:f,setPlaylistComment:m,setPlaylistLimit:g,setPlaylistSort:v}}function G(){let[e,t]=(0,N.useState)(`config`),{configPreview:n,configText:r,configLoading:i,configError:a,playlistQuery:o,playlistName:s,playlistComment:c,playlistLimit:l,playlistSort:u,playlistPreview:d,playlistContent:f,playlistLoading:p,playlistError:m,loadConfigPreview:h,generateConfig:g,previewPlaylist:_,generatePlaylist:v,setPlaylistQuery:y,setPlaylistName:b,setPlaylistComment:x,setPlaylistLimit:S,setPlaylistSort:C}=W();return(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(j,{tabs:[{id:`config`,label:`Config Generator`},{id:`playlist`,label:`Playlist Generator`}],activeTab:e,onTabChange:e=>t(e)}),e===`config`&&(0,P.jsx)(H,{preview:n,configText:r,loading:i,error:a,onLoadPreview:h,onGenerateConfig:g}),e===`playlist`&&(0,P.jsx)(U,{query:o,name:s,comment:c,limit:l,sort:u,preview:d,content:f,loading:p,error:m,onQueryChange:y,onNameChange:b,onCommentChange:x,onLimitChange:S,onSortChange:C,onPreview:_,onGenerate:v})]})}function K(){let[e,t]=(0,N.useState)(`analytics`);return(0,P.jsxs)(g,{title:`Insights`,children:[(0,P.jsx)(j,{tabs:[{id:`analytics`,label:`Analytics`},{id:`navidrome`,label:`Navidrome Integration`}],activeTab:e,onTabChange:e=>t(e)}),e===`analytics`&&(0,P.jsx)(V,{}),e===`navidrome`&&(0,P.jsx)(G,{})]})}export{K as InsightsPage};