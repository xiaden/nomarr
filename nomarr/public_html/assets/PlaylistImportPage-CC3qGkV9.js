import{o as e,t}from"./Stack-Dqc_OHrj.js";import{_ as n,a as r,h as i,i as a,m as o,n as s,s as c,t as l}from"./ExpandMore-DA-OfDm_.js";import"./Popper-B8oBepA5.js";import{t as u}from"./Chip-C1mpDQMp.js";import{t as d}from"./TextField-f-cKSbKE.js";import{n as f,t as p}from"./MusicNote-DHiqCkwi.js";import{n as m,t as h}from"./Search-CqrHGSrW.js";import{t as g}from"./Tooltip-m_wt5yYP.js";import{a as _,i as v,n as y,r as b,t as x}from"./TableRow-DDNBpb5G.js";import{t as S}from"./TableContainer-DlDr-0TV.js";import{$t as C,Cn as w,Ct as T,Dt as E,In as D,Jt as O,K as k,Pn as A,St as j,Xt as M,Yt as N,Z as P,_n as F,bt as I,cn as ee,ct as L,f as R,ht as z,lt as te,mt as B,ot as ne,q as re,tn as ie,ut as ae,vn as V,vt as H,y as U,yn as W}from"./index-CxzRfZt4.js";import{t as G}from"./Add-BO1lMMzJ.js";import{t as K}from"./Close-DqKW9tfe.js";function q(e){return V(`MuiInputAdornment`,e)}var J=F(`MuiInputAdornment`,[`root`,`filled`,`standard`,`outlined`,`positionStart`,`positionEnd`,`disablePointerEvents`,`hiddenLabel`,`sizeSmall`]),Y=D(A()),X=D(w()),oe,se=(e,t)=>{let{ownerState:n}=e;return[t.root,t[`position${M(n.position)}`],n.disablePointerEvents===!0&&t.disablePointerEvents,t[n.variant]]},ce=e=>{let{classes:t,disablePointerEvents:n,hiddenLabel:r,position:i,size:a,variant:o}=e;return ee({root:[`root`,n&&`disablePointerEvents`,i&&`position${M(i)}`,o,r&&`hiddenLabel`,a&&`size${M(a)}`]},q,t)},le=ie(`div`,{name:`MuiInputAdornment`,slot:`Root`,overridesResolver:se})(N(({theme:e})=>({display:`flex`,maxHeight:`2em`,alignItems:`center`,whiteSpace:`nowrap`,color:(e.vars||e).palette.action.active,variants:[{props:{variant:`filled`},style:{[`&.${J.positionStart}&:not(.${J.hiddenLabel})`]:{marginTop:16}}},{props:{position:`start`},style:{marginRight:8}},{props:{position:`end`},style:{marginLeft:8}},{props:{disablePointerEvents:!0},style:{pointerEvents:`none`}}]}))),Z=Y.forwardRef(function(e,t){let n=C({props:e,name:`MuiInputAdornment`}),{children:r,className:a,component:s=`div`,disablePointerEvents:c=!1,disableTypography:l=!1,position:u,variant:d,...f}=n,p=o()||{},m=d;d&&p.variant,p&&!m&&(m=p.variant);let h={...n,hiddenLabel:p.hiddenLabel,size:p.size,disablePointerEvents:c,position:u,variant:m},g=ce(h);return(0,X.jsx)(i.Provider,{value:null,children:(0,X.jsx)(le,{as:s,ownerState:h,className:W(g.root,a),ref:t,...f,children:typeof r==`string`&&!l?(0,X.jsx)(H,{color:`textSecondary`,children:r}):(0,X.jsxs)(Y.Fragment,{children:[u===`start`?oe||=(0,X.jsx)(`span`,{className:`notranslate`,"aria-hidden":!0,children:`​`}):null,r]})})})}),ue=O((0,X.jsx)(`path`,{d:`M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z`}),`CheckCircle`),de=O((0,X.jsx)(`path`,{d:`M19 2h-4.18C14.4.84 13.3 0 12 0S9.6.84 9.18 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1m7 18H5V4h2v3h10V4h2z`}),`ContentPaste`),fe=O((0,X.jsx)(`path`,{d:`M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z`}),`Download`),pe=O((0,X.jsx)(`path`,{d:`m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z`}),`ExpandLess`),me=O((0,X.jsx)(`path`,{d:`M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4`}),`HelpOutline`),he=O((0,X.jsx)(`path`,{d:`M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5m0-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8`}),`RadioButtonChecked`),ge=O((0,X.jsx)(`path`,{d:`M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8`}),`RadioButtonUnchecked`),_e=O((0,X.jsx)(`path`,{d:`M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8`}),`Undo`);function ve(e){switch(e){case`exact_isrc`:return`isrc`;case`exact_metadata`:return`exact`;case`fuzzy`:return`fuzzy_high`;case`ambiguous`:return`fuzzy_low`;case`not_found`:return`none`}}async function ye(e){return re(`/api/web/playlist-import/convert`,e)}async function be(){return k(`/api/web/playlist-import/spotify-status`)}function xe({open:t,onClose:n,onSelect:r,initialQuery:i=``,title:a=`Search Library`}){let[o,s]=(0,Y.useState)(i),[c,l]=(0,Y.useState)([]),[u,p]=(0,Y.useState)(!1),[g,_]=(0,Y.useState)(null),v=(0,Y.useRef)(null),y=(0,Y.useCallback)(async e=>{if(!e.trim()){l([]);return}p(!0);try{l((await R({q:e.trim(),limit:20})).files.map(e=>({path:e.path,file_id:e.file_id,title:e.title??``,artist:e.artist??``,album:e.album??null})))}finally{p(!1)}},[]),b=(0,Y.useCallback)(e=>{s(e),_(null),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>y(e),300)},[y]),x=(0,Y.useCallback)(()=>{g&&(r(g),n())},[g,r,n]);return(0,X.jsxs)(ae,{open:t,onClose:n,maxWidth:`sm`,fullWidth:!0,TransitionProps:{onEntered:(0,Y.useCallback)(()=>{s(i),_(null),l([]),i&&y(i)},[i,y])},children:[(0,X.jsx)(ne,{children:a}),(0,X.jsxs)(L,{children:[(0,X.jsx)(d,{autoFocus:!0,fullWidth:!0,size:`small`,placeholder:`Search by title, artist, or album...`,value:o,onChange:e=>b(e.target.value),sx:{mt:1,mb:2},slotProps:{input:{startAdornment:(0,X.jsx)(Z,{position:`start`,children:(0,X.jsx)(h,{fontSize:`small`})}),endAdornment:u?(0,X.jsx)(Z,{position:`end`,children:(0,X.jsx)(T,{size:18})}):void 0}}}),c.length===0&&!u&&o.trim()&&(0,X.jsx)(H,{variant:`body2`,color:`text.secondary`,sx:{py:2,textAlign:`center`},children:`No results found`}),(0,X.jsx)(e,{dense:!0,sx:{maxHeight:300,overflow:`auto`},children:c.map(e=>(0,X.jsx)(m,{selected:g?.file_id===e.file_id,onClick:()=>_(e),children:(0,X.jsx)(f,{primary:`${e.title||`Unknown`} — ${e.artist||`Unknown`}`,secondary:e.album||e.path})},e.file_id))})]}),(0,X.jsxs)(te,{children:[(0,X.jsx)(B,{onClick:n,children:`Cancel`}),(0,X.jsx)(B,{variant:`contained`,onClick:x,disabled:!g,children:`Select`})]})]})}var Q={isrc:`success`,exact:`success`,fuzzy_high:`info`,fuzzy_low:`warning`,none:`error`},Se={isrc:`ISRC`,exact:`Exact`,fuzzy_high:`Fuzzy`,fuzzy_low:`Ambiguous`,none:`Not Found`};function Ce(e){switch(e){case`exact_isrc`:case`exact_metadata`:case`fuzzy`:return(0,X.jsx)(ue,{fontSize:`small`,color:`success`});case`ambiguous`:return(0,X.jsx)(me,{fontSize:`small`,color:`warning`});case`not_found`:return(0,X.jsx)(K,{fontSize:`small`,color:`error`})}}function we(e){if(!e)return`—`;let t=[e.title||`Unknown`];return e.artist&&t.push(e.artist),t.join(` — `)}function Te({result:e}){let[r,i]=(0,Y.useState)(e.all_matches),[a,o]=(0,Y.useState)({}),[s,c]=(0,Y.useState)({}),[d,f]=(0,Y.useState)(!1),[p,m]=(0,Y.useState)(null),[C,w]=(0,Y.useState)(``),T=(0,Y.useCallback)(e=>a[e]??{selectedFile:null,removed:!1},[a]),E=(0,Y.useCallback)((e,t)=>{o(n=>({...n,[e]:{...n[e]??{selectedFile:null,removed:!1},...t}}))},[]),D=(0,Y.useCallback)(e=>{c(t=>({...t,[e]:!t[e]}))},[]),O=(0,Y.useCallback)((e,t)=>{let n=T(e);return n.selectedFile===null?t.matched_file:n.selectedFile},[T]),k=(0,Y.useCallback)(e=>{m({idx:e,mode:`pick`}),w(``),f(!0)},[]),A=(0,Y.useCallback)(()=>{m({idx:-1,mode:`add`}),w(``),f(!0)},[]),M=(0,Y.useCallback)(e=>{if(p)if(p.mode===`pick`)E(p.idx,{selectedFile:e});else{let t={input_track:{title:e.title,artist:e.artist,album:e.album,isrc:null,position:r.length},status:`exact_metadata`,confidence:1,matched_file:e,alternatives:[]};i(e=>[...e,t])}},[p,E,r.length]),N=(0,Y.useCallback)(()=>{let t=[`#EXTM3U`,`#PLAYLIST:${e.playlist_metadata.name}`];for(let e=0;e<r.length;e++){let n=r[e];if(T(e).removed)continue;let i=O(e,n);if(!i)continue;let a=i.artist||n.input_track.artist,o=i.title||n.input_track.title;t.push(`#EXTINF:-1,${a} - ${o}`),t.push(i.path)}let n=new Blob([t.join(`
`)],{type:`audio/x-mpegurl`}),i=URL.createObjectURL(n),a=document.createElement(`a`);a.href=i,a.download=`${e.playlist_metadata.name}.m3u`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)},[r,T,O,e.playlist_metadata.name]),P=(0,Y.useMemo)(()=>{let e=0,t=0,n=0;for(let i=0;i<r.length;i++){let a=T(i);if(a.removed){t++;continue}O(i,r[i])&&e++,a.selectedFile!==null&&n++}return{included:e,removed:t,modified:n,total:r.length}},[r,T,O]);return(0,X.jsxs)(t,{spacing:2,children:[(0,X.jsxs)(z,{sx:{display:`flex`,justifyContent:`space-between`,alignItems:`center`},children:[(0,X.jsxs)(z,{children:[(0,X.jsx)(H,{variant:`h6`,children:e.playlist_metadata.name}),(0,X.jsxs)(H,{variant:`body2`,color:`text.secondary`,children:[P.included,` of `,P.total,` tracks included`,P.removed>0&&` (${P.removed} removed)`,P.modified>0&&` (${P.modified} modified)`]})]}),(0,X.jsxs)(t,{direction:`row`,spacing:1,children:[(0,X.jsx)(B,{variant:`outlined`,startIcon:(0,X.jsx)(G,{}),onClick:A,children:`Add Track`}),(0,X.jsx)(B,{variant:`contained`,startIcon:(0,X.jsx)(fe,{}),onClick:N,disabled:P.included===0,children:`Generate M3U`})]})]}),(0,X.jsxs)(z,{sx:{display:`flex`,gap:1,flexWrap:`wrap`},children:[(0,X.jsx)(u,{label:`${e.exact_matches} exact`,color:`success`,variant:`outlined`,size:`small`}),e.fuzzy_matches>0&&(0,X.jsx)(u,{label:`${e.fuzzy_matches} fuzzy`,color:`info`,variant:`outlined`,size:`small`}),e.ambiguous_count>0&&(0,X.jsx)(u,{label:`${e.ambiguous_count} ambiguous`,color:`warning`,variant:`outlined`,size:`small`}),e.not_found_count>0&&(0,X.jsx)(u,{label:`${e.not_found_count} not found`,color:`error`,variant:`outlined`,size:`small`}),(0,X.jsx)(u,{label:`${Math.round(e.match_rate*100)}% matched`,variant:`outlined`,size:`small`})]}),(0,X.jsx)(S,{sx:{maxHeight:600},children:(0,X.jsxs)(_,{size:`small`,stickyHeader:!0,children:[(0,X.jsx)(y,{children:(0,X.jsxs)(x,{children:[(0,X.jsx)(b,{sx:{width:40},children:`#`}),(0,X.jsx)(b,{children:`Track`}),(0,X.jsx)(b,{children:`Artist`}),(0,X.jsx)(b,{children:`Album`}),(0,X.jsx)(b,{sx:{width:110},children:`Status`}),(0,X.jsx)(b,{children:`Matched File`}),(0,X.jsx)(b,{sx:{width:120},align:`right`,children:`Actions`})]})}),(0,X.jsx)(v,{children:r.map((e,t)=>{let r=T(t),i=ve(e.status),a=O(t,e),o=e.alternatives.length>0,c=s[t]??!1;return(0,X.jsxs)(X.Fragment,{children:[(0,X.jsxs)(x,{sx:{opacity:r.removed?.4:1,textDecoration:r.removed?`line-through`:`none`,bgcolor:r.selectedFile===null?void 0:`action.selected`},children:[(0,X.jsx)(b,{children:e.input_track.position}),(0,X.jsx)(b,{children:e.input_track.title}),(0,X.jsx)(b,{children:e.input_track.artist}),(0,X.jsx)(b,{children:e.input_track.album||`—`}),(0,X.jsx)(b,{children:(0,X.jsx)(u,{icon:Ce(e.status),label:Se[i],color:Q[i],size:`small`,variant:`outlined`})}),(0,X.jsx)(b,{sx:{maxWidth:280,overflow:`hidden`,textOverflow:`ellipsis`,whiteSpace:`nowrap`},children:(0,X.jsx)(g,{title:a?`${a.title} \u2014 ${a.artist}${a.album?` (${a.album})`:``}`:`No match`,placement:`top-start`,children:(0,X.jsx)(`span`,{children:we(a)})})}),(0,X.jsx)(b,{align:`right`,children:(0,X.jsxs)(z,{sx:{display:`flex`,justifyContent:`flex-end`,gap:.5},children:[(0,X.jsx)(g,{title:`Search & pick a match`,children:(0,X.jsx)(j,{size:`small`,onClick:()=>k(t),children:(0,X.jsx)(h,{fontSize:`small`})})}),o&&(0,X.jsx)(g,{title:c?`Collapse alternatives`:`Show alternatives`,children:(0,X.jsx)(j,{size:`small`,onClick:()=>D(t),children:c?(0,X.jsx)(pe,{fontSize:`small`}):(0,X.jsx)(l,{fontSize:`small`})})}),r.removed?(0,X.jsx)(g,{title:`Restore track`,children:(0,X.jsx)(j,{size:`small`,onClick:()=>E(t,{removed:!1}),children:(0,X.jsx)(_e,{fontSize:`small`})})}):(0,X.jsx)(g,{title:`Remove from playlist`,children:(0,X.jsx)(j,{size:`small`,onClick:()=>E(t,{removed:!0}),children:(0,X.jsx)(K,{fontSize:`small`})})})]})})]},t),o&&(0,X.jsx)(x,{children:(0,X.jsx)(b,{colSpan:7,sx:{py:0,borderBottom:c?void 0:`none`},children:(0,X.jsx)(n,{in:c,timeout:`auto`,unmountOnExit:!0,children:(0,X.jsxs)(z,{sx:{py:1,pl:4},children:[(0,X.jsx)(H,{variant:`caption`,color:`text.secondary`,sx:{mb:.5,display:`block`},children:`Choose alternative match:`}),e.matched_file&&(0,X.jsx)($,{file:e.matched_file,selected:a?.file_id===e.matched_file.file_id&&r.selectedFile===null,onSelect:()=>E(t,{selectedFile:null}),label:`(current)`}),e.alternatives.map(e=>(0,X.jsx)($,{file:e,selected:a?.file_id===e.file_id,onSelect:()=>E(t,{selectedFile:e})},e.file_id))]})})})},`${t}-alt`)]})})})]})}),(0,X.jsx)(xe,{open:d,onClose:()=>f(!1),onSelect:M,initialQuery:C,title:p?.mode===`add`?`Add Track from Library`:`Search & Pick Match`})]})}function $({file:e,selected:t,onSelect:n,label:r}){return(0,X.jsxs)(z,{onClick:n,sx:{display:`flex`,alignItems:`center`,gap:1,py:.5,px:1,cursor:`pointer`,borderRadius:1,"&:hover":{bgcolor:`action.hover`},bgcolor:t?`action.selected`:void 0},children:[t?(0,X.jsx)(he,{fontSize:`small`,color:`primary`}):(0,X.jsx)(ge,{fontSize:`small`,color:`disabled`}),(0,X.jsx)(g,{title:`${e.title} \u2014 ${e.artist}${e.album?` (${e.album})`:``}`,placement:`top-start`,children:(0,X.jsxs)(H,{variant:`body2`,noWrap:!0,sx:{maxWidth:500},children:[e.title||`Unknown`,` \\u2014 `,e.artist||`Unknown`,e.album&&(0,X.jsxs)(`em`,{children:[` (`,e.album,`)`]}),r&&(0,X.jsxs)(`em`,{children:[` `,r]})]})})]})}function Ee(){let[e,n]=(0,Y.useState)(``),[i,o]=(0,Y.useState)(``),[l,u]=(0,Y.useState)([]),[f,m]=(0,Y.useState)(null),[h,g]=(0,Y.useState)(!1),[_,v]=(0,Y.useState)(null),[y,b]=(0,Y.useState)(null);(0,Y.useEffect)(()=>{U().then(e=>{u(e),e.length>0&&o(e[0].library_id)}).catch(()=>u([])),be().then(e=>b(e.configured)).catch(()=>b(!1))},[]);let x=(0,Y.useCallback)(async()=>{if(!(!e.trim()||!i)){g(!0),v(null),m(null);try{m(await ye({playlist_url:e.trim(),library_id:i}))}catch(e){v(e instanceof Error?e.message:`Failed to convert playlist`)}finally{g(!1)}}},[e,i]),S=e.includes(`spotify`)&&y===!1;return(0,X.jsx)(P,{title:`Playlist Import`,children:(0,X.jsxs)(t,{spacing:3,children:[(0,X.jsx)(I,{severity:`info`,icon:(0,X.jsx)(p,{}),children:`Paste a Spotify or Deezer playlist URL to convert it to an M3U playlist by matching tracks against your local library.`}),y===!1&&(0,X.jsxs)(I,{severity:`warning`,children:[`Spotify credentials not configured. Add `,(0,X.jsx)(`code`,{children:`spotify_client_id`}),` and`,` `,(0,X.jsx)(`code`,{children:`spotify_client_secret`}),` to your config to enable Spotify playlists.`]}),(0,X.jsx)(E,{sx:{p:3},children:(0,X.jsxs)(t,{spacing:2,children:[(0,X.jsx)(d,{label:`Playlist URL`,placeholder:`https://open.spotify.com/playlist/... or https://deezer.com/playlist/...`,value:e,onChange:e=>n(e.target.value),fullWidth:!0,InputProps:{startAdornment:(0,X.jsx)(de,{sx:{mr:1,color:`text.secondary`}})}}),(0,X.jsxs)(c,{fullWidth:!0,children:[(0,X.jsx)(r,{children:`Library`}),(0,X.jsx)(s,{value:i,label:`Library`,onChange:e=>o(e.target.value),children:l.map(e=>(0,X.jsx)(a,{value:e.library_id,children:e.name},e.library_id))})]}),(0,X.jsx)(B,{variant:`contained`,onClick:x,disabled:!e.trim()||!i||h||S,startIcon:h?(0,X.jsx)(T,{size:20}):(0,X.jsx)(p,{}),children:h?`Converting...`:`Convert Playlist`})]})}),_&&(0,X.jsx)(I,{severity:`error`,children:_}),f&&(0,X.jsx)(E,{sx:{p:3},children:(0,X.jsx)(Te,{result:f})})]})})}export{Ee as PlaylistImportPage};