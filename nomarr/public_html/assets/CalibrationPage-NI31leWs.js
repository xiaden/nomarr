import{t as e}from"./Stack-BkrAveSq.js";import{a as t,i as n,n as r,r as i,t as a}from"./TableRow-HNQqFmno.js";import{$ as o,A as s,Ft as c,G as l,Ht as u,I as d,K as f,Kt as p,Ut as m,V as h,Vt as g,it as _,j as v,jt as y,k as b,kt as x,nn as S,nt as C,ot as w,tn as T,ut as E,z as D}from"./index-CIJKJslA.js";import{t as O}from"./useConfirmDialog-COc7KCwM.js";import{t as k}from"./useNotification-D3vM2qdR.js";function A(e){return u(`MuiTableContainer`,e)}g(`MuiTableContainer`,[`root`]);var j=S(T()),M=S(p()),N=e=>{let{classes:t}=e;return c({root:[`root`]},A,t)},P=y(`div`,{name:`MuiTableContainer`,slot:`Root`})({width:`100%`,overflowX:`auto`}),F=j.forwardRef(function(e,t){let n=x({props:e,name:`MuiTableContainer`}),{className:r,component:i=`div`,...a}=n,o={...n,component:i};return(0,M.jsx)(P,{ref:t,as:i,className:m(N(o).root,r),ownerState:o,...a})});function I({onGenerate:t,onApply:n,onUpdateFiles:r,actionLoading:i}){return(0,M.jsxs)(f,{children:[(0,M.jsx)(l,{title:`Actions`}),(0,M.jsx)(e,{spacing:2,children:[{label:`Generate New Calibration`,description:`Analyze all files in library to generate optimal calibration values. This will scan the entire library and may take some time.`,onClick:t,color:`primary`,variant:`contained`},{label:`Apply Calibration to Library`,description:`Queue all files for reprocessing with current calibration. This will update all tags based on the current calibration values.`,onClick:n,color:`primary`,variant:`contained`},{label:`Update Calibration Files`,description:`Download and import the latest calibration bundle files from the repository.`,onClick:r,color:`secondary`,variant:`outlined`}].map(e=>(0,M.jsx)(h,{label:e.label,description:e.description,onClick:e.onClick,disabled:i,variant:e.variant,color:e.color},e.label))})]})}function L({status:e}){let s=e.last_run?new Date(e.last_run*1e3).toLocaleString():`Never`;return(0,M.jsxs)(f,{children:[(0,M.jsx)(l,{title:`Calibration Status`}),(0,M.jsxs)(o,{sx:{mb:3},children:[(0,M.jsxs)(C,{variant:`body2`,color:`text.secondary`,children:[(0,M.jsx)(`strong`,{children:`Global Version:`}),` `,e.global_version||`Not calibrated`]}),(0,M.jsxs)(C,{variant:`body2`,color:`text.secondary`,children:[(0,M.jsx)(`strong`,{children:`Last Run:`}),` `,s]})]}),e.libraries.length>0?(0,M.jsx)(F,{component:E,variant:`outlined`,children:(0,M.jsxs)(t,{size:`small`,children:[(0,M.jsx)(r,{children:(0,M.jsxs)(a,{children:[(0,M.jsx)(i,{children:`Library`}),(0,M.jsx)(i,{align:`right`,children:`Total Files`}),(0,M.jsx)(i,{align:`right`,children:`Current`}),(0,M.jsx)(i,{align:`right`,children:`Outdated`}),(0,M.jsx)(i,{align:`right`,children:`Calibration %`})]})}),(0,M.jsx)(n,{children:e.libraries.map(e=>(0,M.jsxs)(a,{children:[(0,M.jsx)(i,{children:e.library_name}),(0,M.jsx)(i,{align:`right`,children:e.total_files.toLocaleString()}),(0,M.jsx)(i,{align:`right`,children:e.current_count.toLocaleString()}),(0,M.jsx)(i,{align:`right`,children:e.outdated_count.toLocaleString()}),(0,M.jsxs)(i,{align:`right`,children:[e.percentage.toFixed(1),`%`]})]},e.library_id))})]})}):(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,children:`No libraries found.`})]})}function R(){let{showSuccess:e,showError:t,showInfo:n}=k(),{confirm:r,isOpen:i,options:a,handleConfirm:o,handleCancel:c}=O(),[l,u]=(0,j.useState)(null),[d,f]=(0,j.useState)(!0),[p,m]=(0,j.useState)(null),[h,g]=(0,j.useState)(!1),_=async()=>{try{f(!0),m(null),u(await v())}catch(e){m(e instanceof Error?e.message:`Failed to load status`),console.error(`[Calibration] Load error:`,e)}finally{f(!1)}};return(0,j.useEffect)(()=>{_()},[]),{status:l,loading:d,error:p,actionLoading:h,handleGenerate:async()=>{if(await r({title:`Generate Calibration?`,message:`This analyzes all library files and may take some time.`,confirmLabel:`Generate`,severity:`warning`}))try{g(!0);let t=await s(!0),n=Object.keys(t.data.calibrations||{}).length,r=t.saved_files?.saved_files||0,i=`Calibration generated! Library: ${t.data.library_size} files, `;i+=`Calibrations: ${n}, Skipped: ${t.data.skipped_tags}`,r>0&&(i+=`, Saved ${r} files`),e(i),await _()}catch(e){t(e instanceof Error?e.message:`Failed to generate calibration`)}finally{g(!1)}},handleApply:async()=>{if(await r({title:`Apply Calibration?`,message:`Apply calibration to entire library? This will queue all files for reprocessing.`,confirmLabel:`Apply`,severity:`warning`}))try{g(!0),e(`Queued ${(await b()).queued} files for recalibration`),await _()}catch(e){t(e instanceof Error?e.message:`Failed to apply calibration`)}finally{g(!1)}},handleUpdateFiles:()=>{n(`Not implemented`)},dialogState:{isOpen:i,options:a,handleConfirm:o,handleCancel:c}}}function z(){let{status:t,loading:n,error:r,actionLoading:i,handleGenerate:a,handleApply:o,handleUpdateFiles:s,dialogState:c}=R();return(0,M.jsxs)(D,{title:`Calibration`,children:[n&&(0,M.jsx)(w,{}),r&&(0,M.jsxs)(_,{severity:`error`,children:[`Error: `,r]}),t&&(0,M.jsxs)(e,{spacing:2.5,children:[(0,M.jsx)(L,{status:t}),(0,M.jsx)(I,{onGenerate:a,onApply:o,onUpdateFiles:s,actionLoading:i})]}),(0,M.jsx)(d,{open:c.isOpen,title:c.options.title,message:c.options.message,confirmLabel:c.options.confirmLabel,cancelLabel:c.options.cancelLabel,severity:c.options.severity,onConfirm:c.handleConfirm,onCancel:c.handleCancel})]})}export{z as CalibrationPage};