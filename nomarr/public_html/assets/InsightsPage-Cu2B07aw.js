import{t as e}from"./Stack-CC4XdeGg.js";import{t}from"./TextField-DD4lHWia.js";import{t as n}from"./Chip-DONqKCfF.js";import{a as r,i,n as a,r as o,t as s}from"./TableRow-C6J1sruN.js";import{$ as c,$t as l,A as u,B as d,F as f,H as p,I as m,L as h,M as g,Qt as _,St as v,U as y,Ut as b,X as x,Y as S,c as C,i as w,j as T,n as E,r as D,rt as O,s as k,t as A,tt as j}from"./index-DUtrAcDD.js";import{t as M}from"./useNotification-DV6qLgS5.js";var N=l(_(),1),P=l(b()),F=v((0,P.jsx)(`path`,{d:`M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z`}),`Close`);function I({data:t}){return(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Mood Distribution`}),(0,P.jsx)(e,{spacing:1.25,children:t.map(e=>(0,P.jsx)(d,{label:e.mood,value:e.count,percentage:e.percentage},e.mood))})]})}function L({value:e,onChange:n,options:r,placeholder:i=`Type or select...`,disabled:a=!1,...o}){let[s,c]=(0,N.useState)(!1),[l,u]=(0,N.useState)(r),d=(0,N.useRef)(null);(0,N.useEffect)(()=>{u(e?r.filter(t=>t.toLowerCase().includes(e.toLowerCase())):r)},[e,r]),(0,N.useEffect)(()=>{let e=e=>{d.current&&!d.current.contains(e.target)&&c(!1)};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)},[]);let f=e=>{n(e.target.value),c(!0)},p=e=>{n(e),c(!1)};return(0,P.jsxs)(x,{...o,ref:d,sx:{position:`relative`,...o.sx},children:[(0,P.jsx)(t,{type:`text`,value:e,onChange:f,onFocus:()=>c(!0),placeholder:i,disabled:a,fullWidth:!0,size:`small`,sx:{"& .MuiOutlinedInput-root":{bgcolor:a?`background.paper`:`background.default`}}}),s&&!a&&l.length>0&&(0,P.jsx)(x,{sx:{position:`absolute`,top:`100%`,left:0,right:0,maxHeight:`200px`,overflowY:`auto`,bgcolor:`background.default`,border:1,borderColor:`divider`,borderTop:`none`,borderRadius:`0 0 4px 4px`,boxShadow:2,zIndex:1e3},children:l.map((e,t)=>(0,P.jsx)(x,{onClick:()=>p(e),sx:{p:1.5,cursor:`pointer`,fontSize:`0.875rem`,borderBottom:t<l.length-1?1:`none`,borderColor:`divider`,"&:hover":{bgcolor:`action.hover`}},children:e},t))})]})}function R(){let[t,l]=(0,N.useState)([]),[u,d]=(0,N.useState)([]),[f,m]=(0,N.useState)(``),[h,g]=(0,N.useState)(``),[_,v]=(0,N.useState)([]),[b,w]=(0,N.useState)([]),[E,D]=(0,N.useState)(null),[O,A]=(0,N.useState)(!1),[j,M]=(0,N.useState)(null);(0,N.useEffect)(()=>{I()},[]),(0,N.useEffect)(()=>{f?R(f):(d([]),g(``))},[f]);let I=async()=>{try{l((await k(!0)).tag_keys)}catch(e){console.error(`[TagCoOccurrence] Failed to load tag keys:`,e)}},R=async e=>{try{let t=await C(e,!0),n=new Set;for(let e of t.tag_keys)if(e.startsWith(`[`)&&e.endsWith(`]`))try{let t=JSON.parse(e);Array.isArray(t)?t.forEach(e=>n.add(String(e))):n.add(e)}catch{n.add(e)}else n.add(e);d(Array.from(n).sort())}catch(e){console.error(`[TagCoOccurrence] Failed to load tag values:`,e),d([])}},z=(e,t)=>_.some(n=>n.key===e&&n.value===t)||b.some(n=>n.key===e&&n.value===t),B=()=>{f&&h&&!_.some(e=>e.key===f&&e.value===h)&&_.length<16&&v([..._,{key:f,value:h}])},V=()=>{f&&h&&!b.some(e=>e.key===f&&e.value===h)&&b.length<16&&w([...b,{key:f,value:h}])},H=e=>{v(_.filter((t,n)=>n!==e))},U=e=>{w(b.filter((t,n)=>n!==e))},W=async()=>{if(_.length===0||b.length===0){M(`Both X and Y axes must have at least one tag`);return}try{A(!0),M(null),D(await T({x:_,y:b}))}catch(e){M(e instanceof Error?e.message:`Failed to build matrix`),console.error(`[TagCoOccurrence] Matrix build error:`,e)}finally{A(!1)}},G=(e,t)=>{if(e===0)return`#1a1a1a`;let n=Math.min(e/t,1);return`rgb(${Math.floor(30+n*44)}, ${Math.floor(30+n*128)}, ${Math.floor(30+n*225)})`},K=E?.matrix?Math.max(...E.matrix.flat(),1):1;return(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Tag Co-Occurrence Matrix`}),(0,P.jsxs)(e,{spacing:2,sx:{mb:2.5},children:[(0,P.jsxs)(x,{sx:{display:`flex`,gap:1.5,alignItems:`flex-end`},children:[(0,P.jsxs)(x,{sx:{flex:1},children:[(0,P.jsx)(c,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Key`}),(0,P.jsx)(L,{value:f,onChange:m,options:t,placeholder:`Select tag key...`})]}),(0,P.jsxs)(x,{sx:{flex:1},children:[(0,P.jsx)(c,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Value`}),(0,P.jsx)(L,{value:h,onChange:g,options:u,placeholder:`Select tag value...`,disabled:!f})]}),(0,P.jsx)(S,{onClick:B,disabled:!f||!h||_.length>=16||z(f,h),variant:`contained`,size:`small`,children:`Add to X`}),(0,P.jsx)(S,{onClick:V,disabled:!f||!h||b.length>=16||z(f,h),variant:`contained`,color:`secondary`,size:`small`,children:`Add to Y`})]}),(0,P.jsxs)(x,{children:[(0,P.jsxs)(c,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`X Axis (`,_.length,`/16)`]}),(0,P.jsxs)(x,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[_.length===0&&(0,P.jsx)(c,{variant:`body2`,color:`text.secondary`,children:`No tags added to X axis yet`}),_.map((e,t)=>(0,P.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>H(t),deleteIcon:(0,P.jsx)(F,{}),size:`small`},t))]})]}),(0,P.jsxs)(x,{children:[(0,P.jsxs)(c,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`Y Axis (`,b.length,`/16)`]}),(0,P.jsxs)(x,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[b.length===0&&(0,P.jsx)(c,{variant:`body2`,color:`text.secondary`,children:`No tags added to Y axis yet`}),b.map((e,t)=>(0,P.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>U(t),deleteIcon:(0,P.jsx)(F,{}),size:`small`},t))]})]}),(0,P.jsx)(S,{onClick:W,disabled:O||_.length===0||b.length===0,variant:`contained`,fullWidth:!0,children:O?`Building Matrix...`:`Build Matrix`})]}),j&&(0,P.jsx)(c,{color:`error`,sx:{mb:2},children:j}),E&&(0,P.jsx)(x,{sx:{overflowX:`auto`,mt:2.5},children:(0,P.jsxs)(r,{size:`small`,sx:{minWidth:300},children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Y \\ X`}),E.x.map((e,t)=>(0,P.jsxs)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:[e.key,`:`,(0,P.jsx)(`br`,{}),e.value]},t))]})}),(0,P.jsx)(i,{children:E.y.map((e,t)=>(0,P.jsxs)(s,{children:[(0,P.jsxs)(o,{sx:{borderColor:`divider`,fontWeight:600},children:[e.key,`: `,e.value]}),E.x.map((e,n)=>(0,P.jsx)(o,{align:`center`,sx:{borderColor:`divider`,bgcolor:G(E.matrix[t][n],K),fontWeight:E.matrix[t][n]>0?600:`normal`},children:E.matrix[t][n]},n))]},t))})]})})]})}function z({data:e,limit:t=50}){return(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Tag Frequencies (Top ${t})`}),(0,P.jsx)(x,{sx:{maxHeight:600,overflowY:`auto`,overflowX:`auto`},children:(0,P.jsxs)(r,{sx:{minWidth:300},children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Tag`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Count`})]})}),(0,P.jsx)(i,{children:e.map(e=>(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.tag_key}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.total_count})]},e.tag_key))})]})})]})}function B(){let[e,t]=(0,N.useState)({tagFrequencies:[],moodDistribution:[]}),[n,r]=(0,N.useState)(!0),[i,a]=(0,N.useState)(null);return(0,N.useEffect)(()=>{(async()=>{try{r(!0),a(null);let[e,n]=await Promise.all([g(50),u()]);t({tagFrequencies:e.tag_frequencies,moodDistribution:n.mood_distribution})}catch(e){a(e instanceof Error?e.message:`Failed to load analytics`),console.error(`[Analytics] Load error:`,e)}finally{r(!1)}})()},[]),{data:e,loading:n,error:i}}function V(){let{data:t,loading:n,error:r}=B();return(0,P.jsxs)(P.Fragment,{children:[n&&(0,P.jsx)(O,{}),r&&(0,P.jsxs)(j,{severity:`error`,children:[`Error: `,r]}),!n&&!r&&(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsx)(I,{data:t.moodDistribution}),(0,P.jsx)(z,{data:t.tagFrequencies}),(0,P.jsx)(R,{})]})]})}function H({preview:n,configText:c,loading:l,error:u,onLoadPreview:d,onGenerateConfig:m}){let{showSuccess:h}=M();return(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Navidrome TOML Configuration`}),(0,P.jsxs)(e,{spacing:1.25,children:[(0,P.jsx)(S,{onClick:d,disabled:l,variant:`contained`,fullWidth:!0,children:l?`Loading...`:`Load Tag Preview`}),(0,P.jsx)(S,{onClick:m,disabled:l,variant:`contained`,fullWidth:!0,children:l?`Generating...`:`Generate Config`})]}),u&&(0,P.jsxs)(f,{children:[`Error: `,u]})]}),n&&(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Tag Preview`}),(0,P.jsx)(x,{sx:{overflowX:`auto`},children:(0,P.jsxs)(r,{children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Tag`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Type`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Multivalue`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Count`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Summary`})]})}),(0,P.jsx)(i,{children:n.map(e=>(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.tag_key}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.type}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.is_multivalue?`Yes`:`No`}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.total_count}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.summary})]},e.tag_key))})]})})]}),c&&(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Generated Config`}),(0,P.jsx)(t,{multiline:!0,rows:20,value:c,fullWidth:!0,InputProps:{readOnly:!0,sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}}),(0,P.jsx)(S,{onClick:()=>{c&&(navigator.clipboard.writeText(c),h(`Copied to clipboard!`))},variant:`contained`,sx:{mt:1.25},children:`Copy to Clipboard`})]})]})}function U({query:n,name:r,comment:i,limit:a,sort:o,preview:s,content:l,loading:u,error:d,onQueryChange:m,onNameChange:h,onCommentChange:g,onLimitChange:_,onSortChange:v,onPreview:b,onGenerate:C}){return(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Smart Playlist Generator`}),(0,P.jsx)(x,{component:`form`,onSubmit:b,children:(0,P.jsxs)(e,{spacing:2,children:[(0,P.jsxs)(x,{children:[(0,P.jsx)(c,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Query *`}),(0,P.jsx)(t,{value:n,onChange:e=>m(e.target.value),placeholder:`e.g., tag:nom_happy > 0.8`,multiline:!0,rows:3,disabled:u,required:!0,fullWidth:!0,InputProps:{sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}})]}),(0,P.jsxs)(x,{children:[(0,P.jsx)(c,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Playlist Name *`}),(0,P.jsx)(t,{value:r,onChange:e=>h(e.target.value),disabled:u,required:!0,fullWidth:!0})]}),(0,P.jsxs)(x,{children:[(0,P.jsx)(c,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Comment`}),(0,P.jsx)(t,{value:i,onChange:e=>g(e.target.value),disabled:u,fullWidth:!0})]}),(0,P.jsxs)(x,{sx:{display:`grid`,gridTemplateColumns:`1fr 1fr`,gap:1.25},children:[(0,P.jsxs)(x,{children:[(0,P.jsx)(c,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Limit`}),(0,P.jsx)(t,{type:`number`,value:a??``,onChange:e=>_(e.target.value?parseInt(e.target.value):void 0),disabled:u,placeholder:`Optional`,fullWidth:!0})]}),(0,P.jsxs)(x,{children:[(0,P.jsx)(c,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Sort`}),(0,P.jsx)(t,{value:o,onChange:e=>v(e.target.value),disabled:u,placeholder:`Optional`,fullWidth:!0})]})]}),(0,P.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,P.jsx)(S,{type:`submit`,variant:`contained`,disabled:u,fullWidth:!0,children:u?`Loading...`:`Preview Query`}),(0,P.jsx)(S,{type:`button`,onClick:C,variant:`contained`,disabled:u,fullWidth:!0,children:u?`Generating...`:`Generate .nsp`})]})]})}),d&&(0,P.jsxs)(f,{children:[`Error: `,d]})]}),s&&(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Query Preview`}),(0,P.jsx)(x,{component:`pre`,sx:{p:2,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,overflow:`auto`,fontSize:`0.875rem`,fontFamily:`monospace`},children:JSON.stringify(s,null,2)})]}),l&&(0,P.jsxs)(y,{children:[(0,P.jsx)(p,{title:`Generated Playlist (.nsp)`}),(0,P.jsx)(t,{multiline:!0,rows:15,value:l,fullWidth:!0,InputProps:{readOnly:!0,sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}}),(0,P.jsx)(S,{onClick:()=>{if(l){let e=new Blob([l],{type:`text/plain`}),t=URL.createObjectURL(e),n=document.createElement(`a`);n.href=t,n.download=`${r}.nsp`,n.click(),URL.revokeObjectURL(t)}},variant:`contained`,sx:{mt:1.25},children:`Download .nsp File`})]})]})}function W(){let{showError:e}=M(),[t,n]=(0,N.useState)(null),[r,i]=(0,N.useState)(null),[a,o]=(0,N.useState)(!1),[s,c]=(0,N.useState)(null),[l,u]=(0,N.useState)(``),[d,f]=(0,N.useState)(`My Playlist`),[p,m]=(0,N.useState)(``),[h,g]=(0,N.useState)(void 0),[_,v]=(0,N.useState)(``),[y,b]=(0,N.useState)(null),[x,S]=(0,N.useState)(null),[C,T]=(0,N.useState)(!1),[O,k]=(0,N.useState)(null);return{configPreview:t,configText:r,configLoading:a,configError:s,playlistQuery:l,playlistName:d,playlistComment:p,playlistLimit:h,playlistSort:_,playlistPreview:y,playlistContent:x,playlistLoading:C,playlistError:O,loadConfigPreview:async()=>{try{o(!0),c(null),n((await D()).tags)}catch(e){c(e instanceof Error?e.message:`Failed to load preview`)}finally{o(!1)}},generateConfig:async()=>{try{o(!0),c(null),i((await E()).config)}catch(e){c(e instanceof Error?e.message:`Failed to generate config`)}finally{o(!1)}},previewPlaylist:async e=>{if(e.preventDefault(),l.trim())try{T(!0),k(null),b(await w(l,10))}catch(e){k(e instanceof Error?e.message:`Failed to preview playlist`)}finally{T(!1)}},generatePlaylist:async()=>{if(!l.trim()){e(`Query is required`);return}if(!d.trim()){e(`Playlist name is required`);return}try{T(!0),k(null),S((await A({query:l,playlist_name:d,comment:p,limit:h,sort:_||void 0})).content)}catch(e){k(e instanceof Error?e.message:`Failed to generate playlist`)}finally{T(!1)}},setPlaylistQuery:u,setPlaylistName:f,setPlaylistComment:m,setPlaylistLimit:g,setPlaylistSort:v}}function G(){let[e,t]=(0,N.useState)(`config`),{configPreview:n,configText:r,configLoading:i,configError:a,playlistQuery:o,playlistName:s,playlistComment:c,playlistLimit:l,playlistSort:u,playlistPreview:d,playlistContent:f,playlistLoading:p,playlistError:m,loadConfigPreview:g,generateConfig:_,previewPlaylist:v,generatePlaylist:y,setPlaylistQuery:b,setPlaylistName:x,setPlaylistComment:S,setPlaylistLimit:C,setPlaylistSort:w}=W();return(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(h,{tabs:[{id:`config`,label:`Config Generator`},{id:`playlist`,label:`Playlist Generator`}],activeTab:e,onTabChange:e=>t(e)}),e===`config`&&(0,P.jsx)(H,{preview:n,configText:r,loading:i,error:a,onLoadPreview:g,onGenerateConfig:_}),e===`playlist`&&(0,P.jsx)(U,{query:o,name:s,comment:c,limit:l,sort:u,preview:d,content:f,loading:p,error:m,onQueryChange:b,onNameChange:x,onCommentChange:S,onLimitChange:C,onSortChange:w,onPreview:v,onGenerate:y})]})}function K(){let[e,t]=(0,N.useState)(`analytics`);return(0,P.jsxs)(m,{title:`Insights`,children:[(0,P.jsx)(h,{tabs:[{id:`analytics`,label:`Analytics`},{id:`navidrome`,label:`Navidrome Integration`}],activeTab:e,onTabChange:e=>t(e)}),e===`analytics`&&(0,P.jsx)(V,{}),e===`navidrome`&&(0,P.jsx)(G,{})]})}export{K as InsightsPage};