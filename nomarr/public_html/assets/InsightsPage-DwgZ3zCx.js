import{t as e}from"./Stack-B65G-2W0.js";import{t}from"./TextField-BzikLwEx.js";import"./useSlotProps-CB3aTem6.js";import{t as n}from"./Chip-BlysArp3.js";import{a as r,i,n as a,r as o,t as s}from"./TableRow-BAr_SwWr.js";import{H as c,I as l,J as u,K as d,L as f,Ot as p,R as m,U as h,V as g,Y as _,Yt as v,an as y,at as b,c as x,i as S,in as C,lt as w,n as T,nt as E,r as D,s as O,st as k,t as A,tt as j}from"./index-C-W2loPz.js";import{t as M}from"./useNotification-DVBm8Skm.js";var N=y(C(),1),P=y(v()),F=p((0,P.jsx)(`path`,{d:`M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z`}),`Close`);function I({data:t}){return(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Mood Distribution`}),(0,P.jsx)(e,{spacing:1.25,children:t.map(e=>(0,P.jsx)(d,{label:e.mood,value:e.count,percentage:e.percentage},e.mood))})]})}function L({value:e,onChange:n,options:r,placeholder:i=`Type or select...`,disabled:a=!1,...o}){let[s,c]=(0,N.useState)(!1),[l,u]=(0,N.useState)(r),d=(0,N.useRef)(null);(0,N.useEffect)(()=>{u(e?r.filter(t=>t.toLowerCase().includes(e.toLowerCase())):r)},[e,r]),(0,N.useEffect)(()=>{let e=e=>{d.current&&!d.current.contains(e.target)&&c(!1)};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)},[]);let f=e=>{n(e.target.value),c(!0)},p=e=>{n(e),c(!1)};return(0,P.jsxs)(E,{...o,ref:d,sx:{position:`relative`,...o.sx},children:[(0,P.jsx)(t,{type:`text`,value:e,onChange:f,onFocus:()=>c(!0),placeholder:i,disabled:a,fullWidth:!0,size:`small`,sx:{"& .MuiOutlinedInput-root":{bgcolor:a?`background.paper`:`background.default`}}}),s&&!a&&l.length>0&&(0,P.jsx)(E,{sx:{position:`absolute`,top:`100%`,left:0,right:0,maxHeight:`200px`,overflowY:`auto`,bgcolor:`background.default`,border:1,borderColor:`divider`,borderTop:`none`,borderRadius:`0 0 4px 4px`,boxShadow:2,zIndex:1e3},children:l.map((e,t)=>(0,P.jsx)(E,{onClick:()=>p(e),sx:{p:1.5,cursor:`pointer`,fontSize:`0.875rem`,borderBottom:t<l.length-1?1:`none`,borderColor:`divider`,"&:hover":{bgcolor:`action.hover`}},children:e},t))})]})}function R(){let[t,c]=(0,N.useState)([]),[l,d]=(0,N.useState)([]),[p,m]=(0,N.useState)(``),[h,g]=(0,N.useState)(``),[v,y]=(0,N.useState)([]),[S,C]=(0,N.useState)([]),[w,T]=(0,N.useState)(null),[D,k]=(0,N.useState)(!1),[A,M]=(0,N.useState)(null);(0,N.useEffect)(()=>{I()},[]),(0,N.useEffect)(()=>{p?R(p):(d([]),g(``))},[p]);let I=async()=>{try{c((await O(!0)).tag_keys)}catch(e){console.error(`[TagCoOccurrence] Failed to load tag keys:`,e)}},R=async e=>{try{let t=await x(e,!0),n=new Set;for(let e of t.tag_keys)if(e.startsWith(`[`)&&e.endsWith(`]`))try{let t=JSON.parse(e);Array.isArray(t)?t.forEach(e=>n.add(String(e))):n.add(e)}catch{n.add(e)}else n.add(e);d(Array.from(n).sort())}catch(e){console.error(`[TagCoOccurrence] Failed to load tag values:`,e),d([])}},z=(e,t)=>v.some(n=>n.key===e&&n.value===t)||S.some(n=>n.key===e&&n.value===t),B=()=>{p&&h&&!v.some(e=>e.key===p&&e.value===h)&&v.length<16&&y([...v,{key:p,value:h}])},V=()=>{p&&h&&!S.some(e=>e.key===p&&e.value===h)&&S.length<16&&C([...S,{key:p,value:h}])},H=e=>{y(v.filter((t,n)=>n!==e))},U=e=>{C(S.filter((t,n)=>n!==e))},W=async()=>{if(v.length===0||S.length===0){M(`Both X and Y axes must have at least one tag`);return}try{k(!0),M(null),T(await f({x:v,y:S}))}catch(e){M(e instanceof Error?e.message:`Failed to build matrix`),console.error(`[TagCoOccurrence] Matrix build error:`,e)}finally{k(!1)}},G=(e,t)=>{if(e===0)return`#1a1a1a`;let n=Math.min(e/t,1);return`rgb(${Math.floor(30+n*44)}, ${Math.floor(30+n*128)}, ${Math.floor(30+n*225)})`},K=w?.matrix?Math.max(...w.matrix.flat(),1):1;return(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Tag Co-Occurrence Matrix`}),(0,P.jsxs)(e,{spacing:2,sx:{mb:2.5},children:[(0,P.jsxs)(E,{sx:{display:`flex`,gap:1.5,alignItems:`flex-end`},children:[(0,P.jsxs)(E,{sx:{flex:1},children:[(0,P.jsx)(b,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Key`}),(0,P.jsx)(L,{value:p,onChange:m,options:t,placeholder:`Select tag key...`})]}),(0,P.jsxs)(E,{sx:{flex:1},children:[(0,P.jsx)(b,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Value`}),(0,P.jsx)(L,{value:h,onChange:g,options:l,placeholder:`Select tag value...`,disabled:!p})]}),(0,P.jsx)(j,{onClick:B,disabled:!p||!h||v.length>=16||z(p,h),variant:`contained`,size:`small`,children:`Add to X`}),(0,P.jsx)(j,{onClick:V,disabled:!p||!h||S.length>=16||z(p,h),variant:`contained`,color:`secondary`,size:`small`,children:`Add to Y`})]}),(0,P.jsxs)(E,{children:[(0,P.jsxs)(b,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`X Axis (`,v.length,`/16)`]}),(0,P.jsxs)(E,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[v.length===0&&(0,P.jsx)(b,{variant:`body2`,color:`text.secondary`,children:`No tags added to X axis yet`}),v.map((e,t)=>(0,P.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>H(t),deleteIcon:(0,P.jsx)(F,{}),size:`small`},t))]})]}),(0,P.jsxs)(E,{children:[(0,P.jsxs)(b,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`Y Axis (`,S.length,`/16)`]}),(0,P.jsxs)(E,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[S.length===0&&(0,P.jsx)(b,{variant:`body2`,color:`text.secondary`,children:`No tags added to Y axis yet`}),S.map((e,t)=>(0,P.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>U(t),deleteIcon:(0,P.jsx)(F,{}),size:`small`},t))]})]}),(0,P.jsx)(j,{onClick:W,disabled:D||v.length===0||S.length===0,variant:`contained`,fullWidth:!0,children:D?`Building Matrix...`:`Build Matrix`})]}),A&&(0,P.jsx)(b,{color:`error`,sx:{mb:2},children:A}),w&&(0,P.jsx)(E,{sx:{overflowX:`auto`,mt:2.5},children:(0,P.jsxs)(r,{size:`small`,sx:{minWidth:300},children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Y \\ X`}),w.x.map((e,t)=>(0,P.jsxs)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:[e.key,`:`,(0,P.jsx)(`br`,{}),e.value]},t))]})}),(0,P.jsx)(i,{children:w.y.map((e,t)=>(0,P.jsxs)(s,{children:[(0,P.jsxs)(o,{sx:{borderColor:`divider`,fontWeight:600},children:[e.key,`: `,e.value]}),w.x.map((e,n)=>(0,P.jsx)(o,{align:`center`,sx:{borderColor:`divider`,bgcolor:G(w.matrix[t][n],K),fontWeight:w.matrix[t][n]>0?600:`normal`},children:w.matrix[t][n]},n))]},t))})]})})]})}function z({data:e,limit:t=50}){return(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Tag Frequencies (Top ${t})`}),(0,P.jsx)(E,{sx:{maxHeight:600,overflowY:`auto`,overflowX:`auto`},children:(0,P.jsxs)(r,{sx:{minWidth:300},children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Tag`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Count`})]})}),(0,P.jsx)(i,{children:e.map(e=>(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.tag_key}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.total_count})]},e.tag_key))})]})})]})}function B(){let[e,t]=(0,N.useState)({tagFrequencies:[],moodDistribution:[]}),[n,r]=(0,N.useState)(!0),[i,a]=(0,N.useState)(null);return(0,N.useEffect)(()=>{(async()=>{try{r(!0),a(null);let[e,n]=await Promise.all([m(50),l()]);t({tagFrequencies:e.tag_frequencies,moodDistribution:n.mood_distribution})}catch(e){a(e instanceof Error?e.message:`Failed to load analytics`),console.error(`[Analytics] Load error:`,e)}finally{r(!1)}})()},[]),{data:e,loading:n,error:i}}function V(){let{data:t,loading:n,error:r}=B();return(0,P.jsxs)(P.Fragment,{children:[n&&(0,P.jsx)(w,{}),r&&(0,P.jsxs)(k,{severity:`error`,children:[`Error: `,r]}),!n&&!r&&(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsx)(I,{data:t.moodDistribution}),(0,P.jsx)(z,{data:t.tagFrequencies}),(0,P.jsx)(R,{})]})]})}function H({preview:n,configText:c,loading:l,error:d,onLoadPreview:f,onGenerateConfig:p}){let{showSuccess:m}=M();return(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Navidrome TOML Configuration`}),(0,P.jsxs)(e,{spacing:1.25,children:[(0,P.jsx)(j,{onClick:f,disabled:l,variant:`contained`,fullWidth:!0,children:l?`Loading...`:`Load Tag Preview`}),(0,P.jsx)(j,{onClick:p,disabled:l,variant:`contained`,fullWidth:!0,children:l?`Generating...`:`Generate Config`})]}),d&&(0,P.jsxs)(g,{children:[`Error: `,d]})]}),n&&(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Tag Preview`}),(0,P.jsx)(E,{sx:{overflowX:`auto`},children:(0,P.jsxs)(r,{children:[(0,P.jsx)(a,{children:(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Tag`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Type`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Multivalue`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Count`}),(0,P.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2},children:`Summary`})]})}),(0,P.jsx)(i,{children:n.map(e=>(0,P.jsxs)(s,{children:[(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.tag_key}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.type}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.is_multivalue?`Yes`:`No`}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.total_count}),(0,P.jsx)(o,{sx:{borderColor:`divider`},children:e.summary})]},e.tag_key))})]})})]}),c&&(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Generated Config`}),(0,P.jsx)(t,{multiline:!0,rows:20,value:c,fullWidth:!0,InputProps:{readOnly:!0,sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}}),(0,P.jsx)(j,{onClick:()=>{c&&(navigator.clipboard.writeText(c),m(`Copied to clipboard!`))},variant:`contained`,sx:{mt:1.25},children:`Copy to Clipboard`})]})]})}function U({query:n,name:r,comment:i,limit:a,sort:o,preview:s,content:c,loading:l,error:d,onQueryChange:f,onNameChange:p,onCommentChange:m,onLimitChange:h,onSortChange:v,onPreview:y,onGenerate:x}){return(0,P.jsxs)(e,{spacing:2.5,children:[(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Smart Playlist Generator`}),(0,P.jsx)(E,{component:`form`,onSubmit:y,children:(0,P.jsxs)(e,{spacing:2,children:[(0,P.jsxs)(E,{children:[(0,P.jsx)(b,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Query *`}),(0,P.jsx)(t,{value:n,onChange:e=>f(e.target.value),placeholder:`e.g., tag:nom_happy > 0.8`,multiline:!0,rows:3,disabled:l,required:!0,fullWidth:!0,InputProps:{sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}})]}),(0,P.jsxs)(E,{children:[(0,P.jsx)(b,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Playlist Name *`}),(0,P.jsx)(t,{value:r,onChange:e=>p(e.target.value),disabled:l,required:!0,fullWidth:!0})]}),(0,P.jsxs)(E,{children:[(0,P.jsx)(b,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Comment`}),(0,P.jsx)(t,{value:i,onChange:e=>m(e.target.value),disabled:l,fullWidth:!0})]}),(0,P.jsxs)(E,{sx:{display:`grid`,gridTemplateColumns:`1fr 1fr`,gap:1.25},children:[(0,P.jsxs)(E,{children:[(0,P.jsx)(b,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Limit`}),(0,P.jsx)(t,{type:`number`,value:a??``,onChange:e=>h(e.target.value?parseInt(e.target.value):void 0),disabled:l,placeholder:`Optional`,fullWidth:!0})]}),(0,P.jsxs)(E,{children:[(0,P.jsx)(b,{variant:`body2`,color:`text.secondary`,sx:{mb:.5,fontWeight:600},children:`Sort`}),(0,P.jsx)(t,{value:o,onChange:e=>v(e.target.value),disabled:l,placeholder:`Optional`,fullWidth:!0})]})]}),(0,P.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,P.jsx)(j,{type:`submit`,variant:`contained`,disabled:l,fullWidth:!0,children:l?`Loading...`:`Preview Query`}),(0,P.jsx)(j,{type:`button`,onClick:x,variant:`contained`,disabled:l,fullWidth:!0,children:l?`Generating...`:`Generate .nsp`})]})]})}),d&&(0,P.jsxs)(g,{children:[`Error: `,d]})]}),s&&(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Query Preview`}),(0,P.jsx)(E,{component:`pre`,sx:{p:2,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,overflow:`auto`,fontSize:`0.875rem`,fontFamily:`monospace`},children:JSON.stringify(s,null,2)})]}),c&&(0,P.jsxs)(_,{children:[(0,P.jsx)(u,{title:`Generated Playlist (.nsp)`}),(0,P.jsx)(t,{multiline:!0,rows:15,value:c,fullWidth:!0,InputProps:{readOnly:!0,sx:{fontFamily:`monospace`,fontSize:`0.875rem`}}}),(0,P.jsx)(j,{onClick:()=>{if(c){let e=new Blob([c],{type:`text/plain`}),t=URL.createObjectURL(e),n=document.createElement(`a`);n.href=t,n.download=`${r}.nsp`,n.click(),URL.revokeObjectURL(t)}},variant:`contained`,sx:{mt:1.25},children:`Download .nsp File`})]})]})}function W(){let{showError:e}=M(),[t,n]=(0,N.useState)(null),[r,i]=(0,N.useState)(null),[a,o]=(0,N.useState)(!1),[s,c]=(0,N.useState)(null),[l,u]=(0,N.useState)(``),[d,f]=(0,N.useState)(`My Playlist`),[p,m]=(0,N.useState)(``),[h,g]=(0,N.useState)(void 0),[_,v]=(0,N.useState)(``),[y,b]=(0,N.useState)(null),[x,C]=(0,N.useState)(null),[w,E]=(0,N.useState)(!1),[O,k]=(0,N.useState)(null);return{configPreview:t,configText:r,configLoading:a,configError:s,playlistQuery:l,playlistName:d,playlistComment:p,playlistLimit:h,playlistSort:_,playlistPreview:y,playlistContent:x,playlistLoading:w,playlistError:O,loadConfigPreview:async()=>{try{o(!0),c(null),n((await D()).tags)}catch(e){c(e instanceof Error?e.message:`Failed to load preview`)}finally{o(!1)}},generateConfig:async()=>{try{o(!0),c(null),i((await T()).config)}catch(e){c(e instanceof Error?e.message:`Failed to generate config`)}finally{o(!1)}},previewPlaylist:async e=>{if(e.preventDefault(),l.trim())try{E(!0),k(null),b(await S(l,10))}catch(e){k(e instanceof Error?e.message:`Failed to preview playlist`)}finally{E(!1)}},generatePlaylist:async()=>{if(!l.trim()){e(`Query is required`);return}if(!d.trim()){e(`Playlist name is required`);return}try{E(!0),k(null),C((await A({query:l,playlist_name:d,comment:p,limit:h,sort:_||void 0})).content)}catch(e){k(e instanceof Error?e.message:`Failed to generate playlist`)}finally{E(!1)}},setPlaylistQuery:u,setPlaylistName:f,setPlaylistComment:m,setPlaylistLimit:g,setPlaylistSort:v}}function G(){let[e,t]=(0,N.useState)(`config`),{configPreview:n,configText:r,configLoading:i,configError:a,playlistQuery:o,playlistName:s,playlistComment:c,playlistLimit:l,playlistSort:u,playlistPreview:d,playlistContent:f,playlistLoading:p,playlistError:m,loadConfigPreview:g,generateConfig:_,previewPlaylist:v,generatePlaylist:y,setPlaylistQuery:b,setPlaylistName:x,setPlaylistComment:S,setPlaylistLimit:C,setPlaylistSort:w}=W();return(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(h,{tabs:[{id:`config`,label:`Config Generator`},{id:`playlist`,label:`Playlist Generator`}],activeTab:e,onTabChange:e=>t(e)}),e===`config`&&(0,P.jsx)(H,{preview:n,configText:r,loading:i,error:a,onLoadPreview:g,onGenerateConfig:_}),e===`playlist`&&(0,P.jsx)(U,{query:o,name:s,comment:c,limit:l,sort:u,preview:d,content:f,loading:p,error:m,onQueryChange:b,onNameChange:x,onCommentChange:S,onLimitChange:C,onSortChange:w,onPreview:v,onGenerate:y})]})}function K(){let[e,t]=(0,N.useState)(`analytics`);return(0,P.jsxs)(c,{title:`Insights`,children:[(0,P.jsx)(h,{tabs:[{id:`analytics`,label:`Analytics`},{id:`navidrome`,label:`Navidrome Integration`}],activeTab:e,onTabChange:e=>t(e)}),e===`analytics`&&(0,P.jsx)(V,{}),e===`navidrome`&&(0,P.jsx)(G,{})]})}export{K as InsightsPage};