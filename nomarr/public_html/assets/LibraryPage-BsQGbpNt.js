import{t as e}from"./Stack-C16zh1gZ.js";import{t}from"./TextField-COCzMOZh.js";import"./useSlotProps-CGD2pfMu.js";import{t as n}from"./Chip-C6xM-JNr.js";import{r,t as i}from"./FormControlLabel-Cy_oJ7CN.js";import{Bt as a,C as o,E as s,Et as c,Ht as l,S as u,f as d,i as ee,m as f,n as p,o as m,p as h,s as g,u as _}from"./index-BQCr6YQc.js";import{t as v}from"./useConfirmDialog-CA4Uyb45.js";import{t as y}from"./useNotification-CCllPM-q.js";import{t as te}from"./ServerFilePicker-CDHWk2Qf.js";var b=l(a(),1),x=l(c(),1);function S(){let{showSuccess:a}=y(),{confirm:c,isOpen:l,options:d,handleConfirm:g,handleCancel:_}=v(),[S,C]=(0,b.useState)([]),[w,T]=(0,b.useState)(!0),[E,D]=(0,b.useState)(null),[O,k]=(0,b.useState)(!1),[A,j]=(0,b.useState)(null),[M,N]=(0,b.useState)(null),[P,F]=(0,b.useState)(null),[I,L]=(0,b.useState)(``),[R,z]=(0,b.useState)(``),[B,V]=(0,b.useState)(!0),[H,U]=(0,b.useState)(!1),[W,G]=(0,b.useState)(!1),[K,q]=(0,b.useState)(null),[J,Y]=(0,b.useState)(!1),X=async()=>{try{T(!0),D(null),C(await p.library.list())}catch(e){D(e instanceof Error?e.message:`Failed to load libraries`),console.error(`[LibraryManagement] Load error:`,e)}finally{T(!1)}},ne=async()=>{try{F((await p.config.get()).library_root||null)}catch(e){console.error(`[LibraryManagement] Failed to load config:`,e)}};(0,b.useEffect)(()=>{X(),ne()},[]);let Z=e=>{if(!P)return!1;let t=P.replace(/\/+$/,``);return!e.replace(/\/+$/,``).startsWith(t)},Q=()=>{L(``),z(``),V(!0),U(!1),G(!1),q(null),Y(!1),k(!1),j(null)},re=()=>{Q(),k(!0)},ie=e=>{L(e.name),z(e.rootPath),V(e.isEnabled),U(e.isDefault),j(e.id),k(!1),q(null),Y(!1)},ae=async()=>{if(!R.trim()){D(`Path is required for preview`);return}if(A===null){D(`Create the library first to preview file count`);return}try{D(null),Y(!0),q((await p.library.preview(A,{recursive:!0})).file_count)}catch(e){D(e instanceof Error?e.message:`Failed to preview library`)}finally{Y(!1)}},oe=async()=>{if(!I.trim()||!R.trim()){D(`Name and path are required`);return}try{D(null),await p.library.create({name:I,rootPath:R,isEnabled:B,isDefault:H}),await X(),Q()}catch(e){D(e instanceof Error?e.message:`Failed to create library`)}},se=async()=>{if(A!==null){if(!I.trim()||!R.trim()){D(`Name and path are required`);return}try{D(null),await p.library.update(A,{name:I,rootPath:R,isEnabled:B,isDefault:H}),await X(),Q()}catch(e){D(e instanceof Error?e.message:`Failed to update library`)}}},ce=async e=>{try{D(null),await p.library.setDefault(e),await X()}catch(e){D(e instanceof Error?e.message:`Failed to set default library`)}},le=async e=>{try{if(D(null),!await c({title:`Start Library Scan?`,message:`Found ${(await p.library.preview(e,{recursive:!0})).file_count.toLocaleString()} audio files. Start scan?`}))return;N(e);let t=await p.library.scan(e,{recursive:!0,force:!1,cleanMissing:!0});a(`Scan ${t.status}: ${t.message||`Library scan queued`}`),await X()}catch(e){D(e instanceof Error?e.message:`Failed to scan library`)}finally{N(null)}},ue=async(e,t,n)=>{if(n){D(`Cannot delete the default library. Set another library as default first.`);return}if(await c({title:`Delete Library?`,message:`Delete library "${t}"?\n\nThis will remove the library entry but will NOT delete files on disk.`,severity:`warning`}))try{D(null),await p.library.delete(e),await X()}catch(e){D(e instanceof Error?e.message:`Failed to delete library`)}},$=O||A!==null;return(0,x.jsxs)(e,{spacing:2.5,children:[(0,x.jsxs)(e,{direction:`row`,justifyContent:`space-between`,alignItems:`center`,children:[(0,x.jsx)(s,{variant:`h5`,children:`Libraries`}),!$&&(0,x.jsx)(u,{variant:`contained`,onClick:re,children:`+ Add Library`})]}),E&&(0,x.jsx)(m,{children:E}),$&&(0,x.jsxs)(f,{children:[(0,x.jsx)(h,{title:O?`Create Library`:`Edit Library`}),(0,x.jsxs)(e,{spacing:2,children:[(0,x.jsxs)(o,{children:[(0,x.jsx)(s,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Name`}),(0,x.jsx)(t,{value:I,onChange:e=>L(e.target.value),placeholder:`My Music Library`,fullWidth:!0})]}),(0,x.jsxs)(o,{children:[(0,x.jsx)(s,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Root Path`}),(0,x.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,x.jsx)(t,{value:R,onChange:e=>z(e.target.value),placeholder:`/music`,fullWidth:!0}),(0,x.jsx)(u,{variant:`outlined`,onClick:()=>G(!W),sx:{minWidth:120},children:W?`Hide Picker`:`Browse...`})]}),W&&(0,x.jsx)(o,{sx:{mt:1.25,p:2,bgcolor:`background.default`,borderRadius:1,border:1,borderColor:`divider`},children:(0,x.jsx)(te,{value:R,onChange:e=>{z(e),G(!1)},mode:`directory`,label:`Select Library Root Directory`})})]}),(0,x.jsx)(i,{control:(0,x.jsx)(r,{checked:B,onChange:e=>V(e.target.checked)}),label:`Enabled`}),(0,x.jsx)(i,{control:(0,x.jsx)(r,{checked:H,onChange:e=>U(e.target.checked)}),label:`Default Library`}),A!==null&&(0,x.jsxs)(o,{children:[(0,x.jsx)(u,{variant:`outlined`,onClick:ae,disabled:!R.trim()||J,children:J?`Checking...`:`Preview File Count`}),K!==null&&(0,x.jsx)(o,{sx:{mt:1,p:1.5,bgcolor:`background.paper`,borderRadius:1,border:1,borderColor:`divider`},children:(0,x.jsxs)(s,{children:[(0,x.jsx)(`strong`,{children:K.toLocaleString()}),` audio files found`]})})]}),(0,x.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,x.jsx)(u,{variant:`contained`,onClick:O?oe:se,children:O?`Create`:`Update`}),(0,x.jsx)(u,{variant:`outlined`,onClick:Q,children:`Cancel`})]})]})]}),w&&(0,x.jsx)(s,{children:`Loading libraries...`}),!w&&!$&&S.length===0&&(0,x.jsx)(f,{children:(0,x.jsx)(s,{color:`text.secondary`,textAlign:`center`,fontStyle:`italic`,children:`No libraries configured. Click "Add Library" to get started.`})}),!w&&!$&&S.length>0&&(0,x.jsx)(e,{spacing:2,children:S.map(t=>(0,x.jsxs)(f,{children:[(0,x.jsxs)(e,{direction:`row`,justifyContent:`space-between`,alignItems:`flex-start`,sx:{mb:2},children:[(0,x.jsxs)(o,{children:[(0,x.jsxs)(e,{direction:`row`,alignItems:`center`,spacing:1.25,sx:{mb:.5},children:[(0,x.jsx)(s,{variant:`h6`,children:t.name}),t.isDefault&&(0,x.jsx)(n,{label:`Default`,color:`primary`,size:`small`}),Z(t.rootPath)&&(0,x.jsx)(n,{label:`Outside library_root`,color:`warning`,size:`small`})]}),(0,x.jsx)(s,{variant:`body2`,color:`text.secondary`,sx:{fontFamily:`monospace`},children:t.rootPath}),Z(t.rootPath)&&(0,x.jsxs)(s,{variant:`caption`,color:`warning.main`,sx:{mt:.5},children:[`âš  This library is outside the configured library_root (`,P,`)`]})]}),(0,x.jsxs)(e,{direction:`row`,alignItems:`center`,spacing:1,children:[(0,x.jsx)(o,{sx:{width:8,height:8,borderRadius:`50%`,bgcolor:t.isEnabled?`success.main`:`text.disabled`}}),(0,x.jsx)(s,{variant:`body2`,color:`text.secondary`,children:t.isEnabled?`Enabled`:`Disabled`})]})]}),(0,x.jsxs)(e,{direction:`row`,spacing:1.25,flexWrap:`wrap`,children:[(0,x.jsx)(u,{variant:`outlined`,size:`small`,onClick:()=>ie(t),disabled:M===t.id,children:`Edit`}),!t.isDefault&&(0,x.jsx)(u,{variant:`outlined`,size:`small`,onClick:()=>ce(t.id),disabled:M===t.id,children:`Set Default`}),(0,x.jsx)(u,{variant:`contained`,color:`success`,size:`small`,onClick:()=>le(t.id),disabled:!t.isEnabled||M===t.id||Z(t.rootPath),title:Z(t.rootPath)?`Cannot scan: library is outside library_root`:void 0,children:M===t.id?`Scanning...`:`Scan`}),(0,x.jsx)(u,{variant:`contained`,color:`error`,size:`small`,onClick:()=>ue(t.id,t.name,t.isDefault),disabled:M===t.id,children:`Delete`})]})]},t.id))}),(0,x.jsx)(ee,{open:l,title:d.title,message:d.message,confirmLabel:d.confirmLabel,cancelLabel:d.cancelLabel,severity:d.severity,onConfirm:g,onCancel:_})]})}function C({stats:e}){let t=[{label:`Total Files`,value:e.total_files},{label:`Artists`,value:e.unique_artists},{label:`Albums`,value:e.unique_albums},{label:`Total Duration`,value:(e=>`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m`)(e.total_duration_seconds)}];return(0,x.jsxs)(f,{children:[(0,x.jsx)(h,{title:`Library Statistics`}),(0,x.jsx)(_,{minColumnWidth:200,children:t.map(e=>(0,x.jsx)(d,{label:e.label,value:e.value},e.label))})]})}function w(){let[e,t]=(0,b.useState)(null),[n,r]=(0,b.useState)(!0),[i,a]=(0,b.useState)(null),o=async()=>{try{r(!0),a(null),t(await p.library.getStats())}catch(e){a(e instanceof Error?e.message:`Failed to load stats`),console.error(`[Library] Load error:`,e)}finally{r(!1)}};return(0,b.useEffect)(()=>{o()},[]),{stats:e,loading:n,error:i}}function T(){let{stats:t,loading:n,error:r}=w();return(0,x.jsxs)(g,{title:`Library Management`,children:[n&&(0,x.jsx)(s,{children:`Loading library statistics...`}),r&&(0,x.jsxs)(m,{children:[`Error: `,r]}),t&&(0,x.jsxs)(e,{spacing:2.5,children:[(0,x.jsx)(C,{stats:t}),(0,x.jsx)(f,{children:(0,x.jsx)(S,{})})]})]})}export{T as LibraryPage};