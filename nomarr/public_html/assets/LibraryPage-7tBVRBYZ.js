import{t as e}from"./Stack-CqnjfNxH.js";import{t}from"./TextField-BIZFZSHt.js";import"./Portal-CAh1Yehh.js";import{t as n}from"./Chip-CtMEfDOF.js";import{r,t as i}from"./FormControlLabel-DA0BNj_T.js";import{It as a,Rt as o,St as s,_ as c,a as l,b as u,d,f,l as p,n as m,o as h,p as g,v as _}from"./index-Bmoj33p1.js";import{t as ee}from"./useConfirmDialog-62s1TtO7.js";import{t as v}from"./ServerFilePicker-C1UrhG1T.js";import{t as te}from"./useNotification-CjuA8BtN.js";var y=o(a(),1),b=o(s(),1);function x(){let{showSuccess:a}=te(),{confirm:o}=ee(),[s,d]=(0,y.useState)([]),[p,h]=(0,y.useState)(!0),[x,S]=(0,y.useState)(null),[C,w]=(0,y.useState)(!1),[T,E]=(0,y.useState)(null),[D,O]=(0,y.useState)(null),[k,A]=(0,y.useState)(null),[j,M]=(0,y.useState)(``),[N,P]=(0,y.useState)(``),[F,I]=(0,y.useState)(!0),[L,R]=(0,y.useState)(!1),[z,B]=(0,y.useState)(!1),[V,H]=(0,y.useState)(null),[U,W]=(0,y.useState)(!1),G=async()=>{try{h(!0),S(null),d(await m.library.list())}catch(e){S(e instanceof Error?e.message:`Failed to load libraries`),console.error(`[LibraryManagement] Load error:`,e)}finally{h(!1)}},K=async()=>{try{A((await m.config.get()).library_root||null)}catch(e){console.error(`[LibraryManagement] Failed to load config:`,e)}};(0,y.useEffect)(()=>{G(),K()},[]);let q=e=>{if(!k)return!1;let t=k.replace(/\/+$/,``);return!e.replace(/\/+$/,``).startsWith(t)},J=()=>{M(``),P(``),I(!0),R(!1),B(!1),H(null),W(!1),w(!1),E(null)},Y=()=>{J(),w(!0)},X=e=>{M(e.name),P(e.rootPath),I(e.isEnabled),R(e.isDefault),E(e.id),w(!1),H(null),W(!1)},Z=async()=>{if(!N.trim()){S(`Path is required for preview`);return}if(T===null){S(`Create the library first to preview file count`);return}try{S(null),W(!0),H((await m.library.preview(T,{recursive:!0})).file_count)}catch(e){S(e instanceof Error?e.message:`Failed to preview library`)}finally{W(!1)}},ne=async()=>{if(!j.trim()||!N.trim()){S(`Name and path are required`);return}try{S(null),await m.library.create({name:j,rootPath:N,isEnabled:F,isDefault:L}),await G(),J()}catch(e){S(e instanceof Error?e.message:`Failed to create library`)}},Q=async()=>{if(T!==null){if(!j.trim()||!N.trim()){S(`Name and path are required`);return}try{S(null),await m.library.update(T,{name:j,rootPath:N,isEnabled:F,isDefault:L}),await G(),J()}catch(e){S(e instanceof Error?e.message:`Failed to update library`)}}},re=async e=>{try{S(null),await m.library.setDefault(e),await G()}catch(e){S(e instanceof Error?e.message:`Failed to set default library`)}},ie=async e=>{try{if(S(null),O(e),!await o({title:`Start Library Scan?`,message:`Found ${(await m.library.preview(e,{recursive:!0})).file_count.toLocaleString()} audio files. Start scan?`})){O(null);return}let t=await m.library.scan(e,{recursive:!0,force:!1,cleanMissing:!0});a(`Scan ${t.status}: ${t.message||`Library scan queued`}`),await G()}catch(e){S(e instanceof Error?e.message:`Failed to scan library`)}finally{O(null)}},ae=async(e,t,n)=>{if(n){S(`Cannot delete the default library. Set another library as default first.`);return}if(await o({title:`Delete Library?`,message:`Delete library "${t}"?\n\nThis will remove the library entry but will NOT delete files on disk.`,severity:`warning`}))try{S(null),await m.library.delete(e),await G()}catch(e){S(e instanceof Error?e.message:`Failed to delete library`)}},$=C||T!==null;return(0,b.jsxs)(e,{spacing:2.5,children:[(0,b.jsxs)(e,{direction:`row`,justifyContent:`space-between`,alignItems:`center`,children:[(0,b.jsx)(u,{variant:`h5`,children:`Libraries`}),!$&&(0,b.jsx)(c,{variant:`contained`,onClick:Y,children:`+ Add Library`})]}),x&&(0,b.jsx)(l,{children:x}),$&&(0,b.jsxs)(g,{children:[(0,b.jsx)(f,{title:C?`Create Library`:`Edit Library`}),(0,b.jsxs)(e,{spacing:2,children:[(0,b.jsxs)(_,{children:[(0,b.jsx)(u,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Name`}),(0,b.jsx)(t,{value:j,onChange:e=>M(e.target.value),placeholder:`My Music Library`,fullWidth:!0})]}),(0,b.jsxs)(_,{children:[(0,b.jsx)(u,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Root Path`}),(0,b.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,b.jsx)(t,{value:N,onChange:e=>P(e.target.value),placeholder:`/music`,fullWidth:!0}),(0,b.jsx)(c,{variant:`outlined`,onClick:()=>B(!z),sx:{minWidth:120},children:z?`Hide Picker`:`Browse...`})]}),z&&(0,b.jsx)(_,{sx:{mt:1.25,p:2,bgcolor:`background.default`,borderRadius:1,border:1,borderColor:`divider`},children:(0,b.jsx)(v,{value:N,onChange:e=>{P(e),B(!1)},mode:`directory`,label:`Select Library Root Directory`})})]}),(0,b.jsx)(i,{control:(0,b.jsx)(r,{checked:F,onChange:e=>I(e.target.checked)}),label:`Enabled`}),(0,b.jsx)(i,{control:(0,b.jsx)(r,{checked:L,onChange:e=>R(e.target.checked)}),label:`Default Library`}),T!==null&&(0,b.jsxs)(_,{children:[(0,b.jsx)(c,{variant:`outlined`,onClick:Z,disabled:!N.trim()||U,children:U?`Checking...`:`Preview File Count`}),V!==null&&(0,b.jsx)(_,{sx:{mt:1,p:1.5,bgcolor:`background.paper`,borderRadius:1,border:1,borderColor:`divider`},children:(0,b.jsxs)(u,{children:[(0,b.jsx)(`strong`,{children:V.toLocaleString()}),` audio files found`]})})]}),(0,b.jsxs)(e,{direction:`row`,spacing:1.25,children:[(0,b.jsx)(c,{variant:`contained`,onClick:C?ne:Q,children:C?`Create`:`Update`}),(0,b.jsx)(c,{variant:`outlined`,onClick:J,children:`Cancel`})]})]})]}),p&&(0,b.jsx)(u,{children:`Loading libraries...`}),!p&&!$&&s.length===0&&(0,b.jsx)(g,{children:(0,b.jsx)(u,{color:`text.secondary`,textAlign:`center`,fontStyle:`italic`,children:`No libraries configured. Click "Add Library" to get started.`})}),!p&&!$&&s.length>0&&(0,b.jsx)(e,{spacing:2,children:s.map(t=>(0,b.jsxs)(g,{children:[(0,b.jsxs)(e,{direction:`row`,justifyContent:`space-between`,alignItems:`flex-start`,sx:{mb:2},children:[(0,b.jsxs)(_,{children:[(0,b.jsxs)(e,{direction:`row`,alignItems:`center`,spacing:1.25,sx:{mb:.5},children:[(0,b.jsx)(u,{variant:`h6`,children:t.name}),t.isDefault&&(0,b.jsx)(n,{label:`Default`,color:`primary`,size:`small`}),q(t.rootPath)&&(0,b.jsx)(n,{label:`Outside library_root`,color:`warning`,size:`small`})]}),(0,b.jsx)(u,{variant:`body2`,color:`text.secondary`,sx:{fontFamily:`monospace`},children:t.rootPath}),q(t.rootPath)&&(0,b.jsxs)(u,{variant:`caption`,color:`warning.main`,sx:{mt:.5},children:[`âš  This library is outside the configured library_root (`,k,`)`]})]}),(0,b.jsxs)(e,{direction:`row`,alignItems:`center`,spacing:1,children:[(0,b.jsx)(_,{sx:{width:8,height:8,borderRadius:`50%`,bgcolor:t.isEnabled?`success.main`:`text.disabled`}}),(0,b.jsx)(u,{variant:`body2`,color:`text.secondary`,children:t.isEnabled?`Enabled`:`Disabled`})]})]}),(0,b.jsxs)(e,{direction:`row`,spacing:1.25,flexWrap:`wrap`,children:[(0,b.jsx)(c,{variant:`outlined`,size:`small`,onClick:()=>X(t),disabled:D===t.id,children:`Edit`}),!t.isDefault&&(0,b.jsx)(c,{variant:`outlined`,size:`small`,onClick:()=>re(t.id),disabled:D===t.id,children:`Set Default`}),(0,b.jsx)(c,{variant:`contained`,color:`success`,size:`small`,onClick:()=>ie(t.id),disabled:!t.isEnabled||D===t.id||q(t.rootPath),title:q(t.rootPath)?`Cannot scan: library is outside library_root`:void 0,children:D===t.id?`Scanning...`:`Scan`}),(0,b.jsx)(c,{variant:`contained`,color:`error`,size:`small`,onClick:()=>ae(t.id,t.name,t.isDefault),disabled:D===t.id,children:`Delete`})]})]},t.id))})]})}function S({stats:e}){let t=[{label:`Total Files`,value:e.total_files},{label:`Artists`,value:e.unique_artists},{label:`Albums`,value:e.unique_albums},{label:`Total Duration`,value:(e=>`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m`)(e.total_duration_seconds)}];return(0,b.jsxs)(g,{children:[(0,b.jsx)(f,{title:`Library Statistics`}),(0,b.jsx)(p,{minColumnWidth:200,children:t.map(e=>(0,b.jsx)(d,{label:e.label,value:e.value},e.label))})]})}function C(){let[e,t]=(0,y.useState)(null),[n,r]=(0,y.useState)(!0),[i,a]=(0,y.useState)(null),o=async()=>{try{r(!0),a(null),t(await m.library.getStats())}catch(e){a(e instanceof Error?e.message:`Failed to load stats`),console.error(`[Library] Load error:`,e)}finally{r(!1)}};return(0,y.useEffect)(()=>{o()},[]),{stats:e,loading:n,error:i}}function w(){let{stats:t,loading:n,error:r}=C();return(0,b.jsxs)(h,{title:`Library Management`,children:[n&&(0,b.jsx)(u,{children:`Loading library statistics...`}),r&&(0,b.jsxs)(l,{children:[`Error: `,r]}),t&&(0,b.jsxs)(e,{spacing:2.5,children:[(0,b.jsx)(S,{stats:t}),(0,b.jsx)(g,{children:(0,b.jsx)(x,{})})]})]})}export{w as LibraryPage};