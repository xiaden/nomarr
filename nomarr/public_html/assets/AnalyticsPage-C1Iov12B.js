import{t as e}from"./Stack-CHbb6P4R.js";import{t}from"./TextField-dZ6ShoYp.js";import"./useSlotProps--BZhkIc6.js";import{t as n}from"./Chip-C03yJejV.js";import{a as r,i,n as a,r as o,t as s}from"./TableRow-Dn6eU1pa.js";import{n as c,t as l}from"./files-CaWQnA_A.js";import{C as u,D as d,Dt as f,Et as p,X as m,_t as h,a as g,g as _,h as v,j as y,k as b,l as x,p as S,r as C,w}from"./index-uH8yfxIe.js";var T=f(h(),1),E=f(p(),1);async function D(e=50){return C(`/api/web/analytics/tag-frequencies?limit=${e}`)}async function O(){return C(`/api/web/analytics/mood-distribution`)}async function k(e){return g(`/api/web/analytics/tag-co-occurrences`,e)}function A({data:t}){return(0,T.jsxs)(_,{children:[(0,T.jsx)(v,{title:`Mood Distribution`}),(0,T.jsx)(e,{spacing:1.25,children:t.map(e=>(0,T.jsx)(S,{label:e.mood,value:e.count,percentage:e.percentage},e.mood))})]})}var j=m((0,T.jsx)(`path`,{d:`M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z`}),`Close`);function M({value:e,onChange:n,options:r,placeholder:i=`Type or select...`,disabled:a=!1,...o}){let[s,c]=(0,E.useState)(!1),[l,u]=(0,E.useState)(r),d=(0,E.useRef)(null);(0,E.useEffect)(()=>{u(e?r.filter(t=>t.toLowerCase().includes(e.toLowerCase())):r)},[e,r]),(0,E.useEffect)(()=>{let e=e=>{d.current&&!d.current.contains(e.target)&&c(!1)};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)},[]);let f=e=>{n(e.target.value),c(!0)},p=e=>{n(e),c(!1)};return(0,T.jsxs)(w,{...o,ref:d,sx:{position:`relative`,...o.sx},children:[(0,T.jsx)(t,{type:`text`,value:e,onChange:f,onFocus:()=>c(!0),placeholder:i,disabled:a,fullWidth:!0,size:`small`,sx:{"& .MuiOutlinedInput-root":{bgcolor:a?`background.paper`:`background.default`}}}),s&&!a&&l.length>0&&(0,T.jsx)(w,{sx:{position:`absolute`,top:`100%`,left:0,right:0,maxHeight:`200px`,overflowY:`auto`,bgcolor:`background.default`,border:1,borderColor:`divider`,borderTop:`none`,borderRadius:`0 0 4px 4px`,boxShadow:2,zIndex:1e3},children:l.map((e,t)=>(0,T.jsx)(w,{onClick:()=>p(e),sx:{p:1.5,cursor:`pointer`,fontSize:`0.875rem`,borderBottom:t<l.length-1?1:`none`,borderColor:`divider`,"&:hover":{bgcolor:`action.hover`}},children:e},t))})]})}function N(){let[t,f]=(0,E.useState)([]),[p,m]=(0,E.useState)([]),[h,g]=(0,E.useState)(``),[y,b]=(0,E.useState)(``),[x,S]=(0,E.useState)([]),[C,D]=(0,E.useState)([]),[O,A]=(0,E.useState)(null),[N,P]=(0,E.useState)(!1),[F,I]=(0,E.useState)(null);(0,E.useEffect)(()=>{L()},[]),(0,E.useEffect)(()=>{h?R(h):(m([]),b(``))},[h]);let L=async()=>{try{f((await l(!0)).tag_keys)}catch(e){console.error(`[TagCoOccurrence] Failed to load tag keys:`,e)}},R=async e=>{try{let t=await c(e,!0),n=new Set;for(let e of t.tag_keys)if(e.startsWith(`[`)&&e.endsWith(`]`))try{let t=JSON.parse(e);Array.isArray(t)?t.forEach(e=>n.add(String(e))):n.add(e)}catch{n.add(e)}else n.add(e);m(Array.from(n).sort())}catch(e){console.error(`[TagCoOccurrence] Failed to load tag values:`,e),m([])}},z=(e,t)=>x.some(n=>n.key===e&&n.value===t)||C.some(n=>n.key===e&&n.value===t),B=()=>{h&&y&&!x.some(e=>e.key===h&&e.value===y)&&x.length<16&&S([...x,{key:h,value:y}])},V=()=>{h&&y&&!C.some(e=>e.key===h&&e.value===y)&&C.length<16&&D([...C,{key:h,value:y}])},H=e=>{S(x.filter((t,n)=>n!==e))},U=e=>{D(C.filter((t,n)=>n!==e))},W=async()=>{if(x.length===0||C.length===0){I(`Both X and Y axes must have at least one tag`);return}try{P(!0),I(null),A(await k({x,y:C}))}catch(e){I(e instanceof Error?e.message:`Failed to build matrix`),console.error(`[TagCoOccurrence] Matrix build error:`,e)}finally{P(!1)}},G=(e,t)=>{if(e===0)return`#1a1a1a`;let n=Math.min(e/t,1);return`rgb(${Math.floor(30+n*44)}, ${Math.floor(30+n*128)}, ${Math.floor(30+n*225)})`},K=O?.matrix?Math.max(...O.matrix.flat(),1):1;return(0,T.jsxs)(_,{children:[(0,T.jsx)(v,{title:`Tag Co-Occurrence Matrix`}),(0,T.jsxs)(e,{spacing:2,sx:{mb:2.5},children:[(0,T.jsxs)(w,{sx:{display:`flex`,gap:1.5,alignItems:`flex-end`},children:[(0,T.jsxs)(w,{sx:{flex:1},children:[(0,T.jsx)(d,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Key`}),(0,T.jsx)(M,{value:h,onChange:g,options:t,placeholder:`Select tag key...`})]}),(0,T.jsxs)(w,{sx:{flex:1},children:[(0,T.jsx)(d,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:`Tag Value`}),(0,T.jsx)(M,{value:y,onChange:b,options:p,placeholder:`Select tag value...`,disabled:!h})]}),(0,T.jsx)(u,{onClick:B,disabled:!h||!y||x.length>=16||z(h,y),variant:`contained`,size:`small`,children:`Add to X`}),(0,T.jsx)(u,{onClick:V,disabled:!h||!y||C.length>=16||z(h,y),variant:`contained`,color:`secondary`,size:`small`,children:`Add to Y`})]}),(0,T.jsxs)(w,{children:[(0,T.jsxs)(d,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`X Axis (`,x.length,`/16)`]}),(0,T.jsxs)(w,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[x.length===0&&(0,T.jsx)(d,{variant:`body2`,color:`text.secondary`,children:`No tags added to X axis yet`}),x.map((e,t)=>(0,T.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>H(t),deleteIcon:(0,T.jsx)(j,{}),size:`small`},t))]})]}),(0,T.jsxs)(w,{children:[(0,T.jsxs)(d,{variant:`body2`,sx:{mb:.5,fontWeight:500},children:[`Y Axis (`,C.length,`/16)`]}),(0,T.jsxs)(w,{sx:{display:`flex`,flexWrap:`wrap`,gap:1,p:1.5,bgcolor:`background.default`,border:1,borderColor:`divider`,borderRadius:1,minHeight:80},children:[C.length===0&&(0,T.jsx)(d,{variant:`body2`,color:`text.secondary`,children:`No tags added to Y axis yet`}),C.map((e,t)=>(0,T.jsx)(n,{label:`${e.key}: ${e.value}`,onDelete:()=>U(t),deleteIcon:(0,T.jsx)(j,{}),size:`small`},t))]})]}),(0,T.jsx)(u,{onClick:W,disabled:N||x.length===0||C.length===0,variant:`contained`,fullWidth:!0,children:N?`Building Matrix...`:`Build Matrix`})]}),F&&(0,T.jsx)(d,{color:`error`,sx:{mb:2},children:F}),O&&(0,T.jsx)(w,{sx:{overflowX:`auto`,mt:2.5},children:(0,T.jsxs)(r,{size:`small`,sx:{minWidth:300},children:[(0,T.jsx)(a,{children:(0,T.jsxs)(s,{children:[(0,T.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Y \\ X`}),O.x.map((e,t)=>(0,T.jsxs)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:[e.key,`:`,(0,T.jsx)(`br`,{}),e.value]},t))]})}),(0,T.jsx)(i,{children:O.y.map((e,t)=>(0,T.jsxs)(s,{children:[(0,T.jsxs)(o,{sx:{borderColor:`divider`,fontWeight:600},children:[e.key,`: `,e.value]}),O.x.map((e,n)=>(0,T.jsx)(o,{align:`center`,sx:{borderColor:`divider`,bgcolor:G(O.matrix[t][n],K),fontWeight:O.matrix[t][n]>0?600:`normal`},children:O.matrix[t][n]},n))]},t))})]})})]})}function P({data:e,limit:t=50}){return(0,T.jsxs)(_,{children:[(0,T.jsx)(v,{title:`Tag Frequencies (Top ${t})`}),(0,T.jsx)(w,{sx:{maxHeight:600,overflowY:`auto`,overflowX:`auto`},children:(0,T.jsxs)(r,{sx:{minWidth:300},children:[(0,T.jsx)(a,{children:(0,T.jsxs)(s,{children:[(0,T.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Tag`}),(0,T.jsx)(o,{sx:{bgcolor:`background.default`,borderBottom:2,borderColor:`divider`,fontWeight:600},children:`Count`})]})}),(0,T.jsx)(i,{children:e.map(e=>(0,T.jsxs)(s,{children:[(0,T.jsx)(o,{sx:{borderColor:`divider`},children:e.tag_key}),(0,T.jsx)(o,{sx:{borderColor:`divider`},children:e.total_count})]},e.tag_key))})]})})]})}function F(){let[e,t]=(0,E.useState)({tagFrequencies:[],moodDistribution:[]}),[n,r]=(0,E.useState)(!0),[i,a]=(0,E.useState)(null);return(0,E.useEffect)(()=>{(async()=>{try{r(!0),a(null);let[e,n]=await Promise.all([D(50),O()]);t({tagFrequencies:e.tag_frequencies,moodDistribution:n.mood_distribution})}catch(e){a(e instanceof Error?e.message:`Failed to load analytics`),console.error(`[Analytics] Load error:`,e)}finally{r(!1)}})()},[]),{data:e,loading:n,error:i}}function I(){let{data:t,loading:n,error:r}=F();return(0,T.jsxs)(x,{title:`Analytics`,children:[n&&(0,T.jsx)(y,{}),r&&(0,T.jsxs)(b,{severity:`error`,children:[`Error: `,r]}),!n&&!r&&(0,T.jsxs)(e,{spacing:2.5,children:[(0,T.jsx)(A,{data:t.moodDistribution}),(0,T.jsx)(P,{data:t.tagFrequencies}),(0,T.jsx)(N,{})]})]})}export{I as AnalyticsPage};