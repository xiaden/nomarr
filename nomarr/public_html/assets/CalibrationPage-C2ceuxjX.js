import{t as e}from"./Stack-BDhchy68.js";import{a as t,i as n,n as r,r as i,t as a}from"./TableRow-CHSzcsQ1.js";import{F as o,Ft as s,I as c,J as l,Jt as u,K as d,M as f,N as p,P as m,Sn as h,V as g,Vt as _,W as v,X as y,Z as b,an as x,bn as S,dt as C,ht as w,in as T,it as E,j as D,ln as O,lt as k,rn as A,st as j,zt as M}from"./index-BXmj0H8O.js";import{t as N}from"./useConfirmDialog-lEDymmpu.js";import{t as P}from"./useNotification-DGTDEf-O.js";function F(e){return T(`MuiTableContainer`,e)}A(`MuiTableContainer`,[`root`]);var I=h(S()),L=h(O()),R=e=>{let{classes:t}=e;return u({root:[`root`]},F,t)},z=_(`div`,{name:`MuiTableContainer`,slot:`Root`})({width:`100%`,overflowX:`auto`}),B=I.forwardRef(function(e,t){let n=M({props:e,name:`MuiTableContainer`}),{className:r,component:i=`div`,...a}=n,o={...n,component:i};return(0,L.jsx)(z,{ref:t,as:i,className:x(R(o).root,r),ownerState:o,...a})}),V=s((0,L.jsx)(`path`,{d:`M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z`}),`CheckCircle`),H=s((0,L.jsx)(`path`,{d:`M1 21h22L12 2zm12-3h-2v-2h2zm0-4h-2v-4h2z`}),`Warning`);function U({onGenerate:t,onApply:n,onUpdateFiles:r,actionLoading:i}){return(0,L.jsxs)(b,{children:[(0,L.jsx)(y,{title:`Actions`}),(0,L.jsx)(e,{spacing:2,children:[{label:`Generate New Calibration`,description:`Analyze all files in library to generate optimal calibration values. This will scan the entire library and may take some time.`,onClick:t,color:`primary`,variant:`contained`},{label:`Apply Calibration to Library`,description:`Queue all files for reprocessing with current calibration. This will update all tags based on the current calibration values.`,onClick:n,color:`primary`,variant:`contained`},{label:`Update Calibration Files`,description:`Download and import the latest calibration bundle files from the repository.`,onClick:r,color:`secondary`,variant:`outlined`}].map(e=>(0,L.jsx)(d,{label:e.label,description:e.description,onClick:e.onClick,disabled:i,variant:e.variant,color:e.color},e.label))})]})}function W({status:e}){let o=e.last_run?new Date(e.last_run*1e3).toLocaleString():`Never`;return(0,L.jsxs)(b,{children:[(0,L.jsx)(y,{title:`Calibration Status`}),(0,L.jsxs)(E,{sx:{mb:3},children:[(0,L.jsxs)(j,{variant:`body2`,color:`text.secondary`,children:[(0,L.jsx)(`strong`,{children:`Global Version:`}),` `,e.global_version||`Not calibrated`]}),(0,L.jsxs)(j,{variant:`body2`,color:`text.secondary`,children:[(0,L.jsx)(`strong`,{children:`Last Run:`}),` `,o]})]}),e.libraries.length>0?(0,L.jsx)(B,{component:w,variant:`outlined`,children:(0,L.jsxs)(t,{size:`small`,children:[(0,L.jsx)(r,{children:(0,L.jsxs)(a,{children:[(0,L.jsx)(i,{children:`Library`}),(0,L.jsx)(i,{align:`right`,children:`Total Files`}),(0,L.jsx)(i,{align:`right`,children:`Current`}),(0,L.jsx)(i,{align:`right`,children:`Outdated`}),(0,L.jsx)(i,{align:`right`,children:`Calibration %`})]})}),(0,L.jsx)(n,{children:e.libraries.map(e=>(0,L.jsxs)(a,{children:[(0,L.jsx)(i,{children:e.library_name}),(0,L.jsx)(i,{align:`right`,children:e.total_files.toLocaleString()}),(0,L.jsx)(i,{align:`right`,children:e.current_count.toLocaleString()}),(0,L.jsx)(i,{align:`right`,children:e.outdated_count.toLocaleString()}),(0,L.jsxs)(i,{align:`right`,children:[e.percentage.toFixed(1),`%`]})]},e.library_id))})]})}):(0,L.jsx)(j,{variant:`body2`,color:`text.secondary`,children:`No libraries found.`})]})}function G({data:e}){let t=Object.keys(e),n=t.length,r=t.filter(t=>e[t].converged).length,i=t.reduce((t,n)=>t+e[n].n,0),a=n>0?Math.round(i/n):0;return(0,L.jsxs)(b,{children:[(0,L.jsx)(y,{title:`Convergence Summary`}),(0,L.jsxs)(E,{sx:{display:`flex`,gap:4},children:[(0,L.jsxs)(E,{children:[(0,L.jsx)(j,{variant:`body2`,color:`text.secondary`,children:`Total Heads`}),(0,L.jsx)(j,{variant:`h5`,children:n})]}),(0,L.jsxs)(E,{children:[(0,L.jsx)(j,{variant:`body2`,color:`text.secondary`,children:`Converged`}),(0,L.jsxs)(j,{variant:`h5`,color:r===n?`success.main`:`warning.main`,children:[r,` / `,n]})]}),(0,L.jsxs)(E,{children:[(0,L.jsx)(j,{variant:`body2`,color:`text.secondary`,children:`Average Samples`}),(0,L.jsx)(j,{variant:`h5`,children:a.toLocaleString()})]})]})]})}function K({data:e}){let o=Object.keys(e).sort();return o.length===0?(0,L.jsxs)(b,{children:[(0,L.jsx)(y,{title:`Per-Head Convergence`}),(0,L.jsx)(j,{variant:`body2`,color:`text.secondary`,children:`No convergence data available.`})]}):(0,L.jsxs)(b,{children:[(0,L.jsx)(y,{title:`Per-Head Convergence`}),(0,L.jsx)(B,{component:w,variant:`outlined`,children:(0,L.jsxs)(t,{size:`small`,children:[(0,L.jsx)(r,{children:(0,L.jsxs)(a,{children:[(0,L.jsx)(i,{children:`Head`}),(0,L.jsx)(i,{align:`right`,children:`P5`}),(0,L.jsx)(i,{align:`right`,children:`P95`}),(0,L.jsx)(i,{align:`right`,children:`P5 Δ`}),(0,L.jsx)(i,{align:`right`,children:`P95 Δ`}),(0,L.jsx)(i,{align:`right`,children:`Samples`}),(0,L.jsx)(i,{align:`center`,children:`Status`})]})}),(0,L.jsx)(n,{children:o.map(t=>{let{latest_snapshot:n,p5_delta:r,p95_delta:o,n:s,converged:c}=e[t];return(0,L.jsxs)(a,{children:[(0,L.jsx)(i,{children:(0,L.jsx)(j,{variant:`body2`,sx:{fontFamily:`monospace`,fontSize:`0.85rem`},children:t})}),(0,L.jsx)(i,{align:`right`,children:n.p5.toFixed(4)}),(0,L.jsx)(i,{align:`right`,children:n.p95.toFixed(4)}),(0,L.jsx)(i,{align:`right`,children:r===null?`—`:r.toFixed(4)}),(0,L.jsx)(i,{align:`right`,children:o===null?`—`:o.toFixed(4)}),(0,L.jsx)(i,{align:`right`,children:s.toLocaleString()}),(0,L.jsx)(i,{align:`center`,children:c?(0,L.jsx)(V,{color:`success`,fontSize:`small`,titleAccess:`Converged`}):(0,L.jsx)(H,{color:`warning`,fontSize:`small`,titleAccess:`Not converged`})})]},t)})})]})})]})}var q=1e3;function J(){let[e,t]=(0,I.useState)({isGenerating:!1,progress:null,result:null,error:null,completed:!1}),n=(0,I.useRef)(null),r=(0,I.useRef)(!0);(0,I.useEffect)(()=>(r.current=!0,()=>{r.current=!1,n.current&&=(clearInterval(n.current),null)}),[]);let i=(0,I.useCallback)(()=>{n.current&&=(clearInterval(n.current),null)},[]),a=(0,I.useCallback)(async()=>{if(r.current)try{let[e,n]=await Promise.all([m(),p()]);if(!r.current)return;t(t=>({...t,progress:n,isGenerating:e.running})),e.running||(i(),e.error?t(t=>({...t,isGenerating:!1,error:e.error,completed:!0})):e.completed&&e.result&&t(t=>({...t,isGenerating:!1,result:e.result,completed:!0})))}catch(e){console.error(`[CalibrationGeneration] Poll error:`,e)}},[i]),o=(0,I.useCallback)(()=>{n.current||=(a(),setInterval(a,q))},[a]),s=(0,I.useCallback)(async()=>{if(!e.isGenerating){t({isGenerating:!0,progress:null,result:null,error:null,completed:!1});try{if((await c()).status===`already_running`){o();return}o()}catch(e){i(),t(t=>({...t,isGenerating:!1,error:e instanceof Error?e.message:`Failed to start calibration`,completed:!0}))}}},[e.isGenerating,o,i]),l=(0,I.useCallback)(()=>{i(),t({isGenerating:!1,progress:null,result:null,error:null,completed:!1})},[i]);return(0,I.useEffect)(()=>{(async()=>{try{(await m()).running&&(t(e=>({...e,isGenerating:!0})),o())}catch(e){console.error(`[CalibrationGeneration] Initial status check failed:`,e)}})()},[]),{state:e,startGeneration:s,reset:l}}function Y(){let{showSuccess:e,showError:t,showInfo:n}=P(),{confirm:r,isOpen:i,options:a,handleConfirm:s,handleCancel:c}=N(),[l,u]=(0,I.useState)(null),[d,f]=(0,I.useState)(!0),[p,m]=(0,I.useState)(null),[h,g]=(0,I.useState)(!1),{state:_,startGeneration:v,reset:y}=J(),b=async()=>{try{f(!0),m(null),u(await o())}catch(e){m(e instanceof Error?e.message:`Failed to load status`),console.error(`[Calibration] Load error:`,e)}finally{f(!1)}};return(0,I.useEffect)(()=>{b()},[]),(0,I.useEffect)(()=>{if(_.completed){if(_.error){t(`Calibration failed: ${_.error}`),y();return}if(_.result){let{heads_processed:t,heads_success:n,heads_failed:r}=_.result,i=`Calibration generated! Processed ${t} heads`;r>0&&(i+=` (${n} success, ${r} failed)`),e(i),y(),b()}}},[_.completed]),{status:l,loading:d,error:p,actionLoading:h,generationState:_,handleGenerate:async()=>{await r({title:`Generate Calibration?`,message:`This analyzes all library files and may take some time. Progress will be shown while running.`,confirmLabel:`Generate`,severity:`warning`})&&await v()},handleApply:async()=>{if(await r({title:`Apply Calibration?`,message:`Apply calibration to entire library? This will queue all files for reprocessing.`,confirmLabel:`Apply`,severity:`warning`}))try{g(!0),e(`Queued ${(await D()).queued} files for recalibration`),await b()}catch(e){t(e instanceof Error?e.message:`Failed to apply calibration`)}finally{g(!1)}},handleUpdateFiles:()=>{n(`Not implemented`)},dialogState:{isOpen:i,options:a,handleConfirm:s,handleCancel:c}}}function X(){let[e,t]=(0,I.useState)(null),[n,r]=(0,I.useState)(!0),[i,a]=(0,I.useState)(null),o=async()=>{try{r(!0),a(null),t(await f())}catch(e){a(e instanceof Error?e.message:`Failed to load convergence status`),console.error(`[Calibration] Convergence load error:`,e)}finally{r(!1)}};return(0,I.useEffect)(()=>{o()},[]),{data:e,loading:n,error:i,reload:o}}function Z(){let{status:t,loading:n,error:r,actionLoading:i,generationState:a,handleGenerate:o,handleApply:s,handleUpdateFiles:c,dialogState:u}=Y(),{data:d,loading:f,error:p}=X(),{isGenerating:m,progress:h}=a;return(0,L.jsxs)(v,{title:`Calibration`,children:[n&&(0,L.jsx)(C,{}),r&&(0,L.jsxs)(k,{severity:`error`,children:[`Error: `,r]}),m&&(0,L.jsxs)(b,{sx:{mb:2.5},children:[(0,L.jsxs)(E,{sx:{display:`flex`,alignItems:`center`,gap:2,mb:2},children:[(0,L.jsx)(C,{size:20}),(0,L.jsx)(j,{variant:`subtitle1`,fontWeight:500,children:`Generating Calibration...`})]}),h&&h.iteration!=null&&h.total_iterations!=null&&(0,L.jsxs)(L.Fragment,{children:[(0,L.jsx)(l,{label:`Iteration ${h.iteration} of ${h.total_iterations} (${h.sample_pct??0}%)`,value:h.iteration,total:h.total_iterations}),h.current_head&&h.current_head_index!=null&&(0,L.jsxs)(j,{variant:`body2`,color:`text.secondary`,sx:{mt:1},children:[`Processing head `,h.current_head_index,`/`,h.total_heads,`: `,h.current_head]})]}),h&&h.iteration==null&&h.total_heads>0&&(0,L.jsx)(l,{label:`Processing heads`,value:h.completed_heads,total:h.total_heads})]}),t&&(0,L.jsxs)(e,{spacing:2.5,children:[(0,L.jsx)(W,{status:t}),f&&(0,L.jsx)(b,{children:(0,L.jsxs)(E,{sx:{display:`flex`,alignItems:`center`,gap:2},children:[(0,L.jsx)(C,{size:20}),(0,L.jsx)(j,{variant:`body2`,children:`Loading convergence data...`})]})}),p&&(0,L.jsxs)(k,{severity:`error`,children:[`Failed to load convergence data: `,p]}),d&&(0,L.jsxs)(L.Fragment,{children:[(0,L.jsx)(G,{data:d}),(0,L.jsx)(K,{data:d})]}),(0,L.jsx)(U,{onGenerate:o,onApply:s,onUpdateFiles:c,actionLoading:i||m})]}),(0,L.jsx)(g,{open:u.isOpen,title:u.options.title,message:u.options.message,confirmLabel:u.options.confirmLabel,cancelLabel:u.options.cancelLabel,severity:u.options.severity,onConfirm:u.handleConfirm,onCancel:u.handleCancel})]})}export{Z as CalibrationPage};