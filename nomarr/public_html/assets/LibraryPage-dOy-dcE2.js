import{a as e,c as t,l as n,n as r,s as i,t as a,u as o}from"./ui-0x0XinP6.js";import{t as s}from"./TextField-RhsmfodV.js";import"./Grow-BleD-8bo.js";import{t as c}from"./Chip-qyxXgHtI.js";import{r as l,t as u}from"./FormControlLabel-6J1MLIhr.js";import{Z as d,a as f,dt as p,n as m,o as h,pt as g,s as _}from"./index-ByHFyLQZ.js";import{t as v}from"./ServerFilePicker-DtV8sjX5.js";var y=g(p(),1),b=g(d(),1);function x(){let[e,r]=(0,y.useState)([]),[i,d]=(0,y.useState)(!0),[p,g]=(0,y.useState)(null),[x,S]=(0,y.useState)(!1),[C,w]=(0,y.useState)(null),[T,E]=(0,y.useState)(null),[D,ee]=(0,y.useState)(null),[O,k]=(0,y.useState)(``),[A,j]=(0,y.useState)(``),[M,N]=(0,y.useState)(!0),[P,F]=(0,y.useState)(!1),[I,L]=(0,y.useState)(!1),[R,z]=(0,y.useState)(null),[B,V]=(0,y.useState)(!1),H=async()=>{try{d(!0),g(null),r(await m.library.list())}catch(e){g(e instanceof Error?e.message:`Failed to load libraries`),console.error(`[LibraryManagement] Load error:`,e)}finally{d(!1)}},U=async()=>{try{ee((await m.config.get()).library_root||null)}catch(e){console.error(`[LibraryManagement] Failed to load config:`,e)}};(0,y.useEffect)(()=>{H(),U()},[]);let W=e=>{if(!D)return!1;let t=D.replace(/\/+$/,``);return!e.replace(/\/+$/,``).startsWith(t)},G=()=>{k(``),j(``),N(!0),F(!1),L(!1),z(null),V(!1),S(!1),w(null)},K=()=>{G(),S(!0)},q=e=>{k(e.name),j(e.rootPath),N(e.isEnabled),F(e.isDefault),w(e.id),S(!1),z(null),V(!1)},J=async()=>{if(!A.trim()){g(`Path is required for preview`);return}if(C===null){g(`Create the library first to preview file count`);return}try{g(null),V(!0),z((await m.library.preview(C,{recursive:!0})).file_count)}catch(e){g(e instanceof Error?e.message:`Failed to preview library`)}finally{V(!1)}},Y=async()=>{if(!O.trim()||!A.trim()){g(`Name and path are required`);return}try{g(null),await m.library.create({name:O,rootPath:A,isEnabled:M,isDefault:P}),await H(),G()}catch(e){g(e instanceof Error?e.message:`Failed to create library`)}},X=async()=>{if(C!==null){if(!O.trim()||!A.trim()){g(`Name and path are required`);return}try{g(null),await m.library.update(C,{name:O,rootPath:A,isEnabled:M,isDefault:P}),await H(),G()}catch(e){g(e instanceof Error?e.message:`Failed to update library`)}}},Z=async e=>{try{g(null),await m.library.setDefault(e),await H()}catch(e){g(e instanceof Error?e.message:`Failed to set default library`)}},Q=async e=>{try{g(null),E(e);let t=await m.library.preview(e,{recursive:!0});if(!confirm(`Found ${t.file_count.toLocaleString()} audio files. Start scan?`)){E(null);return}let n=await m.library.scan(e,{recursive:!0,force:!1,cleanMissing:!0});alert(`Scan ${n.status}: ${n.message||`Library scan queued`}`),await H()}catch(e){g(e instanceof Error?e.message:`Failed to scan library`)}finally{E(null)}},te=async(e,t,n)=>{if(n){g(`Cannot delete the default library. Set another library as default first.`);return}if(confirm(`Delete library "${t}"?\n\nThis will remove the library entry but will NOT delete files on disk.`))try{g(null),await m.library.delete(e),await H()}catch(e){g(e instanceof Error?e.message:`Failed to delete library`)}},$=x||C!==null;return(0,b.jsxs)(o,{spacing:2.5,children:[(0,b.jsxs)(o,{direction:`row`,justifyContent:`space-between`,alignItems:`center`,children:[(0,b.jsx)(_,{variant:`h5`,children:`Libraries`}),!$&&(0,b.jsx)(f,{variant:`contained`,onClick:K,children:`+ Add Library`})]}),p&&(0,b.jsx)(a,{children:p}),$&&(0,b.jsxs)(n,{children:[(0,b.jsx)(t,{title:x?`Create Library`:`Edit Library`}),(0,b.jsxs)(o,{spacing:2,children:[(0,b.jsxs)(h,{children:[(0,b.jsx)(_,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Name`}),(0,b.jsx)(s,{value:O,onChange:e=>k(e.target.value),placeholder:`My Music Library`,fullWidth:!0})]}),(0,b.jsxs)(h,{children:[(0,b.jsx)(_,{variant:`body2`,color:`text.secondary`,sx:{mb:.5},children:`Root Path`}),(0,b.jsxs)(o,{direction:`row`,spacing:1.25,children:[(0,b.jsx)(s,{value:A,onChange:e=>j(e.target.value),placeholder:`/music`,fullWidth:!0}),(0,b.jsx)(f,{variant:`outlined`,onClick:()=>L(!I),sx:{minWidth:120},children:I?`Hide Picker`:`Browse...`})]}),I&&(0,b.jsx)(h,{sx:{mt:1.25,p:2,bgcolor:`background.default`,borderRadius:1,border:1,borderColor:`divider`},children:(0,b.jsx)(v,{value:A,onChange:e=>{j(e),L(!1)},mode:`directory`,label:`Select Library Root Directory`})})]}),(0,b.jsx)(u,{control:(0,b.jsx)(l,{checked:M,onChange:e=>N(e.target.checked)}),label:`Enabled`}),(0,b.jsx)(u,{control:(0,b.jsx)(l,{checked:P,onChange:e=>F(e.target.checked)}),label:`Default Library`}),C!==null&&(0,b.jsxs)(h,{children:[(0,b.jsx)(f,{variant:`outlined`,onClick:J,disabled:!A.trim()||B,children:B?`Checking...`:`Preview File Count`}),R!==null&&(0,b.jsx)(h,{sx:{mt:1,p:1.5,bgcolor:`background.paper`,borderRadius:1,border:1,borderColor:`divider`},children:(0,b.jsxs)(_,{children:[(0,b.jsx)(`strong`,{children:R.toLocaleString()}),` audio files found`]})})]}),(0,b.jsxs)(o,{direction:`row`,spacing:1.25,children:[(0,b.jsx)(f,{variant:`contained`,onClick:x?Y:X,children:x?`Create`:`Update`}),(0,b.jsx)(f,{variant:`outlined`,onClick:G,children:`Cancel`})]})]})]}),i&&(0,b.jsx)(_,{children:`Loading libraries...`}),!i&&!$&&e.length===0&&(0,b.jsx)(n,{children:(0,b.jsx)(_,{color:`text.secondary`,textAlign:`center`,fontStyle:`italic`,children:`No libraries configured. Click "Add Library" to get started.`})}),!i&&!$&&e.length>0&&(0,b.jsx)(o,{spacing:2,children:e.map(e=>(0,b.jsxs)(n,{children:[(0,b.jsxs)(o,{direction:`row`,justifyContent:`space-between`,alignItems:`flex-start`,sx:{mb:2},children:[(0,b.jsxs)(h,{children:[(0,b.jsxs)(o,{direction:`row`,alignItems:`center`,spacing:1.25,sx:{mb:.5},children:[(0,b.jsx)(_,{variant:`h6`,children:e.name}),e.isDefault&&(0,b.jsx)(c,{label:`Default`,color:`primary`,size:`small`}),W(e.rootPath)&&(0,b.jsx)(c,{label:`Outside library_root`,color:`warning`,size:`small`})]}),(0,b.jsx)(_,{variant:`body2`,color:`text.secondary`,sx:{fontFamily:`monospace`},children:e.rootPath}),W(e.rootPath)&&(0,b.jsxs)(_,{variant:`caption`,color:`warning.main`,sx:{mt:.5},children:[`âš  This library is outside the configured library_root (`,D,`)`]})]}),(0,b.jsxs)(o,{direction:`row`,alignItems:`center`,spacing:1,children:[(0,b.jsx)(h,{sx:{width:8,height:8,borderRadius:`50%`,bgcolor:e.isEnabled?`success.main`:`text.disabled`}}),(0,b.jsx)(_,{variant:`body2`,color:`text.secondary`,children:e.isEnabled?`Enabled`:`Disabled`})]})]}),(0,b.jsxs)(o,{direction:`row`,spacing:1.25,flexWrap:`wrap`,children:[(0,b.jsx)(f,{variant:`outlined`,size:`small`,onClick:()=>q(e),disabled:T===e.id,children:`Edit`}),!e.isDefault&&(0,b.jsx)(f,{variant:`outlined`,size:`small`,onClick:()=>Z(e.id),disabled:T===e.id,children:`Set Default`}),(0,b.jsx)(f,{variant:`contained`,color:`success`,size:`small`,onClick:()=>Q(e.id),disabled:!e.isEnabled||T===e.id||W(e.rootPath),title:W(e.rootPath)?`Cannot scan: library is outside library_root`:void 0,children:T===e.id?`Scanning...`:`Scan`}),(0,b.jsx)(f,{variant:`contained`,color:`error`,size:`small`,onClick:()=>te(e.id,e.name,e.isDefault),disabled:T===e.id,children:`Delete`})]})]},e.id))})]})}function S({stats:r}){let a=[{label:`Total Files`,value:r.total_files},{label:`Artists`,value:r.unique_artists},{label:`Albums`,value:r.unique_albums},{label:`Total Duration`,value:(e=>`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m`)(r.total_duration_seconds)}];return(0,b.jsxs)(n,{children:[(0,b.jsx)(t,{title:`Library Statistics`}),(0,b.jsx)(e,{minColumnWidth:200,children:a.map(e=>(0,b.jsx)(i,{label:e.label,value:e.value},e.label))})]})}function C(){let[e,t]=(0,y.useState)(null),[n,r]=(0,y.useState)(!0),[i,a]=(0,y.useState)(null),o=async()=>{try{r(!0),a(null),t(await m.library.getStats())}catch(e){a(e instanceof Error?e.message:`Failed to load stats`),console.error(`[Library] Load error:`,e)}finally{r(!1)}};return(0,y.useEffect)(()=>{o()},[]),{stats:e,loading:n,error:i}}function w(){let{stats:e,loading:t,error:i}=C();return(0,b.jsxs)(r,{title:`Library Management`,children:[t&&(0,b.jsx)(_,{children:`Loading library statistics...`}),i&&(0,b.jsxs)(a,{children:[`Error: `,i]}),e&&(0,b.jsxs)(o,{spacing:2.5,children:[(0,b.jsx)(S,{stats:e}),(0,b.jsx)(n,{children:(0,b.jsx)(x,{})})]})]})}export{w as LibraryPage};