import{t as e}from"./Stack-B4CN3zD5.js";import{a as t,i as n,n as r,r as i,t as a}from"./TableRow-cOUVkhNc.js";import{D as o,Dt as s,Et as c,F as l,_t as u,a as d,d as f,et as p,ft as m,g as h,h as g,j as _,k as v,l as y,mt as b,nt as x,o as S,ot as C,pt as w,r as T,w as E}from"./index-BF2NrADo.js";import{t as D}from"./useConfirmDialog-CtFSKmAm.js";import{t as O}from"./useNotification-DFHAcgcg.js";function k(e){return w(`MuiTableContainer`,e)}m(`MuiTableContainer`,[`root`]);var A=s(c()),j=s(u()),M=e=>{let{classes:t}=e;return C({root:[`root`]},k,t)},N=x(`div`,{name:`MuiTableContainer`,slot:`Root`})({width:`100%`,overflowX:`auto`}),P=A.forwardRef(function(e,t){let n=p({props:e,name:`MuiTableContainer`}),{className:r,component:i=`div`,...a}=n,o={...n,component:i};return(0,j.jsx)(N,{ref:t,as:i,className:b(M(o).root,r),ownerState:o,...a})});async function F(e=!0){return d(`/api/web/calibration/generate`,{save_sidecars:e})}async function I(){return d(`/api/web/calibration/apply`)}async function L(){return T(`/api/web/calibration/status`)}async function R(){return d(`/api/web/calibration/clear`)}function z({onGenerate:t,onApply:n,onClear:r,onUpdateFiles:i,actionLoading:a}){return(0,j.jsxs)(h,{children:[(0,j.jsx)(g,{title:`Actions`}),(0,j.jsx)(e,{spacing:2,children:[{label:`Generate New Calibration`,description:`Analyze all files in library to generate optimal calibration values. This will scan the entire library and may take some time.`,onClick:t,color:`primary`,variant:`contained`},{label:`Apply Calibration to Library`,description:`Queue all files for reprocessing with current calibration. This will update all tags based on the current calibration values.`,onClick:n,color:`primary`,variant:`contained`},{label:`Update Calibration Files`,description:`Download and import the latest calibration bundle files from the repository.`,onClick:i,color:`secondary`,variant:`outlined`},{label:`Clear Calibration Queue`,description:`Remove all pending calibration jobs from the queue. Running jobs will complete.`,onClick:r,color:`error`,variant:`outlined`}].map(e=>(0,j.jsx)(f,{label:e.label,description:e.description,onClick:e.onClick,disabled:a,variant:e.variant,color:e.color},e.label))})]})}function B({status:e}){let s=e.last_run?new Date(e.last_run*1e3).toLocaleString():`Never`;return(0,j.jsxs)(h,{children:[(0,j.jsx)(g,{title:`Calibration Status`}),(0,j.jsxs)(E,{sx:{mb:3},children:[(0,j.jsxs)(o,{variant:`body2`,color:`text.secondary`,children:[(0,j.jsx)(`strong`,{children:`Global Version:`}),` `,e.global_version||`Not calibrated`]}),(0,j.jsxs)(o,{variant:`body2`,color:`text.secondary`,children:[(0,j.jsx)(`strong`,{children:`Last Run:`}),` `,s]})]}),e.libraries.length>0?(0,j.jsx)(P,{component:l,variant:`outlined`,children:(0,j.jsxs)(t,{size:`small`,children:[(0,j.jsx)(r,{children:(0,j.jsxs)(a,{children:[(0,j.jsx)(i,{children:`Library`}),(0,j.jsx)(i,{align:`right`,children:`Total Files`}),(0,j.jsx)(i,{align:`right`,children:`Current`}),(0,j.jsx)(i,{align:`right`,children:`Outdated`}),(0,j.jsx)(i,{align:`right`,children:`Calibration %`})]})}),(0,j.jsx)(n,{children:e.libraries.map(e=>(0,j.jsxs)(a,{children:[(0,j.jsx)(i,{children:e.library_name}),(0,j.jsx)(i,{align:`right`,children:e.total_files.toLocaleString()}),(0,j.jsx)(i,{align:`right`,children:e.current_count.toLocaleString()}),(0,j.jsx)(i,{align:`right`,children:e.outdated_count.toLocaleString()}),(0,j.jsxs)(i,{align:`right`,children:[e.percentage.toFixed(1),`%`]})]},e.library_id))})]})}):(0,j.jsx)(o,{variant:`body2`,color:`text.secondary`,children:`No libraries found.`})]})}function V(){let{showSuccess:e,showError:t,showInfo:n}=O(),{confirm:r,isOpen:i,options:a,handleConfirm:o,handleCancel:s}=D(),[c,l]=(0,A.useState)(null),[u,d]=(0,A.useState)(!0),[f,p]=(0,A.useState)(null),[m,h]=(0,A.useState)(!1),g=async()=>{try{d(!0),p(null),l(await L())}catch(e){p(e instanceof Error?e.message:`Failed to load status`),console.error(`[Calibration] Load error:`,e)}finally{d(!1)}};return(0,A.useEffect)(()=>{g()},[]),{status:c,loading:u,error:f,actionLoading:m,handleGenerate:async()=>{if(await r({title:`Generate Calibration?`,message:`This analyzes all library files and may take some time.`,confirmLabel:`Generate`,severity:`warning`}))try{h(!0);let t=await F(!0),n=Object.keys(t.data.calibrations||{}).length,r=t.saved_files?.saved_files||0,i=`Calibration generated! Library: ${t.data.library_size} files, `;i+=`Calibrations: ${n}, Skipped: ${t.data.skipped_tags}`,r>0&&(i+=`, Saved ${r} files`),e(i),await g()}catch(e){t(e instanceof Error?e.message:`Failed to generate calibration`)}finally{h(!1)}},handleApply:async()=>{if(await r({title:`Apply Calibration?`,message:`Apply calibration to entire library? This will queue all files for reprocessing.`,confirmLabel:`Apply`,severity:`warning`}))try{h(!0),e(`Queued ${(await I()).queued} files for recalibration`),await g()}catch(e){t(e instanceof Error?e.message:`Failed to apply calibration`)}finally{h(!1)}},handleClear:async()=>{if(await r({title:`Clear Calibration Queue?`,message:`Clear all calibration queue jobs?`,confirmLabel:`Clear`,severity:`warning`}))try{h(!0),e(`Cleared ${(await R()).cleared} jobs`),await g()}catch(e){t(e instanceof Error?e.message:`Failed to clear calibration queue`)}finally{h(!1)}},handleUpdateFiles:()=>{n(`Not implemented`)},dialogState:{isOpen:i,options:a,handleConfirm:o,handleCancel:s}}}function H(){let{status:t,loading:n,error:r,actionLoading:i,handleGenerate:a,handleApply:o,handleClear:s,handleUpdateFiles:c,dialogState:l}=V();return(0,j.jsxs)(y,{title:`Calibration`,children:[n&&(0,j.jsx)(_,{}),r&&(0,j.jsxs)(v,{severity:`error`,children:[`Error: `,r]}),t&&(0,j.jsxs)(e,{spacing:2.5,children:[(0,j.jsx)(B,{status:t}),(0,j.jsx)(z,{onGenerate:a,onApply:o,onClear:s,onUpdateFiles:c,actionLoading:i})]}),(0,j.jsx)(S,{open:l.isOpen,title:l.options.title,message:l.options.message,confirmLabel:l.options.confirmLabel,cancelLabel:l.options.cancelLabel,severity:l.options.severity,onConfirm:l.handleConfirm,onCancel:l.handleCancel})]})}export{H as CalibrationPage};