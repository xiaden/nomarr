import{c as e,t}from"./Stack-C3oFuMt6.js";import{A as n,At as r,C as i,Ct as a,D as o,Dt as s,Et as c,Ft as l,M as u,N as d,Nt as f,O as p,P as m,Q as h,S as g,T as _,Z as v,_ as y,_t as b,a as x,c as S,ct as C,d as w,et as T,f as E,g as D,gt as O,h as k,ht as A,i as j,it as ee,jt as te,k as M,kt as ne,l as N,mt as re,n as ie,nt as ae,o as oe,p as P,r as se,s as ce,t as le,tt as ue,u as de,v as fe,w as F,y as pe,yt as me}from"./ChartsWrapper-BbwsoCaR.js";import{i as he,o as ge,r as _e,t as ve}from"./Select-CArIr3vA.js";import{t as ye}from"./ExpandMore-CIeMtkNG.js";import{n as be,r as xe,t as Se}from"./AccordionSummary-D689Edze.js";import"./Popper-BEK2VOi3.js";import{a as Ce,i as we,n as Te,r as I,t as Ee}from"./TableRow-C7mpJIn6.js";import{t as De}from"./TableContainer-B1C9iZpq.js";import{B as Oe,Dn as L,En as R,Et as ke,G as Ae,Gn as je,H as Me,K as Ne,Kt as z,Mn as Pe,Nn as B,Nt as Fe,R as Ie,U as Le,Un as Re,V as ze,W as Be,Xt as Ve,_n as He,ct as Ue,et as We,fn as Ge,gn as V,it as Ke,kt as H,ln as U,lt as W,ot as qe,rt as Je,wt as G,xt as K,z as Ye}from"./index-C5fbkBFX.js";import{t as Xe}from"./useConfirmDialog-Cfh4-REp.js";import{t as Ze}from"./useNotification-TXK_guY7.js";import{a as Qe,i as $e,n as et,r as tt,t as nt}from"./ChartsGrid-wTZp1aiC.js";var q=je(Pe(),1);function rt({onGenerate:e,onApply:n,onUpdateFiles:r,onClear:i,actionLoading:a}){return(0,q.jsxs)(W,{children:[(0,q.jsx)(Ue,{title:`Actions`}),(0,q.jsx)(t,{spacing:2,children:[{label:`Generate New Calibration`,description:`Analyze all files in library to generate optimal calibration values. This will scan the entire library and may take some time.`,onClick:e,color:`primary`,variant:`contained`},{label:`Apply Calibration to Library`,description:`Queue all files for reprocessing with current calibration. This will update all tags based on the current calibration values.`,onClick:n,color:`primary`,variant:`contained`},{label:`Update Calibration Files`,description:`Download and import the latest calibration bundle files from the repository.`,onClick:r,color:`secondary`,variant:`outlined`},{label:`Clear Calibration Data`,description:`Remove all calibration states, history, and reset file calibration hashes. You will need to regenerate calibration afterward.`,onClick:i,color:`error`,variant:`outlined`}].map(e=>(0,q.jsx)(Ke,{label:e.label,description:e.description,onClick:e.onClick,disabled:a,variant:e.variant,color:e.color},e.label))})]})}function it({status:e}){let t=e.last_run?new Date(e.last_run*1e3).toLocaleString():`Never`;return(0,q.jsxs)(W,{children:[(0,q.jsx)(Ue,{title:`Calibration Status`}),(0,q.jsxs)(K,{sx:{mb:3},children:[(0,q.jsxs)(G,{variant:`body2`,color:`text.secondary`,children:[(0,q.jsx)(`strong`,{children:`Global Version:`}),` `,e.global_version||`Not calibrated`]}),(0,q.jsxs)(G,{variant:`body2`,color:`text.secondary`,children:[(0,q.jsx)(`strong`,{children:`Last Run:`}),` `,t]})]}),e.libraries.length>0?(0,q.jsx)(De,{component:Fe,variant:`outlined`,children:(0,q.jsxs)(Ce,{size:`small`,children:[(0,q.jsx)(Te,{children:(0,q.jsxs)(Ee,{children:[(0,q.jsx)(I,{children:`Library`}),(0,q.jsx)(I,{align:`right`,children:`Total Files`}),(0,q.jsx)(I,{align:`right`,children:`Current`}),(0,q.jsx)(I,{align:`right`,children:`Outdated`}),(0,q.jsx)(I,{align:`right`,children:`Calibration %`})]})}),(0,q.jsx)(we,{children:e.libraries.map(e=>(0,q.jsxs)(Ee,{children:[(0,q.jsx)(I,{children:e.library_name}),(0,q.jsx)(I,{align:`right`,children:e.total_files.toLocaleString()}),(0,q.jsx)(I,{align:`right`,children:e.current_count.toLocaleString()}),(0,q.jsx)(I,{align:`right`,children:e.outdated_count.toLocaleString()}),(0,q.jsxs)(I,{align:`right`,children:[e.percentage.toFixed(1),`%`]})]},e.library_id))})]})}):(0,q.jsx)(G,{variant:`body2`,color:`text.secondary`,children:`No libraries found.`})]})}function at(e){return L(`MuiBarElement`,e)}const ot=R(`MuiBarElement`,[`root`,`highlighted`,`faded`,`series`]),st=e=>{let{classes:t,id:n,isHighlighted:r,isFaded:i}=e;return V({root:[`root`,`series-${n}`,r&&`highlighted`,i&&`faded`]},at,t)};function ct(){return g(`bar`)}function lt(e,t){let n=a(e.x,t.x),r=a(e.y,t.y),i=a(e.width,t.width),o=a(e.height,t.height);return e=>({x:n(e),y:r(e),width:i(e),height:o(e)})}function ut(e){let t={x:e.layout===`vertical`?e.x:e.xOrigin,y:e.layout===`vertical`?e.yOrigin:e.y,width:e.layout===`vertical`?e.width:0,height:e.layout===`vertical`?0:e.height};return w({x:e.x,y:e.y,width:e.width,height:e.height},{createInterpolator:lt,applyProps(e,t){e.setAttribute(`x`,t.x.toString()),e.setAttribute(`y`,t.y.toString()),e.setAttribute(`width`,t.width.toString()),e.setAttribute(`height`,t.height.toString())},transformProps:e=>e,initialProps:t,skip:e.skipAnimation,ref:e.ref})}function dt(e,t){let n=a(e.x,t.x),r=a(e.y,t.y),i=a(e.width,t.width),o=a(e.height,t.height);return e=>({x:n(e),y:r(e),width:i(e),height:o(e)})}function ft(e){let{initialX:t,currentX:n,initialY:r,currentY:i}=e.placement===`outside`?mt(e):pt(e),a={x:t,y:r,width:e.width,height:e.height};return w({x:n,y:i,width:e.width,height:e.height},{createInterpolator:dt,transformProps:e=>e,applyProps(e,t){e.setAttribute(`x`,t.x.toString()),e.setAttribute(`y`,t.y.toString()),e.setAttribute(`width`,t.width.toString()),e.setAttribute(`height`,t.height.toString())},initialProps:a,skip:e.skipAnimation,ref:e.ref})}var J=4;function pt(e){return{initialX:e.layout===`vertical`?e.x+e.width/2:e.xOrigin,initialY:e.layout===`vertical`?e.yOrigin:e.y+e.height/2,currentX:e.x+e.width/2,currentY:e.y+e.height/2}}function mt(e){let t=0,n=0,r=0,i=0;return e.layout===`vertical`?(e.y<e.yOrigin?(t=e.yOrigin-J,n=e.y-J):(t=e.yOrigin+J,n=e.y+e.height+J),{initialX:e.x+e.width/2,currentX:e.x+e.width/2,initialY:t,currentY:n}):(e.x<e.xOrigin?(r=e.xOrigin,i=e.x-J):(r=e.xOrigin,i=e.x+e.width+J),{initialX:r,currentX:i,initialY:e.y+e.height/2,currentY:e.y+e.height/2})}function ht(e){return L(`MuiBarLabel`,e)}const gt=R(`MuiBarLabel`,[`root`,`highlighted`,`faded`,`animate`]),_t=e=>{let{classes:t,seriesId:n,isFaded:r,isHighlighted:i,skipAnimation:a}=e;return V({root:[`root`,`series-${n}`,i&&`highlighted`,r&&`faded`,!a&&`animate`]},ht,t)};function vt(e){let{barLabel:t,value:n,dataIndex:r,seriesId:i,height:a,width:o}=e;return t===`value`?n?n?.toString():null:t({seriesId:i,dataIndex:r,value:n},{bar:{height:a,width:o}})}var Y=je(Re()),yt=[`seriesId`,`dataIndex`,`color`,`isFaded`,`isHighlighted`,`classes`,`skipAnimation`,`layout`,`xOrigin`,`yOrigin`,`placement`,`hidden`];const bt=U(`text`,{name:`MuiBarLabel`,slot:`Root`,overridesResolver:(e,t)=>[{[`&.${gt.faded}`]:t.faded},{[`&.${gt.highlighted}`]:t.highlighted},t.root]})(({theme:e})=>B({},e?.typography?.body2,{stroke:`none`,fill:(e.vars||e)?.palette?.text?.primary,transitionProperty:`opacity, fill`,transitionDuration:`300ms`,transitionTimingFunction:P,pointerEvents:`none`}));function xt(e){let t=l({props:e,name:`MuiBarLabel`}),{isFaded:n,hidden:r}=t,i=z(t,yt),a=ft(t);return(0,q.jsx)(bt,B({textAnchor:St(t),dominantBaseline:Ct(t),opacity:r?0:n?.3:1},i,a))}function St({placement:e,layout:t,xOrigin:n,x:r}){return e===`outside`&&t===`horizontal`?r<n?`end`:`start`:`middle`}function Ct({placement:e,layout:t,yOrigin:n,y:r}){return e===`outside`?t===`horizontal`?`central`:r<n?`auto`:`hanging`:`central`}var wt=[`seriesId`,`classes`,`color`,`dataIndex`,`barLabel`,`slots`,`slotProps`,`xOrigin`,`yOrigin`,`x`,`y`,`width`,`height`,`value`,`skipAnimation`,`layout`,`barLabelPlacement`,`hidden`],Tt=[`ownerState`];function Et(t){let{seriesId:n,classes:r,color:i,dataIndex:a,barLabel:o,slots:s,slotProps:c,xOrigin:l,yOrigin:u,x:d,y:f,width:p,height:m,value:h,skipAnimation:g,layout:_,barLabelPlacement:v,hidden:y}=t,b=z(t,wt),{isFaded:x,isHighlighted:S}=k({seriesId:n,dataIndex:a}),C={seriesId:n,classes:r,color:i,isFaded:x,isHighlighted:S,dataIndex:a,skipAnimation:g,layout:_},w=_t(C),T=s?.barLabel??xt,E=e({elementType:T,externalSlotProps:c?.barLabel,additionalProps:B({},b,{xOrigin:l,yOrigin:u,x:d,y:f,width:p,height:m,placement:v,className:w.root}),ownerState:C}),{ownerState:D}=E,O=z(E,Tt);if(!o)return null;let A=vt({barLabel:o,value:h,dataIndex:a,seriesId:n,height:m,width:p});return A?(0,q.jsx)(T,B({},O,D,{hidden:y,children:A})):null}var Dt=[`processedSeries`,`className`,`skipAnimation`];function Ot(e){let{processedSeries:t,className:n,skipAnimation:r}=e,i=z(e,Dt),{seriesId:a,data:o,layout:s,xOrigin:c,yOrigin:l}=t,u=t.barLabel??e.barLabel;return u?(0,q.jsx)(`g`,{className:n,"data-series":a,children:o.map(({x:e,y:n,dataIndex:o,color:d,value:f,width:p,height:m,hidden:h})=>(0,q.jsx)(Et,B({seriesId:a,dataIndex:o,value:f,color:d,xOrigin:c,yOrigin:l,x:e,y:n,width:p,height:m,skipAnimation:r??!1,layout:s??`vertical`,hidden:h},i,{barLabel:u,barLabelPlacement:t.barLabelPlacement||`center`}),o))},a):null}var kt=(e,t)=>{let n=`${e}-axis`,r=`${e}Axis`;return t===(e===`x`?`DEFAULT_X_AXIS_KEY`:`DEFAULT_Y_AXIS_KEY`)?`The first \`${r}\``:`The ${n} with id "${t}"`};function At(e,t,n,r,i,a,o){let s=i[r],c=o[a],l=e?s:c,u=e?c:s,d=e?r:a,f=e?a:r,p=e?`x`:`y`,m=e?`y`:`x`;if(l.scaleType!==`band`)throw Error(`MUI X Charts: ${kt(p,d)} should be of type "band" to display the bar series of id "${t}".`);if(l.data===void 0)throw Error(`MUI X Charts: ${kt(p,d)} should have data property.`);if(u.scaleType===`band`||u.scaleType===`point`)throw Error(`MUI X Charts: ${kt(m,f)} should be a continuous type to display the bar series of id "${t}".`)}function jt(e,t,n){let r=ct()??{series:{},stackingGroups:[],seriesOrder:[]},i=F().xAxisIds[0],a=_().yAxisIds[0];return Mt(e,o(),r.stackingGroups,r.series,t,n,i,a)}function Mt(e,t,n,r,i,a,o,s){let c={};return{completedData:n.flatMap(({ids:l},d)=>{let f=e.left,p=e.left+e.width,h=e.top,g=e.top+e.height,_=new Map,v=new Map;return l.map(e=>{let l=r[e].xAxisId??o,y=r[e].yAxisId??s,b=r[e].layout,x=i[l],S=a[y],C=r[e].layout===`vertical`,w=(C?S.reverse:x.reverse)??!1;At(C,e,r[e].stackedData.length,l,i,y,a);let T=C?x:S,E=x.scale,D=S.scale,O=Math.round(E(0)??0),k=Math.round(D(0)??0),A=m(r[e],i[l],a[y]),j=[];for(let i=0;i<T.data.length;i+=1){let a=u({verticalLayout:C,xAxisConfig:x,yAxisConfig:S,series:r[e],dataIndex:i,numberOfGroups:n.length,groupIndex:d});if(a==null)continue;let o=r[e].stack,s=B({seriesId:e,dataIndex:i,hidden:r[e].hidden},a,{color:A(i),value:r[e].data[i],maskId:`${t}_${o||e}_${d}_${i}`});if(s.x>p||s.x+s.width<f||s.y>g||s.y+s.height<h)continue;let l=_.get(i),m=v.get(i),y=(w?-1:1)*Math.sign(s.value??0);y>0?(m&&delete m.borderRadiusSide,s.borderRadiusSide=C?`top`:`right`,v.set(i,s)):y<0&&(l&&delete l.borderRadiusSide,s.borderRadiusSide=C?`bottom`:`left`,_.set(i,s)),c[s.maskId]||(c[s.maskId]={id:s.maskId,width:0,height:0,hasNegative:!1,hasPositive:!1,layout:b,xOrigin:O,yOrigin:k,x:0,y:0});let T=c[s.maskId];T.width=b===`vertical`?s.width:T.width+s.width,T.height=b===`vertical`?T.height+s.height:s.height,T.x=Math.min(T.x===0?1/0:T.x,s.x),T.y=Math.min(T.y===0?1/0:T.y,s.y);let E=s.value??0;T.hasNegative=T.hasNegative||(w?E>0:E<0),T.hasPositive=T.hasPositive||(w?E<0:E>0),j.push(s)}return{seriesId:e,barLabel:r[e].barLabel,barLabelPlacement:r[e].barLabelPlacement,data:j,layout:b,xOrigin:O,yOrigin:k}})}),masksData:Object.values(c)}}function Nt(e){return L(`MuiBar`,e)}R(`MuiBar`,[`root`,`series`,`seriesLabels`]);const Pt=e=>V({root:[`root`],series:[`series`],seriesLabels:[`seriesLabels`]},Nt,e);var Ft=[`ownerState`,`skipAnimation`,`id`,`dataIndex`,`xOrigin`,`yOrigin`];function It(e){let{ownerState:t}=e,n=z(e,Ft),r=ut(e);return(0,q.jsx)(`rect`,B({},n,{filter:t.isHighlighted?`brightness(120%)`:void 0,opacity:t.isFaded?.3:1,"data-highlighted":t.isHighlighted||void 0,"data-faded":t.isFaded||void 0},r))}function Lt(e){return M().use(ee,e)}var Rt=[`id`,`dataIndex`,`classes`,`color`,`slots`,`slotProps`,`style`,`onClick`,`skipAnimation`,`layout`,`x`,`xOrigin`,`y`,`yOrigin`,`width`,`height`,`hidden`];function zt(t){let{id:n,dataIndex:r,classes:i,color:a,slots:o,slotProps:s,style:c,onClick:l,skipAnimation:u,layout:d,x:f,xOrigin:p,y:m,yOrigin:h,width:g,height:_,hidden:v}=t,y=z(t,Rt),b=Y.useMemo(()=>({type:`bar`,seriesId:n,dataIndex:r}),[n,r]),x=S(b),{isFaded:C,isHighlighted:w}=k(b),T={id:n,dataIndex:r,classes:i,color:a,isFaded:C,isHighlighted:w,isFocused:Lt(Y.useMemo(()=>({type:`bar`,seriesId:n,dataIndex:r}),[n,r]))},E=st(T),D=o?.bar??It;return(0,q.jsx)(D,B({},e({elementType:D,externalSlotProps:s?.bar,externalForwardedProps:y,additionalProps:B({},x,{id:n,dataIndex:r,color:a,x:f,xOrigin:p,y:m,yOrigin:h,width:g,height:_,style:c,onClick:l,cursor:l?`pointer`:`unset`,stroke:`none`,fill:a,skipAnimation:u,layout:d,hidden:v}),className:E.root,ownerState:T})))}function Bt(e,t){let n=a(e.x,t.x),r=a(e.y,t.y),i=a(e.width,t.width),o=a(e.height,t.height),s=a(e.borderRadius,t.borderRadius);return e=>({x:n(e),y:r(e),width:i(e),height:o(e),borderRadius:s(e)})}function Vt(e){let t={x:e.layout===`vertical`?e.x:e.xOrigin,y:e.layout===`vertical`?e.yOrigin:e.y,width:e.layout===`vertical`?e.width:0,height:e.layout===`vertical`?0:e.height,borderRadius:e.borderRadius};return w({x:e.x,y:e.y,width:e.width,height:e.height,borderRadius:e.borderRadius},{createInterpolator:Bt,transformProps:t=>({d:Ut(e.hasNegative,e.hasPositive,e.layout,t.x,t.y,t.width,t.height,e.xOrigin,e.yOrigin,t.borderRadius)}),applyProps(e,{d:t}){t&&e.setAttribute(`d`,t)},initialProps:t,skip:e.skipAnimation,ref:e.ref})}function Ht(e){let{maskId:t,x:n,y:r,width:i,height:a,skipAnimation:o}=e,{ref:s,d:c}=Vt({layout:e.layout??`vertical`,hasNegative:e.hasNegative,hasPositive:e.hasPositive,xOrigin:e.xOrigin,yOrigin:e.yOrigin,x:n,y:r,width:i,height:a,borderRadius:e.borderRadius??0,skipAnimation:o});return!e.borderRadius||e.borderRadius<=0?null:(0,q.jsx)(`clipPath`,{id:t,children:(0,q.jsx)(`path`,{ref:s,d:c})})}function Ut(e,t,n,r,i,a,o,s,c,l){if(n===`vertical`){if(t&&e){let e=Math.min(l,a/2,o/2);return`M${r},${i+o/2} v${-(o/2-e)} a${e},${e} 0 0 1 ${e},${-e} h${a-e*2} a${e},${e} 0 0 1 ${e},${e} v${o-2*e} a${e},${e} 0 0 1 ${-e},${e} h${-(a-e*2)} a${e},${e} 0 0 1 ${-e},${-e} v${-(o/2-e)}`}let n=Math.min(l,a/2);if(t)return`M${r},${Math.max(c,i+n)} v${Math.min(0,-(c-i-n))} a${n},${n} 0 0 1 ${n},${-n} h${a-n*2} a${n},${n} 0 0 1 ${n},${n} v${Math.max(0,c-i-n)} Z`;if(e)return`M${r},${Math.min(c,i+o-n)} v${Math.max(0,o-n)} a${n},${n} 0 0 0 ${n},${n} h${a-n*2} a${n},${n} 0 0 0 ${n},${-n} v${-Math.max(0,o-n)} Z`}if(n===`horizontal`){if(t&&e){let e=Math.min(l,a/2,o/2);return`M${r+a/2},${i} h${a/2-e} a${e},${e} 0 0 1 ${e},${e} v${o-e*2} a${e},${e} 0 0 1 ${-e},${e} h${-(a-2*e)} a${e},${e} 0 0 1 ${-e},${-e} v${-(o-e*2)} a${e},${e} 0 0 1 ${e},${-e} h${a/2-e}`}let n=Math.min(l,o/2);if(t)return`M${Math.min(s,r-n)},${i} h${a} a${n},${n} 0 0 1 ${n},${n} v${o-n*2} a${n},${n} 0 0 1 ${-n},${n} h${-a} Z`;if(e)return`M${Math.max(s,r+a+n)},${i} h${-a} a${n},${n} 0 0 0 ${-n},${n} v${o-n*2} a${n},${n} 0 0 0 ${n},${n} h${a} Z`}}var Wt=[`completedData`,`masksData`,`borderRadius`,`onItemClick`,`skipAnimation`];function Gt(e){let{completedData:t,masksData:n,borderRadius:r,onItemClick:i,skipAnimation:a}=e,o=z(e,Wt),s=Pt(),c=!r||r<=0;return(0,q.jsxs)(Y.Fragment,{children:[!c&&n.map(({id:e,x:t,y:n,xOrigin:i,yOrigin:o,width:s,height:c,hasPositive:l,hasNegative:u,layout:d})=>(0,q.jsx)(Ht,{maskId:e,borderRadius:r,hasNegative:u,hasPositive:l,layout:d,x:t,y:n,xOrigin:i,yOrigin:o,width:s,height:c,skipAnimation:a??!1},e)),t.map(({seriesId:e,layout:t,xOrigin:n,yOrigin:r,data:l})=>(0,q.jsx)(`g`,{"data-series":e,className:s.series,children:l.map(({dataIndex:s,color:l,maskId:u,x:d,y:f,width:p,height:m})=>{let h=(0,q.jsx)(zt,B({id:e,dataIndex:s,color:l,skipAnimation:a??!1,layout:t??`vertical`,x:d,xOrigin:n,y:f,yOrigin:r,width:p,height:m},o,{onClick:i&&(t=>{i(t,{type:`bar`,seriesId:e,dataIndex:s})})}),s);return c?h:(0,q.jsx)(`g`,{clipPath:`url(#${u})`,children:h},s)})},e))]})}function Kt(e,t){return e.bandwidth()===0?Math.floor((t-Math.min(...e.range())+e.step()/2)/e.step()):Math.floor((t-Math.min(...e.range()))/e.step())}const qt=f(O,b,c,function({axis:e,axisIds:t},{axis:n,axisIds:r},i,a){let{series:o,stackingGroups:s=[]}=i?.bar??{},c=t[0],l=r[0],u;for(let t=0;t<s.length;t+=1){let r=s[t].ids;for(let i of r){let r=(o??{})[i],f=r.xAxisId??c,p=r.yAxisId??l,m=e[f],h=n[p],g=r.layout===`horizontal`?h:m,_=r.layout===`horizontal`?m:h,v=g.scale,y=r.layout===`horizontal`?a.y:a.x;if(!me(v))continue;let b=Kt(v,y),{barWidth:x,offset:S}=d(v.bandwidth(),s.length,g.barGapRatio),C=t*(x+S),w=g.data?.[b];if(w==null)continue;let T=v(w);if(T==null)continue;let E=T+C,D=E+x;if(y>=Math.min(E,D)&&y<=Math.max(E,D)){let e=r.layout===`horizontal`?a.x:a.y,t=r.visibleStackedData[b],n=_.scale(t[0]),o=_.scale(t[1]);if(n==null||o==null)continue;e>=Math.min(n,o)&&e<=Math.max(n,o)&&(u={seriesId:i,dataIndex:b})}}}if(u)return{type:`bar`,seriesId:u.seriesId,dataIndex:u.dataIndex}});function Jt(e){let{instance:t}=n(),r=i(),a=M();Y.useEffect(()=>{let n=r.current;if(!n||!e)return;let i=null,o=function(r){let o=r;i&&Math.abs(r.clientX-i.clientX)<=1&&Math.abs(r.clientY-i.clientY)<=1&&(o={clientX:i.clientX,clientY:i.clientY}),i=null;let s=A(n,o);if(!t.isPointInside(s.x,s.y))return;let c=qt(a.state,s);c&&e(r,{type:`bar`,seriesId:c.seriesId,dataIndex:c.dataIndex})},s=function(e){i=e};return n.addEventListener(`click`,o),n.addEventListener(`pointerup`,s),()=>{n.removeEventListener(`click`,o),n.removeEventListener(`pointerup`,s)}},[t,e,a,r])}function Yt(e,t,n){let r=e.get(t);return r?r.push(n):(r=[n],e.set(t,r)),r}var Xt=1e3;function Zt(e,t,n,r,i,a,o,s){let c=Math.min(i,n/2,r/2),l=Math.min(a,n/2,r/2),u=Math.min(o,n/2,r/2),d=Math.min(s,n/2,r/2);return`M${e+c},${t}
   h${n-c-l}
   a${l},${l} 0 0 1 ${l},${l}
   v${r-l-u}
   a${u},${u} 0 0 1 -${u},${u}
   h-${n-u-d}
   a${d},${d} 0 0 1 -${d},-${d}
   v-${r-d-c}
   a${c},${c} 0 0 1 ${c},-${c}
   Z`}function X(e,t){return Zt(e.x,e.y,e.width,e.height,e.borderRadiusSide===`left`||e.borderRadiusSide===`top`?t:0,e.borderRadiusSide===`right`||e.borderRadiusSide===`top`?t:0,e.borderRadiusSide===`right`||e.borderRadiusSide===`bottom`?t:0,e.borderRadiusSide===`left`||e.borderRadiusSide===`bottom`?t:0)}function Qt(e,t){let n=new Map,r=new Map;for(let i=0;i<e.data.length;i+=1){let a=e.data[i],o=X(a,t),s=Yt(r,a.color,o);s.length>=Xt&&(Yt(n,a.color,s.join(``)),r.delete(a.color))}for(let[e,t]of r.entries())t.length>0&&Yt(n,e,t.join(``));return n}var $t=[`skipAnimation`,`layout`,`xOrigin`,`yOrigin`],en=[`children`,`layout`,`xOrigin`,`yOrigin`],tn=U(`g`)({'&[data-faded="true"]':{opacity:.3},"& path":{pointerEvents:`none`}});function nn(e){let{skipAnimation:t,layout:n,xOrigin:r,yOrigin:i}=e,a=z(e,$t);return t?(0,q.jsx)(tn,B({},a)):(0,q.jsx)(rn,B({},a,{layout:n,xOrigin:r,yOrigin:i}))}var Z=U(`rect`)({"@keyframes scaleInX":{from:{transform:`scaleX(0)`},to:{transform:`scaleX(1)`}},"@keyframes scaleInY":{from:{transform:`scaleY(0)`},to:{transform:`scaleY(1)`}},animationDuration:`300ms`,animationFillMode:`forwards`,'&[data-orientation="horizontal"]':{animationName:`scaleInX`},'&[data-orientation="vertical"]':{animationName:`scaleInY`}});function rn(e){let{children:t,layout:n,xOrigin:r,yOrigin:i}=e,a=z(e,en),o=M().use(ne),s=He(),c=[];return n===`horizontal`?(c.push((0,q.jsx)(Z,{"data-orientation":`horizontal`,x:o.left,width:r-o.left,y:o.top,height:o.height,style:{transformOrigin:`${r}px ${o.top+o.height/2}px`}},`left`)),c.push((0,q.jsx)(Z,{"data-orientation":`horizontal`,x:r,width:o.left+o.width-r,y:o.top,height:o.height,style:{transformOrigin:`${r}px ${o.top+o.height/2}px`}},`right`))):(c.push((0,q.jsx)(Z,{"data-orientation":`vertical`,x:o.left,width:o.width,y:o.top,height:i-o.top,style:{transformOrigin:`${o.left+o.width/2}px ${i}px`}},`top`)),c.push((0,q.jsx)(Z,{"data-orientation":`vertical`,x:o.left,width:o.width,y:i,height:o.top+o.height-i,style:{transformOrigin:`${o.left+o.width/2}px ${i}px`}},`bottom`))),(0,q.jsxs)(Y.Fragment,{children:[(0,q.jsx)(`clipPath`,{id:s,children:c}),(0,q.jsx)(tn,B({clipPath:`url(#${s})`},a,{children:t}))]})}function an(e,t,r){let{instance:a}=n(),o=i(),s=M(),c=Y.useRef(!1),l=Y.useRef(void 0),u=Ve(()=>t?.()),d=Ve(()=>r?.());Y.useEffect(()=>{let t=o.current;if(!t)return;function n(){c.current=!0}function r(){let e=l.current;e&&(l.current=void 0,a.removeTooltipItem(e),a.clearHighlight(),d())}function i(){c.current=!1,r()}let f=function(n){let i=A(t,n);if(!a.isPointInside(i.x,i.y)){r();return}let o=e(s.state,i);o?(a.setLastUpdateSource(`pointer`),a.setTooltipItem(o),a.setHighlight(o),u(),l.current=o):r()};return t.addEventListener(`pointerleave`,i),t.addEventListener(`pointermove`,f),t.addEventListener(`pointerenter`,n),()=>{t.removeEventListener(`pointerenter`,n),t.removeEventListener(`pointermove`,f),t.removeEventListener(`pointerleave`,i),c.current&&i()}},[e,a,u,d,s,o])}function on({completedData:e,borderRadius:t=0,onItemClick:n,skipAnimation:r=!1}){let a=Y.useRef(null),o=i();return an(qt,n?()=>{let e=o.current;e&&(a.current??(a.current=e.style.cursor,e.style.cursor=`pointer`))}:void 0,n?()=>{let e=o.current;e&&a.current!=null&&(e.style.cursor=a.current,a.current=null)}:void 0),Jt(n),(0,q.jsx)(Y.Fragment,{children:e.map(e=>(0,q.jsx)(cn,{series:e,borderRadius:t,skipAnimation:r},e.seriesId))})}var sn=Y.memo(un);function cn({series:e,borderRadius:t,skipAnimation:r}){let i=Pt(),{store:a}=n(),o=a.use(y,e.seriesId),s=a.use(D,e.seriesId);return(0,q.jsxs)(Y.Fragment,{children:[(0,q.jsx)(nn,{className:i.series,"data-series":e.seriesId,layout:e.layout,xOrigin:e.xOrigin,yOrigin:e.yOrigin,skipAnimation:r,"data-faded":s||void 0,"data-highlighted":o||void 0,children:(0,q.jsx)(ln,{processedSeries:e,borderRadius:t})}),(0,q.jsx)(sn,{processedSeries:e,borderRadius:t})]})}function ln({processedSeries:e,borderRadius:t}){let n=Qt(e,t),r=[],i=0;for(let[e,t]of n.entries())for(let n of t)r.push((0,q.jsx)(`path`,{fill:e,d:n},i)),i+=1;return(0,q.jsx)(Y.Fragment,{children:r})}function un({processedSeries:e,borderRadius:t}){let{store:r}=n(),i=r.use(fe,e.seriesId),a=r.use(pe,e.seriesId),o=i==null?null:e.data.find(e=>e.dataIndex===i)||null,s=a==null?null:e.data.find(e=>e.dataIndex===a)||null,c=[];return o!=null&&c.push((0,q.jsx)(`path`,{fill:o.color,filter:`brightness(120%)`,"data-highlighted":!0,d:X(o,t)},`highlighted-${e.seriesId}`)),s!=null&&c.push((0,q.jsx)(`path`,{fill:s.color,d:X(s,t)},`unfaded-${s.seriesId}`)),(0,q.jsx)(Y.Fragment,{children:c})}var dn=[`skipAnimation`,`onItemClick`,`borderRadius`,`barLabel`,`renderer`],fn=U(`g`,{name:`MuiBarPlot`,slot:`Root`})({[`& .${ot.root}`]:{transitionProperty:`opacity, fill`,transitionDuration:`300ms`,transitionTimingFunction:P}});function pn(e){let{skipAnimation:t,onItemClick:n,borderRadius:r,barLabel:i,renderer:a}=e,o=z(e,dn),s=N(Qe()||t),c=N(t),{xAxis:l}=F(),{yAxis:u}=_(),{completedData:d,masksData:f}=jt(p(),l,u),m=Pt(),h=a===`svg-batch`?on:Gt;return(0,q.jsxs)(fn,{className:m.root,children:[(0,q.jsx)(h,B({completedData:d,masksData:f,skipAnimation:a===`svg-batch`?c:s,onItemClick:n,borderRadius:r},o)),d.map(e=>(0,q.jsx)(Ot,B({className:m.seriesLabels,processedSeries:e,skipAnimation:s,barLabel:i},o),e.seriesId))]})}const mn=[h,ae,ue,re,C,v,s,T];var hn=`xAxis.yAxis.series.width.height.margin.colors.dataset.sx.axisHighlight.grid.children.slots.slotProps.skipAnimation.loading.layout.onItemClick.highlightedItem.onHighlightChange.borderRadius.barLabel.className.hideLegend.showToolbar.brushConfig.renderer`.split(`.`);const gn=e=>{let{xAxis:t,yAxis:n,series:i,width:a,height:o,margin:s,colors:c,dataset:l,sx:u,axisHighlight:d,grid:f,children:p,slots:m,slotProps:h,skipAnimation:g,loading:_,layout:v,onItemClick:y,highlightedItem:b,onHighlightChange:x,borderRadius:S,barLabel:C,className:w,brushConfig:T,renderer:E}=e,D=z(e,hn),O=`${He()}-clip-path`,k=v===`horizontal`||v===void 0&&i.some(e=>e.layout===`horizontal`),A=Y.useMemo(()=>[{id:r,scaleType:`band`,data:Array.from({length:Math.max(...i.map(e=>(e.data??l??[]).length))},(e,t)=>t)}],[l,i]),j=Y.useMemo(()=>[{id:te,scaleType:`band`,data:Array.from({length:Math.max(...i.map(e=>(e.data??l??[]).length))},(e,t)=>t)}],[l,i]),ee=Y.useMemo(()=>i.map(e=>B({type:`bar`},e,{layout:k?`horizontal`:`vertical`})),[k,i]),M=k?void 0:A,ne=Y.useMemo(()=>t?k?t:t.map(e=>B({scaleType:`band`},e)):M,[M,k,t]),N=k?j:void 0,re=B({},D,{series:ee,width:a,height:o,margin:s,colors:c,dataset:l,xAxis:ne,yAxis:Y.useMemo(()=>n?k?n.map(e=>B({scaleType:`band`},e)):n:N,[N,k,n]),highlightedItem:b,onHighlightChange:x,disableAxisListener:h?.tooltip?.trigger!==`axis`&&d?.x===`none`&&d?.y===`none`,className:w,skipAnimation:g,brushConfig:T,plugins:mn}),ie={onItemClick:y,slots:m,slotProps:h,borderRadius:S,renderer:E,barLabel:C},ae={vertical:f?.vertical,horizontal:f?.horizontal},oe={clipPath:`url(#${O})`},P={id:O},se={slots:m,slotProps:h,loading:_},ce={slots:m,slotProps:h},le=B({},k?{y:`band`}:{x:`band`},d),ue={slots:m,slotProps:h};return{chartsWrapperProps:{sx:u,legendPosition:e.slotProps?.legend?.position,legendDirection:e.slotProps?.legend?.direction,hideLegend:e.hideLegend??!1},chartContainerProps:re,barPlotProps:ie,gridProps:ae,clipPathProps:P,clipPathGroupProps:oe,overlayProps:se,chartsAxisProps:ce,axisHighlightProps:le,legendProps:ue,children:p}};function _n(e){let t=Ge(),n=de(),r=ct(),{xAxis:i,xAxisIds:a}=F(),{yAxis:o,yAxisIds:s}=_();if(n===null||n.type!==`bar`||!r)return null;let c=r.series[n.seriesId];if(c.data[n.dataIndex]==null)return null;let l=c.xAxisId??a[0],d=c.yAxisId??s[0],f=i[l],p=o[d],m=r.series[n.seriesId].layout===`vertical`,h=r.stackingGroups.findIndex(e=>e.ids.includes(n.seriesId)),g=u({verticalLayout:m,xAxisConfig:f,yAxisConfig:p,series:c,dataIndex:n.dataIndex,numberOfGroups:r.stackingGroups.length,groupIndex:h});if(g===null)return null;let{x:v,y,height:b,width:x}=g;return(0,q.jsx)(`rect`,B({fill:`none`,stroke:(t.vars??t).palette.text.primary,strokeWidth:2,x:v-3,y:y-3,width:x+6,height:b+6,rx:3,ry:3},e))}var vn=Y.forwardRef(function(e,t){let n=l({props:e,name:`MuiBarChart`}),{chartsWrapperProps:r,chartContainerProps:i,barPlotProps:a,gridProps:o,clipPathProps:s,clipPathGroupProps:c,overlayProps:u,chartsAxisProps:d,axisHighlightProps:f,legendProps:p,children:m}=gn(n),{chartDataProviderProps:h,chartsSurfaceProps:g}=ie(i,t),_=n.slots?.tooltip??ce,v=n.slots?.toolbar;return(0,q.jsx)(j,B({},h,{children:(0,q.jsxs)(le,B({},r,{children:[n.showToolbar&&v?(0,q.jsx)(v,B({},n.slotProps?.toolbar)):null,!n.hideLegend&&(0,q.jsx)(oe,B({},p)),(0,q.jsxs)(se,B({},g,{children:[(0,q.jsx)(nt,B({},o)),(0,q.jsxs)(`g`,B({},c,{children:[(0,q.jsx)(pn,B({},a)),(0,q.jsx)(x,B({},u)),(0,q.jsx)(tt,B({},f)),(0,q.jsx)(_n,{})]})),(0,q.jsx)($e,B({},d)),(0,q.jsx)(et,B({},s)),m]})),!n.loading&&(0,q.jsx)(_,B({},n.slotProps?.tooltip))]}))}))});function yn(){try{return localStorage.getItem(`nomarr_debug`)===`true`}catch{return!1}}function bn(e,t,n){yn()&&(n===void 0?console.debug(`[nomarr:${e}]`,t):console.debug(`[nomarr:${e}]`,t,n))}function xn(e){let t=e.indexOf(`:`);return t>=0?e.slice(t+1):e}function Q(e){return Math.abs(e)>=100?e.toFixed(0):Math.abs(e)>=10?e.toFixed(1):e.toFixed(2)}function $(e,t=25){let n=[];switch(e){case`healthy`:for(let e=0;e<t;e++){let r=e/t*100,i=Math.abs(r-50),a=Math.max(0,Math.floor(100*Math.exp(-((i/20)**2))));a>0&&n.push({val:r,count:a})}break;case`focused`:for(let e=0;e<t;e++){let r=e/t*100,i=Math.abs(r-50),a=0;i<15?a=Math.floor(80*Math.exp(-((i/8)**2))):i<35&&(a=Math.floor(20*Math.exp(-(((i-15)/10)**2)))),a>0&&n.push({val:r,count:a})}break;case`extreme`:for(let e=0;e<t;e++){let r=e/t*100,i=Math.abs(r-50),a=i<5?Math.floor(100-i*5):0;a>0&&n.push({val:r,count:a})}break;case`skewed`:for(let e=0;e<t;e++){let r=e/t*100,i=Math.floor(80*Math.exp(-r/30));i>0&&n.push({val:r,count:i})}break;case`sparse`:for(let e=0;e<t;e++){let r=e/t*100,i=0;(r<15||r>40&&r<50||r>85)&&(i=Math.floor(Math.random()*40+10)),i>0&&n.push({val:r,count:i})}break}return n}var Sn=[{label:`✅ Healthy Spread`,severity:`success`,description:`Your library has good variety across this quality. Values are spread across the range with reasonable peaks. The P5/P95 boundaries capture the full spectrum of your music, and calibration should work well for filtering and recommendations.`,bins:$(`healthy`),p5:25,p95:75},{label:`ℹ️ Genre-Focused (Normal)`,severity:`info`,description:`Your music clusters in one region - this is completely normal for focused libraries! Classical collections cluster high on 'acoustic', electronic/EDM clusters low. Metal libraries cluster high on 'aggressive' and 'energy'. As long as you have 5,000+ songs in the cluster, calibration will still work fine for your collection.`,bins:$(`focused`),p5:38,p95:62},{label:`⚠️ Extreme Clustering (Concerning)`,severity:`warning`,description:`Almost all your values (90%+) are in a tiny range with very little variation. If this is unexpected for the head you're viewing, it might indicate a tagging issue or data problem. For heads like 'mood' or 'genre', you'd normally expect more spread even in focused libraries.`,bins:$(`extreme`),p5:48,p95:52},{label:`ℹ️ Natural Skew (Normal)`,severity:`info`,description:`Your library leans heavily toward one end but has a smooth distribution. This is expected for some qualities - ambient/classical libraries naturally skew low on 'danceability', acoustic libraries skew high on 'acoustic', etc. Nothing to worry about as long as you have 1,000+ songs.`,bins:$(`skewed`),p5:5,p95:40},{label:`⚠️ Insufficient Data`,severity:`warning`,description:`Your library has large gaps or very few samples (under 1,000 songs) combined with extreme clustering. Calibration might not be representative. Consider: (1) scanning more music, (2) adding more variety, or (3) understanding that tags may be less accurate for music very different from your library.`,bins:$(`sparse`),p5:8,p95:88}];function Cn(e){let t=Array.isArray(e?.histogram_bins)?e.histogram_bins:[];if(t.length===0)return{xLabels:[],counts:[],binValues:[],p5Index:null,p95Index:null};let n=[...t].sort((e,t)=>e.val-t.val),r=n.map(e=>Q(e.val)),i=n.map(e=>e.count),a=n.map(e=>e.val),o=null,s=null,c=1/0,l=1/0;return a.forEach((t,n)=>{let r=Math.abs(t-e.p5),i=Math.abs(t-e.p95);r<c&&(c=r,o=n),i<l&&(l=i,s=n)}),{xLabels:r,counts:i,binValues:a,p5Index:o,p95Index:s}}function wn({label:e,value:t,color:n}){return(0,q.jsxs)(K,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[(0,q.jsx)(K,{sx:{width:16,height:3,bgcolor:n,borderRadius:1}}),(0,q.jsxs)(G,{variant:`body2`,color:`text.secondary`,children:[e,`: `,(0,q.jsx)(`strong`,{children:Q(t)})]})]})}function Tn({example:e}){let t=e.bins.map(e=>Q(e.val)),n=e.bins.map(e=>e.count);return(0,q.jsxs)(K,{sx:{border:2,borderColor:e.severity===`success`?`success.main`:e.severity===`warning`?`warning.main`:`info.main`,borderRadius:1,p:2,backgroundColor:`background.paper`},children:[(0,q.jsx)(G,{variant:`subtitle2`,fontWeight:600,sx:{mb:1},children:e.label}),(0,q.jsx)(K,{sx:{height:180,mb:2,overflow:`hidden`},children:(0,q.jsx)(vn,{height:180,xAxis:[{scaleType:`band`,data:t,tickLabelStyle:{fontSize:8},tickLabelInterval:(e,n)=>n%Math.ceil(t.length/10)===0}],series:[{data:n,color:e.severity===`success`?`#90ee90`:e.severity===`warning`?`#ffcc80`:`#90caf9`}],hideLegend:!0,margin:{left:40,right:10,top:10,bottom:30}})}),(0,q.jsxs)(K,{sx:{display:`flex`,gap:2,mb:1.5},children:[(0,q.jsxs)(G,{variant:`caption`,color:`text.secondary`,children:[`P5: `,(0,q.jsx)(`strong`,{children:Q(e.p5)})]}),(0,q.jsxs)(G,{variant:`caption`,color:`text.secondary`,children:[`P95: `,(0,q.jsx)(`strong`,{children:Q(e.p95)})]})]}),(0,q.jsx)(G,{variant:`body2`,color:`text.secondary`,children:e.description})]})}function En({data:e,loading:t,error:n}){let r=`HistogramCharts`,i=(0,Y.useMemo)(()=>e?e.map(e=>({key:`${e.model_key}:${e.head_name}:${e.label}`,label:`${xn(e.head_name)} - ${e.label}`,fullLabel:`${e.model_key}:${e.head_name}:${e.label}`})):[],[e]),[a,o]=(0,Y.useState)(``),s=a||i[0]?.key||``,c=(0,Y.useMemo)(()=>!e||!s?null:e.find(e=>`${e.model_key}:${e.head_name}:${e.label}`===s)??null,[e,s]),l=(0,Y.useMemo)(()=>c?Cn(c):null,[c]);return(0,Y.useEffect)(()=>{bn(r,`mount/update`,{loading:t,error:n,headCount:e?.length??0,selectedHead:s})},[t,n,e,s]),(0,Y.useEffect)(()=>{l&&bn(r,`processed histogram`,{head:s,binCount:l.counts.length,totalSamples:l.counts.reduce((e,t)=>e+t,0),p5Index:l.p5Index,p95Index:l.p95Index,xLabelRange:l.xLabels.length>0?`${l.xLabels[0]} .. ${l.xLabels[l.xLabels.length-1]}`:`(empty)`})},[l,s]),t?(0,q.jsxs)(K,{sx:{display:`flex`,alignItems:`center`,gap:2,py:2},children:[(0,q.jsx)(H,{size:20}),(0,q.jsx)(G,{variant:`body2`,children:`Loading histogram data...`})]}):n?(0,q.jsx)(G,{color:`error`,variant:`body2`,children:n}):!e||e.length===0?(0,q.jsx)(G,{variant:`body2`,color:`text.secondary`,children:`No histogram data available. Run calibration to see distribution.`}):(0,q.jsxs)(K,{children:[(0,q.jsxs)(xe,{defaultExpanded:!0,children:[(0,q.jsx)(Se,{expandIcon:(0,q.jsx)(ye,{}),children:(0,q.jsx)(G,{variant:`subtitle1`,fontWeight:500,children:`Embedding Distribution`})}),(0,q.jsxs)(be,{children:[(0,q.jsx)(K,{sx:{mb:2},children:(0,q.jsxs)(ge,{size:`small`,sx:{minWidth:200},children:[(0,q.jsx)(he,{id:`head-select-label`,children:`Label`}),(0,q.jsx)(ve,{labelId:`head-select-label`,value:s,label:`Label`,onChange:e=>o(e.target.value),children:i.map(e=>(0,q.jsx)(_e,{value:e.key,children:e.label},e.key))})]})}),(0,q.jsx)(G,{variant:`caption`,color:`text.secondary`,sx:{mb:1,display:`block`},children:`Distribution of embedding values across your library. P5/P95 markers show calibration percentiles.`}),c&&(0,q.jsxs)(K,{sx:{mb:2},children:[(0,q.jsxs)(G,{variant:`body2`,fontWeight:500,color:`text.primary`,sx:{mb:1},children:[xn(c.head_name),` - `,c.label]}),(0,q.jsxs)(K,{sx:{display:`flex`,gap:3},children:[(0,q.jsx)(wn,{label:`P5`,value:c.p5,color:`#2196f3`}),(0,q.jsx)(wn,{label:`P95`,value:c.p95,color:`#f44336`}),(0,q.jsxs)(G,{variant:`body2`,color:`text.secondary`,children:[`Samples: `,(0,q.jsx)(`strong`,{children:c.n.toLocaleString()})]})]})]}),l&&l.counts.length>0?(0,q.jsx)(K,{sx:{overflow:`hidden`},children:(0,q.jsx)(vn,{height:350,xAxis:[{scaleType:`band`,data:l.xLabels,label:`Embedding Value`,tickLabelStyle:{fontSize:9},tickLabelInterval:(e,t)=>t%Math.ceil(l.xLabels.length/20)===0}],series:[{data:l.counts,label:`Count`,color:`#90caf9`}],hideLegend:!0,margin:{left:60,right:20,top:20,bottom:60}})}):(0,q.jsx)(K,{sx:{height:350,display:`flex`,alignItems:`center`,justifyContent:`center`},children:(0,q.jsx)(G,{color:`text.secondary`,children:`No histogram data for selected head`})})]})]}),(0,q.jsxs)(xe,{children:[(0,q.jsx)(Se,{expandIcon:(0,q.jsx)(ye,{}),children:(0,q.jsx)(G,{variant:`subtitle1`,fontWeight:500,children:`Understanding Your Results`})}),(0,q.jsxs)(be,{children:[(0,q.jsx)(G,{variant:`body2`,color:`text.secondary`,sx:{mb:3},children:`Common patterns and what they mean for your library. Compare your histogram above to these examples:`}),(0,q.jsx)(K,{sx:{display:`grid`,gridTemplateColumns:{xs:`1fr`,sm:`repeat(2, 1fr)`,md:`repeat(3, 1fr)`},gap:2},children:Sn.map(e=>(0,q.jsx)(Tn,{example:e},e.label))})]})]})]})}function Dn(){let[e,t]=(0,Y.useState)(null),[n,r]=(0,Y.useState)(!0),[i,a]=(0,Y.useState)(null),o=async()=>{try{r(!0),a(null),t((await Ye()).calibrations??null)}catch(e){a(e instanceof Error?e.message:`Failed to load histogram data`),console.error(`[Calibration] Histogram load error:`,e)}finally{r(!1)}};return(0,Y.useEffect)(()=>{o()},[]),{data:e,loading:n,error:i,reload:o}}var On=1e3;function kn(){let[e,t]=(0,Y.useState)({isApplying:!1,progress:null,result:null,error:null,completed:!1}),n=(0,Y.useRef)(null),r=(0,Y.useRef)(!0);(0,Y.useEffect)(()=>(r.current=!0,()=>{r.current=!1,n.current&&=(clearInterval(n.current),null)}),[]);let i=(0,Y.useCallback)(()=>{n.current&&=(clearInterval(n.current),null)},[]),a=(0,Y.useCallback)(async()=>{if(r.current)try{let[e,n]=await Promise.all([ze(),Oe()]);if(!r.current)return;t(t=>({...t,progress:n,isApplying:e.status===`running`})),e.status!==`running`&&(i(),e.status===`failed`?t(t=>({...t,isApplying:!1,error:e.error,completed:!0})):e.status===`completed`&&e.result&&t(t=>({...t,isApplying:!1,result:e.result,completed:!0})))}catch(e){console.error(`[CalibrationApply] Poll error:`,e)}},[i]),o=(0,Y.useCallback)(()=>{n.current||=(a(),setInterval(a,On))},[a]),s=(0,Y.useCallback)(async()=>{if(!e.isApplying){t({isApplying:!0,progress:null,result:null,error:null,completed:!1});try{if((await Ae()).status===`already_running`){o();return}o()}catch(e){i(),t(t=>({...t,isApplying:!1,error:e instanceof Error?e.message:`Failed to start calibration apply`,completed:!0}))}}},[e.isApplying,o,i]),c=(0,Y.useCallback)(()=>{i(),t({isApplying:!1,progress:null,result:null,error:null,completed:!1})},[i]);return(0,Y.useEffect)(()=>{(async()=>{try{(await ze()).status===`running`&&(t(e=>({...e,isApplying:!0})),o())}catch(e){console.error(`[CalibrationApply] Initial status check failed:`,e)}})()},[]),{state:e,startApply:s,reset:c}}var An=1e3;function jn(){let[e,t]=(0,Y.useState)({isGenerating:!1,progress:null,result:null,error:null,completed:!1}),n=(0,Y.useRef)(null),r=(0,Y.useRef)(!0);(0,Y.useEffect)(()=>(r.current=!0,()=>{r.current=!1,n.current&&=(clearInterval(n.current),null)}),[]);let i=(0,Y.useCallback)(()=>{n.current&&=(clearInterval(n.current),null)},[]),a=(0,Y.useCallback)(async()=>{if(r.current)try{let[e,n]=await Promise.all([Le(),Me()]);if(!r.current)return;t(t=>({...t,progress:n,isGenerating:e.running})),e.running||(i(),e.error?t(t=>({...t,isGenerating:!1,error:e.error,completed:!0})):e.completed&&e.result&&t(t=>({...t,isGenerating:!1,result:e.result,completed:!0})))}catch(e){console.error(`[CalibrationGeneration] Poll error:`,e)}},[i]),o=(0,Y.useCallback)(()=>{n.current||=(a(),setInterval(a,An))},[a]),s=(0,Y.useCallback)(async()=>{if(!e.isGenerating){t({isGenerating:!0,progress:null,result:null,error:null,completed:!1});try{if((await Ne()).status===`already_running`){o();return}o()}catch(e){i(),t(t=>({...t,isGenerating:!1,error:e instanceof Error?e.message:`Failed to start calibration`,completed:!0}))}}},[e.isGenerating,o,i]),c=(0,Y.useCallback)(()=>{i(),t({isGenerating:!1,progress:null,result:null,error:null,completed:!1})},[i]);return(0,Y.useEffect)(()=>{(async()=>{try{(await Le()).running&&(t(e=>({...e,isGenerating:!0})),o())}catch(e){console.error(`[CalibrationGeneration] Initial status check failed:`,e)}})()},[]),{state:e,startGeneration:s,reset:c}}function Mn(){let{showSuccess:e,showError:t,showInfo:n}=Ze(),{confirm:r,isOpen:i,options:a,handleConfirm:o,handleCancel:s}=Xe(),[c,l]=(0,Y.useState)(null),[u,d]=(0,Y.useState)(!0),[f,p]=(0,Y.useState)(null),{state:m,startGeneration:h,reset:g}=jn(),{state:_,startApply:v,reset:y}=kn(),b=async()=>{try{d(!0),p(null),l(await Be())}catch(e){p(e instanceof Error?e.message:`Failed to load status`),console.error(`[Calibration] Load error:`,e)}finally{d(!1)}};return(0,Y.useEffect)(()=>{b()},[]),(0,Y.useEffect)(()=>{if(m.completed){if(m.error){t(`Calibration failed: ${m.error}`),g();return}if(m.result){let{heads_processed:t,heads_success:n,heads_failed:r}=m.result,i=`Calibration generated! Processed ${t} heads`;r>0&&(i+=` (${n} success, ${r} failed)`),e(i),g(),b()}}},[m.completed]),(0,Y.useEffect)(()=>{if(_.completed){if(_.error){t(`Calibration apply failed: ${_.error}`),y();return}if(_.result){let{processed:t,failed:n,total:r}=_.result,i=`Applied calibration to ${t}/${r} files`;n>0&&(i+=` (${n} failed)`),e(i),y(),b()}}},[_.completed]),{status:c,loading:u,error:f,generationState:m,applyState:_,handleGenerate:async()=>{await r({title:`Generate Calibration?`,message:`This analyzes all library files and may take some time. Progress will be shown while running.`,confirmLabel:`Generate`,severity:`warning`})&&await h()},handleApply:async()=>{await r({title:`Apply Calibration?`,message:`Apply calibration to entire library? This will reprocess all files with current calibration values.`,confirmLabel:`Apply`,severity:`warning`})&&await v()},handleUpdateFiles:()=>{n(`Not implemented`)},handleClear:async()=>{if(await r({title:`Clear All Calibration Data?`,message:`This will permanently remove all calibration states, history, and reset file calibration hashes. You will need to regenerate calibration afterward.`,confirmLabel:`Clear`,severity:`error`}))try{e(`Calibration data cleared. ${(await Ie()).files_updated} file hashes reset.`),b()}catch(e){t(e instanceof Error?e.message:`Failed to clear calibration`)}},dialogState:{isOpen:i,options:a,handleConfirm:o,handleCancel:s}}}function Nn(){let{status:e,loading:n,error:r,generationState:i,applyState:a,handleGenerate:o,handleApply:s,handleUpdateFiles:c,handleClear:l,dialogState:u}=Mn(),{data:d,loading:f,error:p}=Dn(),{isGenerating:m,progress:h}=i,{isApplying:g,progress:_}=a;return(0,q.jsxs)(Je,{title:`Calibration`,children:[n&&(0,q.jsx)(H,{}),r&&(0,q.jsxs)(ke,{severity:`error`,children:[`Error: `,r]}),m&&(0,q.jsxs)(W,{sx:{mb:2.5},children:[(0,q.jsxs)(K,{sx:{display:`flex`,alignItems:`center`,gap:2,mb:2},children:[(0,q.jsx)(H,{size:20}),(0,q.jsx)(G,{variant:`subtitle1`,fontWeight:500,children:`Generating Calibration...`})]}),h&&h.total_heads>0&&(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)(qe,{label:`Head ${h.current_head_index??0}/${h.total_heads}`,value:h.current_head_index??h.completed_heads,total:h.total_heads}),h.current_head&&(0,q.jsxs)(G,{variant:`body2`,color:`text.secondary`,sx:{mt:1},children:[`Processing: `,h.current_head]})]})]}),g&&(0,q.jsxs)(W,{sx:{mb:2.5},children:[(0,q.jsxs)(K,{sx:{display:`flex`,alignItems:`center`,gap:2,mb:2},children:[(0,q.jsx)(H,{size:20}),(0,q.jsx)(G,{variant:`subtitle1`,fontWeight:500,children:`Applying Calibration...`})]}),_&&_.total_files>0&&(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)(qe,{label:`${_.completed_files} / ${_.total_files} files`,value:_.completed_files,total:_.total_files}),_.current_file&&(0,q.jsx)(G,{variant:`body2`,color:`text.secondary`,sx:{mt:1,overflow:`hidden`,textOverflow:`ellipsis`,whiteSpace:`nowrap`},children:_.current_file})]})]}),e&&(0,q.jsxs)(t,{spacing:2.5,children:[(0,q.jsx)(it,{status:e}),(0,q.jsx)(En,{data:d,loading:f,error:p}),(0,q.jsx)(rt,{onGenerate:o,onApply:s,onUpdateFiles:c,onClear:l,actionLoading:m||g})]}),(0,q.jsx)(We,{open:u.isOpen,title:u.options.title,message:u.options.message,confirmLabel:u.options.confirmLabel,cancelLabel:u.options.cancelLabel,severity:u.options.severity,onConfirm:u.handleConfirm,onCancel:u.handleCancel})]})}export{Nn as CalibrationPage};