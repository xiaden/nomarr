name: Prune Old Container Images

on:
    workflow_dispatch:
        inputs:
            keep_count:
                description: "Number of untagged images to keep"
                required: false
                default: "5"
                type: string
    schedule:
        # Run weekly on Sundays at 2 AM UTC
        - cron: "0 2 * * 0"

jobs:
    prune:
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: read

        steps:
            - name: Delete old untagged container images
              uses: actions/delete-package-versions@v5
              with:
                  package-name: "nomarr"
                  package-type: "container"
                  min-versions-to-keep: ${{ github.event.inputs.keep_count || 5 }}
                  delete-only-untagged-versions: "true"

            # Base image is rebuilt rarely and must never be pruned
            # Reason: attestation manifests (provenance/SBOM) are stored as untagged images
            # but are referenced by the tagged image. Deleting them breaks builds.
            # nomarr-base is ~2GB, keeping all versions is acceptable.
